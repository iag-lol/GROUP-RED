<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGE - Sistema Avanzado de Gestión de Equipos</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
       <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            500: '#f59e0b',
                            600: '#d97706',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                        },
                        info: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                        },
                        dark: {
                            100: '#1E2A4A',
                            200: '#172554',
                            300: '#131F43',
                            400: '#0F172F',
                            500: '#0B111F',
                            600: '#050A14',
                            700: '#020617',
                            800: '#010412',
                            900: '#000309',
                        }
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        heading: ['Poppins', 'sans-serif']
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        dropdown: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'dark-card': '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.16)',
                        'dark-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2)',
                    },
                    transitionProperty: {
                        'width': 'width',
                        'spacing': 'margin, padding',
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'fade-in-down': {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in-left': {
                            '0%': { opacity: '0', transform: 'translateX(10px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        'slide-in-right': {
                            '0%': { transform: 'translateX(100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        'slide-in-left': {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        },
                        'progress-indeterminate': {
                            '0%': { left: '-40%' },
                            '100%': { left: '100%' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        },
                        bounce: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out',
                        'fade-in-down': 'fade-in-down 0.3s ease-out',
                        'fade-in-up': 'fade-in-up 0.3s ease-out',
                        'fade-in-left': 'fade-in-left 0.3s ease-out',
                        'slide-in-right': 'slide-in-right 0.3s ease-out',
                        'slide-in-left': 'slide-in-left 0.3s ease-out',
                        'progress-indeterminate': 'progress-indeterminate 1.5s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    backdropBlur: {
                        xs: '2px',
                    },
                    screens: {
                        'xs': '480px',
                    }
                }
            }
        }
    </script>

    <!-- Biblioteca de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Iconos (FontAwesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- dayjs para manejo de fechas -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/relativeTime.js"></script>

    <!-- Hammer.js para gestos táctiles -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

    <!-- Estilos personalizados -->
    <style>
        :root {
            --header-height: 70px;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
            --bottom-nav-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark body {
            background-color: #0B111F;
            color: #e2e8f0;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
        }

        .light .sidebar {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            color: white;
        }

        .dark .sidebar {
            background: linear-gradient(135deg, #020617 0%, #0B111F 100%);
            color: #e2e8f0;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 50;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: var(--header-height);
            position: relative;
        }

        .main-content.expanded {
            margin-left: var(--sidebar-collapsed-width);
        }

        .light .header {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark .header {
            background-color: #0F172F;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .header {
            height: var(--header-height);
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 40;
            backdrop-filter: blur(12px);
        }

        .header.expanded {
            left: var(--sidebar-collapsed-width);
        }

        .light .nav-link {
            color: #cbd5e1;
        }

        .dark .nav-link {
            color: #94a3b8;
        }

        .light .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .dark .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 4px 10px;
            position: relative;
            overflow: hidden;
        }

        .light .nav-link.active {
            background-color: #0ea5e9;
            color: white;
        }

        .dark .nav-link.active {
            background-color: #0284c7;
            color: white;
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(to bottom, #38bdf8, #0ea5e9);
        }

        .nav-link i {
            width: 24px;
            font-size: 18px;
            margin-right: 10px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .nav-link .badge {
            display: none;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 12px;
        }

        .sidebar.collapsed .nav-link i {
            margin-right: 0;
            font-size: 20px;
        }

        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .sidebar-footer span {
            display: none;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light .card {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .dark .card {
            background-color: #131F43;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.16);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card {
            border-radius: 12px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .light .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dark .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        .light .stat-card {
            background-color: white;
        }

        .dark .stat-card {
            background-color: #172554;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-card {
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .light .stat-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dark .stat-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        .stat-card .icon {
            border-radius: 12px;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            right: -20px;
            top: -20px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            opacity: 0.1;
            transform: scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
        }

        .stat-card:hover::after {
            transform: scale(1);
        }

        .primary-stat::after {
            background-color: #0ea5e9;
        }

        .success-stat::after {
            background-color: #22c55e;
        }

        .warning-stat::after {
            background-color: #f59e0b;
        }

        .info-stat::after {
            background-color: #6366f1;
        }

        .btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.3s, opacity 0.5s;
        }

        .btn:active::after {
            transform: scale(0, 0);
            opacity: 0.3;
            transition: 0s;
        }

        .light .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .dark .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(3px);
        }

        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        .light .modal-content {
            background-color: white;
        }

        .dark .modal-content {
            background-color: #131F43;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .modal-content {
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-backdrop.show .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .light .status-badge {
            background-color: #f8fafc;
        }

        .dark .status-badge {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }

        .status-badge i {
            margin-right: 4px;
        }

        .status-badge.pending {
            background-color: #fffbeb;
            color: #d97706;
        }

        .status-badge.in-progress {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .status-badge.in-review {
            background-color: #f0f9ff;
            color: #0284c7;
        }

        .status-badge.completed {
            background-color: #f0fdf4;
            color: #16a34a;
        }

        .dark .status-badge.pending {
            background-color: rgba(217, 119, 6, 0.2);
        }

        .dark .status-badge.in-progress {
            background-color: rgba(37, 99, 235, 0.2);
        }

        .dark .status-badge.in-review {
            background-color: rgba(2, 132, 199, 0.2);
        }

        .dark .status-badge.completed {
            background-color: rgba(22, 163, 74, 0.2);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            position: relative;
        }

        .avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            opacity: 0.2;
            background-color: rgba(255, 255, 255, 0.5);
            transform: scale(0);
            transition: transform 0.3s ease;
        }

        .avatar:hover::before {
            transform: scale(1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .light .notification-panel {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dark .notification-panel {
            background-color: #131F43;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .notification-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            border-radius: 12px;
            z-index: 50;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            transform: translateY(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .notification-panel.show {
            display: block;
            transform: translateY(0);
        }

        .dropdown {
            position: relative;
        }

        .light .dropdown-menu {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dark .dropdown-menu {
            background-color: #131F43;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 200px;
            border-radius: 12px;
            z-index: 50;
            display: none;
            transform: translateY(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .dropdown.show .dropdown-menu {
            display: block;
            transform: translateY(0);
        }

        .admin-only {
            display: none;
        }

        /* Calendario */
        .dark .fc-theme-standard .fc-scrollgrid,
        .dark .fc-theme-standard td,
        .dark .fc-theme-standard th {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .dark .fc-theme-standard th {
            background-color: #172554;
        }

        .fc-theme-standard td {
            border: 1px solid #e2e8f0;
        }

        .fc-theme-standard th {
            background-color: #f8fafc;
            padding: 8px 0;
        }

        .fc .fc-button-primary {
            background-color: #0ea5e9;
            border-color: #0ea5e9;
        }

        .fc .fc-button-primary:hover {
            background-color: #0284c7;
            border-color: #0284c7;
        }

        .fc-event {
            cursor: pointer;
            border-radius: 4px;
        }

        /* Loader */
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #1E2A4A;
            border-top-color: #0ea5e9;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Bottom nav para móviles */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--bottom-nav-height);
            z-index: 50;
            background-color: white;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .dark .bottom-nav {
            background-color: #131F43;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .bottom-nav.hidden-nav {
            transform: translateY(100%);
        }

        /* Estilos para móviles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 100;
            }

            .sidebar.mobile-show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-bottom: var(--bottom-nav-height);
            }

            .main-content.expanded {
                margin-left: 0;
            }

            .header {
                left: 0;
            }

            .header.expanded {
                left: 0;
            }

            .mobile-sidebar-toggle {
                display: block !important;
            }

            .notification-panel {
                width: 100%;
                position: fixed;
                top: var(--header-height);
                right: 0;
                max-height: calc(100vh - var(--header-height));
            }

            .bottom-nav {
                display: flex;
            }
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.4s ease forwards;
        }

        .animate-slide-in-up {
            animation: slideInUp 0.4s ease forwards;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 5px;
        }

        /* Estilos para tablas */
        .light .data-table th {
            background-color: #f8fafc;
            color: #475569;
        }

        .dark .data-table th {
            background-color: #172554;
            color: #cbd5e1;
        }

        .light .data-table td,
        .light .data-table th {
            border-bottom: 1px solid #e2e8f0;
        }

        .dark .data-table td,
        .dark .data-table th {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            padding: 12px 15px;
            text-align: left;
        }

        .data-table td {
            padding: 12px 15px;
            font-size: 13px;
        }

        .light .data-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .dark .data-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Estilos para formularios */
        .light input, 
        .light select, 
        .light textarea {
            background-color: #fff;
            border: 1px solid #cbd5e1;
            color: #1e293b;
        }

        .dark input, 
        .dark select, 
        .dark textarea {
            background-color: #172554;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        input, select, textarea {
            display: block;
            width: 100%;
            padding: 10px 14px;
            font-size: 14px;
            line-height: 1.5;
            background-clip: padding-box;
            border-radius: 8px;
            transition: all 0.15s ease-in-out;
        }

        input:focus, select:focus, textarea:focus {
            outline: 0;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
        }

        .light input:focus, 
        .light select:focus, 
        .light textarea:focus {
            border-color: #38bdf8;
        }

        .dark input:focus, 
        .dark select:focus, 
        .dark textarea:focus {
            border-color: #0ea5e9;
        }

        .light label {
            color: #475569;
        }

        .dark label {
            color: #cbd5e1;
        }

        label {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
        }

        /* Estilos para pestañas */
        .light .tabs {
            border-bottom: 1px solid #e2e8f0;
        }

        .dark .tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .light .tab {
            color: #64748b;
        }

        .dark .tab {
            color: #94a3b8;
        }

        .tab {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
            white-space: nowrap;
        }

        .light .tab:hover {
            color: #0ea5e9;
        }

        .dark .tab:hover {
            color: #38bdf8;
        }

        .light .tab.active {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
        }

        .dark .tab.active {
            color: #38bdf8;
            border-bottom-color: #38bdf8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease forwards;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .light .toast {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .dark .toast {
            background-color: #131F43;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
        }

        .toast {
            border-radius: 8px;
            padding: 16px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            max-width: 350px;
            animation: slideInRight 0.4s ease forwards;
        }

        .toast.success {
            border-left: 4px solid #22c55e;
        }

        .toast.info {
            border-left: 4px solid #0ea5e9;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: #22c55e;
        }

        .toast.info .toast-icon {
            color: #0ea5e9;
        }

        .toast.warning .toast-icon {
            color: #f59e0b;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .light .toast-close {
            color: #94a3b8;
        }

        .dark .toast-close {
            color: #cbd5e1;
        }

        /* Timeline de tareas */
        .light .timeline::before {
            background-color: #e2e8f0;
        }

        .dark .timeline::before {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .timeline {
            position: relative;
            margin-left: 20px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2px;
            height: 100%;
        }

        .timeline-item {
            position: relative;
            padding-left: 30px;
            padding-bottom: 20px;
        }

        .light .timeline-item::before {
            background-color: #0ea5e9;
        }

        .dark .timeline-item::before {
            background-color: #38bdf8;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            z-index: 1;
        }

        /* Chatbox */
        .light .chat-container {
            border: 1px solid #e2e8f0;
        }

        .dark .chat-container {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .chat-message.received {
            align-self: flex-start;
        }

        .chat-message.sent {
            align-self: flex-end;
            margin-left: auto;
        }

        .light .chat-bubble.received {
            background-color: #f1f5f9;
        }

        .dark .chat-bubble.received {
            background-color: #1E2A4A;
        }

        .chat-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-message.received .chat-bubble {
            border-bottom-left-radius: 4px;
        }

        .chat-message.sent .chat-bubble {
            background-color: #0ea5e9;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .light .chat-input {
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }

        .dark .chat-input {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            background-color: #172554;
        }

        .chat-input {
            display: flex;
            align-items: center;
            padding: 10px 15px;
        }

        .light .chat-input input {
            border: 1px solid #e2e8f0;
        }

        .dark .chat-input input {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 30px;
            margin-right: 10px;
        }

        .chat-input button {
            background-color: #0ea5e9;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Pulse Animation para notificaciones */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        /* Estilos para tareas vencidas o próximas a vencer */
        .due-soon {
            border-left: 4px solid #f59e0b;
        }

        .overdue {
            border-left: 4px solid #ef4444;
        }

        /* Indicador en línea/fuera de línea */
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #22c55e;
            display: inline-block;
            margin-right: 5px;
        }

        .offline-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #94a3b8;
            display: inline-block;
            margin-right: 5px;
        }

        /* Estilo para notificaciones no leídas */
        .light .unread-notification {
            background-color: #f0f9ff;
        }

        .dark .unread-notification {
            background-color: rgba(14, 165, 233, 0.1);
        }

        .unread-notification {
            position: relative;
        }
        
        .light .unread-notification::after {
            background-color: #0ea5e9;
        }

        .dark .unread-notification::after {
            background-color: #38bdf8;
        }

        .unread-notification::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Progreso circular */
        .progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .progress-circle svg {
            transform: rotate(-90deg);
        }

        .progress-circle circle {
            fill: none;
            stroke-width: 8;
        }

        .light .progress-circle .bg {
            stroke: #e2e8f0;
        }

        .dark .progress-circle .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .progress-circle .progress {
            stroke: #0ea5e9;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .progress-circle .text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Clases para transiciones */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        /* Botones modernos */
        .btn-primary {
            background-color: #0ea5e9;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: #0284c7;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .light .btn-secondary {
            background-color: #f1f5f9;
            color: #334155;
        }

        .dark .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .btn-secondary {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .light .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        .dark .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Mejoras en las cards */
        .task-card {
            position: relative;
            overflow: hidden;
        }
        
        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9, #38bdf8);
        }
        
        .task-card.completed::before {
            background: linear-gradient(90deg, #22c55e, #4ade80);
        }
        
        .task-card.overdue::before {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        /* Mejoras en selectores */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .dark select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }
        
        /* Skeletons para carga */
        .light .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #172554 25%, #1E2A4A 50%, #172554 75%);
        }

        .skeleton {
            animation: skeleton-loading 1.5s infinite;
            background-size: 200% 100%;
            border-radius: 8px;
            height: 16px;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
            width: 100%;
        }
        
        .skeleton-text:last-child {
            width: 80%;
        }
        
        .light .skeleton-card {
            background-color: white;
        }

        .dark .skeleton-card {
            background-color: #131F43;
        }

        .skeleton-card {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .light .skeleton-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .dark .skeleton-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Clases para scroll personalizado */
        .light .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #172554;
        }

        .light .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .light .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            border-radius: 10px;
        }

        /* Switch Toggle para modo oscuro */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #94a3b8;
            transition: .4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #0ea5e9;
        }

        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #0ea5e9;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-slider .sun,
        .toggle-slider .moon {
            position: absolute;
            top: 4px;
            font-size: 14px;
        }

        .toggle-slider .sun {
            left: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            color: white;
        }

        .toggle-slider .moon {
            right: 5px;
            opacity: 1;
            transition: opacity 0.3s;
            color: white;
        }

        input:checked + .toggle-slider .sun {
            opacity: 1;
        }

        input:checked + .toggle-slider .moon {
            opacity: 0;
        }

        /* Botón de acción flotante para móvil */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #0ea5e9;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 40;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fab:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .fab:active {
            transform: translateY(0);
        }

        .fab i {
            font-size: 24px;
        }

        /* Estado de contenido vacío */
        .light .empty-state {
            background-color: #f8fafc;
        }

        .dark .empty-state {
            background-color: #131F43;
        }

        .empty-state {
            padding: 40px 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
        }

        .light .empty-state-icon {
            background-color: #e0f2fe;
            color: #0ea5e9;
        }

        .dark .empty-state-icon {
            background-color: rgba(14, 165, 233, 0.2);
            color: #38bdf8;
        }

        /* Tarjetas responsivas */
        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        /* Glassmorphism para el modo oscuro */
        .dark .glass-card {
            background: rgba(19, 31, 67, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Barra de progreso */
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .dark .progress-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .progress-bar-inner {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Estilos para el modo oscuro */
        .dark .header-highlight-gradient {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(2, 132, 199, 0.05) 100%);
        }

        /* Mobile app swipe actions */
        .swipe-action-container {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
        }

        .swipe-action-item {
            transition: transform 0.3s ease;
        }

        .swipe-action-buttons {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .swipe-action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            color: white;
            font-size: 16px;
        }

        .swipe-edit {
            background-color: #0ea5e9;
        }

        .swipe-delete {
            background-color: #ef4444;
        }

        /* Mini FAB Menu */
        .fab-menu {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 40;
        }

        .fab-menu-items {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .fab-menu.active .fab-menu-items {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .fab-menu-item {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 8px;
            padding: 8px 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }

        .dark .fab-menu-item {
            background-color: #131F43;
            color: #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .fab-menu-item:hover {
            transform: scale(1);
        }

        .fab-menu-item i {
            margin-right: 8px;
        }

        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .light .pagination-item {
            background-color: white;
            color: #334155;
        }

        .dark .pagination-item {
            background-color: #172554;
            color: #e2e8f0;
        }

        .pagination-item:hover {
            transform: translateY(-2px);
        }

        .light .pagination-item:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dark .pagination-item:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .pagination-item.active {
            background-color: #0ea5e9;
            color: white;
        }

        /* Shimmer effect */
        .shimmer {
            position: relative;
            overflow: hidden;
        }

        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.2) 20%,
                rgba(255, 255, 255, 0.5) 60%,
                rgba(255, 255, 255, 0)
            );
            animation: shimmer 2s infinite;
        }

        .dark .shimmer::after {
            background-image: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.1) 20%,
                rgba(255, 255, 255, 0.2) 60%,
                rgba(255, 255, 255, 0)
            );
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* Clases de utilidad */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- PÁGINA DE LOGIN -->
        <div id="login-page"
            class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gray-50">
            <div class="max-w-md w-full space-y-8 animate-fade-in">
                <div class="text-center">
                    <div class="mx-auto h-16 w-16 rounded-full bg-primary-600 flex items-center justify-center">
                        <i class="fas fa-tasks text-3xl text-white"></i>
                    </div>
                    <h2 class="mt-6 text-3xl font-bold text-gray-900 font-heading">SAGE</h2>
                    <p class="mt-2 text-sm text-gray-600">Sistema Avanzado de Gestión de Equipos</p>
                </div>
                <div class="mt-8 bg-white py-8 px-6 shadow-xl rounded-lg">
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="far fa-user text-gray-400"></i>
                                </div>
                                <input id="username" name="username" type="text" required
                                    class="pl-10 focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                    placeholder="Ingresa tu nombre de usuario">
                            </div>
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-lock text-gray-400"></i>
                                </div>
                                <input id="password" name="password" type="password" required
                                    class="pl-10 focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                    placeholder="Ingresa tu contraseña">
                            </div>
                        </div>
                        <div>
                            <button type="submit"
                                class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                    <i class="fas fa-sign-in-alt text-primary-300 group-hover:text-primary-200"></i>
                                </span>
                                Iniciar Sesión
                            </button>
                        </div>
                    </form>
                    <div id="login-error" class="mt-3 text-center text-sm text-red-600"></div>
                </div>
                <div class="text-center mt-4 text-xs text-gray-500">
                    <p>© 2025 SAGE - Todos los derechos reservados</p>
                </div>
            </div>
        </div>

        <!-- APLICACIÓN PRINCIPAL -->
        <div id="main-app" class="hidden">
            <!-- Sidebar / Menú lateral -->
            <div id="sidebar" class="sidebar">
                <div class="flex items-center justify-between p-4 border-b border-gray-700">
                    <div class="flex items-center">
                        <div class="h-10 w-10 rounded-lg bg-primary-500 flex items-center justify-center">
                            <i class="fas fa-tasks text-xl text-white"></i>
                        </div>
                        <span class="ml-3 text-xl font-bold text-white logo-text">SAGE</span>
                    </div>
                    <button id="sidebar-toggle" class="text-white hover:bg-gray-700 p-2 rounded-md">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>

                <div class="py-4">
                    <div class="px-4 mb-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Principal
                    </div>
                    <a href="#" id="nav-dashboard" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" id="nav-tasks" class="nav-link">
                        <i class="fas fa-list-check"></i>
                        <span>Tareas</span>
                    </a>
                    <a href="#" id="nav-calendar" class="nav-link">
                        <i class="far fa-calendar-alt"></i>
                        <span>Calendario</span>
                    </a>
                    <a href="#" id="nav-meetings" class="nav-link">
                        <i class="fas fa-users-rectangle"></i>
                        <span>Reuniones</span>
                    </a>
                    <a href="#" id="nav-inspections" class="nav-link">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Levantamientos</span>
                    </a>
                    <a href="#" id="nav-team" class="nav-link admin-only">
                        <i class="fas fa-users"></i>
                        <span>Gestión de Equipo</span>
                    </a>
                    <a href="#" id="nav-reports" class="nav-link admin-only">
                        <i class="fas fa-chart-line"></i>
                        <span>Informes</span>
                    </a>

                    <div class="px-4 mt-6 mb-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                        Comunicación
                    </div>
                    <a href="#" id="nav-chat" class="nav-link">
                        <i class="fas fa-comments"></i>
                        <span>Chat</span>
                    </a>
                    <a href="#" id="nav-notifications" class="nav-link">
                        <i class="fas fa-bell"></i>
                        <span>Notificaciones</span>
                    </a>
                </div>

                <div class="sidebar-footer">
                    <div id="user-profile" class="flex items-center">
                        <div id="user-avatar" class="avatar"></div>
                        <div class="ml-3">
                            <p id="user-name" class="font-semibold text-white text-sm"></p>
                            <p id="user-role" class="text-xs text-gray-400"></p>
                        </div>
                    </div>
                    <button id="logout-button"
                        class="w-full mt-4 py-2 px-4 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span>Cerrar Sesión</span>
                    </button>
                </div>
            </div>

            <!-- Header -->
            <header class="header">
                <div class="flex justify-between items-center h-full px-6">
                    <div class="flex items-center">
                        <button id="mobile-sidebar-toggle"
                            class="mr-4 p-2 rounded-md text-gray-600 hover:bg-gray-100 mobile-sidebar-toggle hidden">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 id="page-title" class="text-xl font-semibold text-gray-800"></h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="notification-btn" class="p-2 rounded-full hover:bg-gray-100 relative">
                                <i class="far fa-bell text-gray-600"></i>
                                <span id="notification-count" class="notification-badge hidden">0</span>
                            </button>
                            <div id="notification-panel" class="notification-panel p-3">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b">
                                    <h3 class="font-semibold text-gray-800">Notificaciones</h3>
                                    <button id="mark-all-read"
                                        class="text-xs text-primary-600 hover:text-primary-800">Marcar todo como
                                        leído</button>
                                </div>
                                <div id="notifications-list" class="max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button id="user-dropdown-btn"
                                class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                                <div id="header-avatar" class="avatar">JS</div>
                                <span id="header-user-name" class="text-sm font-medium hidden md:block">Juan
                                    Silva</span>
                                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                            </button>
                            <div class="dropdown-menu p-2">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                    <i class="fas fa-user mr-2 text-gray-500"></i> Mi Perfil
                                </a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                    <i class="fas fa-cog mr-2 text-gray-500"></i> Configuración
                                </a>
                                <div class="border-t my-2"></div>
                                <button id="dropdown-logout"
                                    class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded-md">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header><br>

            <!-- Contenido principal -->
            <main class="main-content p-6">
                <!-- Vista del Dashboard -->
                <div id="dashboard-view">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="card p-6 animate-slide-in-up" style="animation-delay: 0.1s;">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-primary-100 text-primary-600">
                                    <i class="fas fa-list-check text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Tareas Pendientes</h3>
                                    <p id="pending-tasks-count" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full h-1 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="tasks-progress-bar" class="h-full bg-primary-500" style="width: 0%"></div>
                                </div>
                                <p id="tasks-progress-text" class="mt-1 text-xs text-gray-500 text-right">0% completado
                                </p>
                            </div>
                        </div>

                        <div class="card p-6 animate-slide-in-up" style="animation-delay: 0.2s;">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-calendar-check text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Tareas Completadas</h3>
                                    <p id="completed-tasks-count" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div id="tasks-completion-chart" class="w-full h-10"></div>
                            </div>
                        </div>

                        <div class="card p-6 animate-slide-in-up" style="animation-delay: 0.3s;">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-users-rectangle text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Próxima Reunión</h3>
                                    <p id="next-meeting" class="text-lg font-bold text-gray-800">Sin reuniones
                                        programadas</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p id="next-meeting-time" class="text-xs text-gray-500"><i
                                        class="far fa-clock mr-1"></i> --:--</p>
                            </div>
                        </div>

                        <div class="card p-6 animate-slide-in-up" style="animation-delay: 0.4s;">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                    <i class="fas fa-clipboard-check text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Levantamientos</h3>
                                    <p id="inspections-count" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p class="text-xs text-gray-500">
                                    <span id="inspections-pending" class="font-medium">0</span> pendientes,
                                    <span id="inspections-completed" class="font-medium">0</span> completados
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card p-6 animate-slide-in-right" style="animation-delay: 0.1s;">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-lg font-semibold text-gray-800">Actividad Reciente</h2>
                                    <a href="#" id="view-all-activities"
                                        class="text-sm text-primary-600 hover:text-primary-800">Ver todo</a>
                                </div>
                                <div id="activities-list" class="space-y-4 max-h-80 overflow-y-auto">
                                    <div class="flex items-start animate-fade-in">
                                        <div class="flex-shrink-0">
                                            <div
                                                class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                                <i class="fas fa-spinner text-gray-500"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-gray-500">Cargando actividades recientes...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card p-6 mt-6 animate-slide-in-right" style="animation-delay: 0.2s;">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-lg font-semibold text-gray-800">Mis Tareas</h2>
                                    <a href="#" id="view-all-tasks"
                                        class="text-sm text-primary-600 hover:text-primary-800">Ver todas</a>
                                </div>
                                <div id="dashboard-tasks-list" class="space-y-4 max-h-80 overflow-y-auto">
                                    <div class="flex justify-center">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-1">
                            <div class="card p-6 animate-slide-in-right" style="animation-delay: 0.3s;">
                                <h2 class="text-lg font-semibold text-gray-800 mb-6">Calendario</h2>
                                <div id="mini-calendar" class="mb-4"></div>
                                <h3 class="font-medium text-gray-700 mt-6 mb-3">Próximos Eventos</h3>
                                <div id="upcoming-events" class="space-y-3 max-h-64 overflow-y-auto">
                                    <div class="flex justify-center">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="card p-6 mt-6 animate-slide-in-right" style="animation-delay: 0.4s;">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4">Equipo</h2>
                                <div id="team-members" class="space-y-4">
                                    <div class="flex justify-center">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Tareas -->
                <div id="tasks-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Gestión de Tareas</h2>
                            <p class="text-sm text-gray-500 mt-1">Administra y realiza seguimiento de tus tareas
                                asignadas</p>
                        </div>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="relative">
                                <input type="text" id="task-search" placeholder="Buscar tarea..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                            <div>
                                <select id="task-filter"
                                    class="py-2 pl-3 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="all">Todas</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="in-progress">En Progreso</option>
                                    <option value="in-review">En Revisión</option>
                                    <option value="completed">Completadas</option>
                                </select>
                            </div>
                            <button id="add-task-btn"
                                class="admin-only bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-plus mr-2"></i>
                                <span>Nueva Tarea</span>
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" data-tab="my-tasks">Mis Tareas</div>
                        <div class="tab" data-tab="created-tasks">Tareas Creadas</div>
                        <div class="tab admin-only" data-tab="all-tasks">Todas las Tareas</div>
                    </div>

                    <div class="tab-content active" id="my-tasks-content">
                        <div id="tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="flex justify-center col-span-full py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="created-tasks-content">
                        <div id="created-tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="flex justify-center col-span-full py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="all-tasks-content">
                        <div id="all-tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="flex justify-center col-span-full py-8">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Detalle de Tarea -->
                <div id="task-detail-view" class="hidden">
                    <button id="back-to-tasks"
                        class="mb-6 flex items-center text-primary-600 hover:text-primary-800 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Volver a Tareas</span>
                    </button>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card p-6">
                                <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6">
                                    <div>
                                        <div class="flex items-center">
                                            <h2 id="task-detail-title" class="text-2xl font-bold text-gray-800"></h2>
                                            <span id="task-detail-status" class="ml-3 status-badge"></span>
                                        </div>
                                        <p id="task-detail-date" class="text-sm text-gray-500 mt-1"></p>
                                    </div>
                                    <div class="mt-4 md:mt-0 flex space-x-2">
                                        <div id="task-detail-actions" class="dropdown">
                                            <button class="p-2 text-gray-600 hover:bg-gray-100 rounded-md">
                                                <i class="fas fa-ellipsis-vertical"></i>
                                            </button>
                                            <div class="dropdown-menu p-2 right-0 mt-1 z-50">
                                                <button id="edit-task-btn"
                                                    class="admin-only w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                                    <i class="fas fa-edit mr-2 text-gray-500"></i> Editar Tarea
                                                </button>
                                                <button id="delete-task-btn"
                                                    class="admin-only w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded-md">
                                                    <i class="fas fa-trash-alt mr-2"></i> Eliminar Tarea
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Descripción</h3>
                                    <p id="task-detail-description" class="text-gray-600 whitespace-pre-line"></p>
                                </div>

                                <div class="mb-6" id="task-detail-link-container">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Enlace</h3>
                                    <a id="task-detail-link" href="#" target="_blank"
                                        class="text-primary-600 hover:text-primary-800 break-all"></a>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Avance</h3>
                                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div id="task-detail-progress" class="h-full bg-primary-500" style="width: 0%">
                                        </div>
                                    </div>
                                    <div class="flex justify-between mt-1">
                                        <span id="task-detail-progress-text" class="text-xs text-gray-500">0%</span>
                                        <div>
                                            <select id="task-status-update"
                                                class="text-xs text-gray-700 border border-gray-300 rounded-md">
                                                <option value="Pendiente">Pendiente</option>
                                                <option value="En Progreso">En Progreso</option>
                                                <option value="En Revisión">En Revisión</option>
                                                <option value="Completada">Completada</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-sm font-medium text-gray-700">Archivos Adjuntos</h3>
                                        <button id="upload-file-btn"
                                            class="text-xs text-primary-600 hover:text-primary-800 flex items-center">
                                            <i class="fas fa-upload mr-1"></i>
                                            <span>Subir Archivo</span>
                                        </button>
                                    </div>
                                    <div id="file-upload-form" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                                        <form id="file-form" class="flex flex-col space-y-3">
                                            <div>
                                                <label for="file-upload"
                                                    class="text-xs font-medium text-gray-700">Seleccionar
                                                    archivo</label>
                                                <input type="file" id="file-upload" class="mt-1 text-sm"
                                                    accept=".xlsx,.xls,.doc,.docx,.pdf,.jpg,.jpeg,.png">
                                            </div>
                                            <div>
                                                <label for="file-description"
                                                    class="text-xs font-medium text-gray-700">Descripción
                                                    (opcional)</label>
                                                <input type="text" id="file-description" class="mt-1 text-sm">
                                            </div>
                                            <div class="flex justify-end space-x-2">
                                                <button type="button" id="cancel-file-upload"
                                                    class="px-3 py-1 text-xs text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                                    Cancelar
                                                </button>
                                                <button type="submit"
                                                    class="px-3 py-1 text-xs text-white bg-primary-600 rounded-md hover:bg-primary-700">
                                                    Subir
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    <div id="task-files" class="border rounded-md divide-y"></div>
                                </div>

                                <div>
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">Comentarios</h3>
                                    <div id="task-comments" class="space-y-4 max-h-96 overflow-y-auto mb-4"></div>
                                    <form id="comment-form" class="flex space-x-2">
                                        <input type="text" id="comment-input" placeholder="Añadir un comentario..."
                                            class="flex-1 focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                        <button type="submit"
                                            class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md flex items-center justify-center transition duration-150 ease-in-out">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-1">
                            <div class="card p-6 mb-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Información</h3>

                                <div class="mb-6">
                                    <p class="text-xs text-gray-500 mb-1">Creador</p>
                                    <div id="task-creator" class="flex items-center">
                                        <div class="avatar w-8 h-8 text-sm">JS</div>
                                        <span class="ml-2 text-sm font-medium"></span>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <p class="text-xs text-gray-500 mb-1">Asignado a</p>
                                    <div id="task-assignees" class="flex flex-wrap"></div>
                                </div>

                                <div class="mb-4">
                                    <p class="text-xs text-gray-500 mb-1">Fechas</p>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <p class="text-xs text-gray-500">Creación</p>
                                            <p id="task-created-date" class="text-sm"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Última actualización</p>
                                            <p id="task-updated-date" class="text-sm"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card p-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Historial de Actividad</h3>
                                <div id="task-activity-timeline" class="timeline"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Calendario -->
                <div id="calendar-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Calendario</h2>
                            <p class="text-sm text-gray-500 mt-1">Visualiza tareas y reuniones programadas</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="task-calendar-view"
                                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-list-check mr-2"></i>
                                <span>Tareas</span>
                            </button>
                            <button id="meeting-calendar-view"
                                class="bg-white hover:bg-gray-100 text-gray-800 border border-gray-300 px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-users-rectangle mr-2"></i>
                                <span>Reuniones</span>
                            </button>
                            <button id="add-event-btn"
                                class="admin-only bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-plus mr-2"></i>
                                <span>Nuevo Evento</span>
                            </button>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div id="main-calendar"></div>
                    </div>
                </div>

                <!-- Vista de Reuniones -->
                <div id="meetings-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Reuniones</h2>
                            <p class="text-sm text-gray-500 mt-1">Programa y gestiona reuniones con tu equipo</p>
                        </div>
                        <div class="flex space-x-2">
                            <div class="relative">
                                <input type="text" id="meeting-search" placeholder="Buscar reunión..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                            <button id="add-meeting-btn"
                                class="admin-only bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-plus mr-2"></i>
                                <span>Nueva Reunión</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-7 gap-6">
                        <div class="lg:col-span-5">
                            <div class="card p-6">
                                <div class="tabs">
                                    <div class="tab active" data-tab="upcoming-meetings">Próximas</div>
                                    <div class="tab" data-tab="past-meetings">Anteriores</div>
                                    <div class="tab admin-only" data-tab="all-meetings">Todas</div>
                                </div>

                                <div class="tab-content active" id="upcoming-meetings-content">
                                    <div id="upcoming-meetings-list" class="space-y-4">
                                        <div class="flex justify-center py-8">
                                            <div class="loader"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-content" id="past-meetings-content">
                                    <div id="past-meetings-list" class="space-y-4">
                                        <div class="flex justify-center py-8">
                                            <div class="loader"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-content" id="all-meetings-content">
                                    <div id="all-meetings-list" class="space-y-4">
                                        <div class="flex justify-center py-8">
                                            <div class="loader"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <div class="card p-6 mb-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Calendario</h3>
                                <div id="meeting-mini-calendar" class="mb-4"></div>
                            </div>

                            <div class="card p-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Próximas Reuniones</h3>
                                <div id="next-meetings-sidebar" class="space-y-3">
                                    <div class="animate-pulse space-y-3">
                                        <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                                        <div class="h-3 bg-gray-200 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Levantamientos -->
                <div id="inspections-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Levantamientos</h2>
                            <p class="text-sm text-gray-500 mt-1">Gestiona los levantamientos técnicos y su seguimiento
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <div class="relative">
                                <input type="text" id="inspection-search" placeholder="Buscar levantamiento..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                            <button id="add-inspection-btn"
                                class="admin-only bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-plus mr-2"></i>
                                <span>Nuevo Levantamiento</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                        <a href="#" data-inspection-type="extintor"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-red-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-fire-extinguisher text-2xl text-red-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Extintor</h3>
                            <p class="text-xs text-gray-500 mt-1">Verificación y estado</p>
                        </a>

                        <a href="#" data-inspection-type="odometro"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-blue-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-gauge-high text-2xl text-blue-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Odómetros</h3>
                            <p class="text-xs text-gray-500 mt-1">Lectura y control</p>
                        </a>

                        <a href="#" data-inspection-type="luminaria"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-yellow-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-lightbulb text-2xl text-yellow-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Luminaria</h3>
                            <p class="text-xs text-gray-500 mt-1">Control de iluminación</p>
                        </a>

                        <a href="#" data-inspection-type="wifi"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-green-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-wifi text-2xl text-green-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">WiFi</h3>
                            <p class="text-xs text-gray-500 mt-1">Conectividad y señal</p>
                        </a>

                        <a href="#" data-inspection-type="publicidad"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-purple-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-rectangle-ad text-2xl text-purple-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Publicidad</h3>
                            <p class="text-xs text-gray-500 mt-1">Estado y ubicación</p>
                        </a>

                        <a href="#" data-inspection-type="normas-graficas"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-indigo-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-ruler-combined text-2xl text-indigo-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Normas Gráficas</h3>
                            <p class="text-xs text-gray-500 mt-1">Cumplimiento de estándares</p>
                        </a>

                        <a href="#" data-inspection-type="limpiaparabrisas"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-teal-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-car-side text-2xl text-teal-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Limpiaparabrisas</h3>
                            <p class="text-xs text-gray-500 mt-1">Estado y funcionamiento</p>
                        </a>

                        <a href="#" data-inspection-type="grabado-vidrios"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-cyan-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-glasses text-2xl text-cyan-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Grabado Vidrios</h3>
                            <p class="text-xs text-gray-500 mt-1">Verificación de marcaje</p>
                        </a>

                        <a href="#" data-inspection-type="control-combustible"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-amber-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-gas-pump text-2xl text-amber-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Control Combustible</h3>
                            <p class="text-xs text-gray-500 mt-1">Consumo y rendimiento</p>
                        </a>

                        <a href="#" data-inspection-type="rack"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-orange-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-server text-2xl text-orange-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Rack</h3>
                            <p class="text-xs text-gray-500 mt-1">Equipamiento y servidores</p>
                        </a>

                        <a href="#" data-inspection-type="movileye"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-sky-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-eye text-2xl text-sky-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">Movileye</h3>
                            <p class="text-xs text-gray-500 mt-1">Sistema de asistencia</p>
                        </a>

                        <a href="#" data-inspection-type="srl"
                            class="inspection-type-card card p-6 text-center hover:bg-gray-50 cursor-pointer">
                            <div class="rounded-full bg-emerald-100 w-16 h-16 mx-auto flex items-center justify-center">
                                <i class="fas fa-shield-halved text-2xl text-emerald-600"></i>
                            </div>
                            <h3 class="mt-4 font-medium text-gray-800">SRL</h3>
                            <p class="text-xs text-gray-500 mt-1">Seguridad y protección</p>
                        </a>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-6">Historial de Levantamientos</h3>
                        <div class="overflow-x-auto">
                            <table id="inspections-table" class="data-table">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Fecha</th>
                                        <th>Responsable</th>
                                        <th>Terminal</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="inspections-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vista de Equipo -->
                <div id="team-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Gestión de Equipo</h2>
                            <p class="text-sm text-gray-500 mt-1">Administra los miembros de tu equipo y sus roles</p>
                        </div>
                        <div class="flex space-x-2">
                            <div class="relative">
                                <input type="text" id="team-search" placeholder="Buscar miembro..."
                                    class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                            <button id="add-user-btn"
                                class="admin-only bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-user-plus mr-2"></i>
                                <span>Agregar Personal</span>
                            </button>
                        </div>
                    </div>

                    <div class="card p-6">
                        <div class="tabs">
                            <div class="tab active" data-tab="team-members">Miembros</div>
                            <div class="tab" data-tab="team-stats">Estadísticas</div>
                        </div>

                        <div class="tab-content active" id="team-members-content">
                            <div class="overflow-x-auto">
                                <table id="team-table" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Usuario</th>
                                            <th>Cargo</th>
                                            <th>Terminal</th>
                                            <th>Tareas Asignadas</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="team-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-content" id="team-stats-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-700 mb-4">Distribución por Cargo</h3>
                                    <canvas id="team-roles-chart" height="250"></canvas>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-700 mb-4">Distribución por Terminal</h3>
                                    <canvas id="team-terminals-chart" height="250"></canvas>
                                </div>
                                <div class="md:col-span-2">
                                    <h3 class="text-sm font-medium text-gray-700 mb-4">Productividad del Equipo</h3>
                                    <canvas id="team-productivity-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Informes -->
                <div id="reports-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Informes y Análisis</h2>
                            <p class="text-sm text-gray-500 mt-1">Visualiza estadísticas y genera informes detallados
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            <div>
                                <select id="report-period"
                                    class="py-2 pl-3 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="week">Esta semana</option>
                                    <option value="month" selected>Este mes</option>
                                    <option value="quarter">Este trimestre</option>
                                    <option value="year">Este año</option>
                                </select>
                            </div>
                            <button id="export-report-btn"
                                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-file-export mr-2"></i>
                                <span>Exportar</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-primary-100 text-primary-600">
                                    <i class="fas fa-tasks text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Total Tareas</h3>
                                    <p id="report-total-tasks" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-check-circle text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Completadas</h3>
                                    <p id="report-completed-tasks" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-amber-100 text-amber-600">
                                    <i class="fas fa-clock text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">En Progreso</h3>
                                    <p id="report-in-progress-tasks" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                    <i class="fas fa-clipboard-check text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-500">Levantamientos</h3>
                                    <p id="report-inspections" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card p-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Evolución de Tareas</h3>
                                <div class="chart-container large">
                                    <canvas id="tasks-trend-chart"></canvas>
                                </div>
                            </div>

                            <div class="card p-6 mt-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Distribución por Tipo de
                                    Levantamiento</h3>
                                <div class="chart-container large">
                                    <canvas id="inspections-type-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-1">
                            <div class="card p-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Distribución de Tareas</h3>
                                <div class="chart-container small">
                                    <canvas id="tasks-status-chart"></canvas>
                                </div>
                            </div>

                            <div class="card p-6 mt-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Productividad por Terminal</h3>
                                <div class="chart-container small">
                                    <canvas id="terminal-productivity-chart"></canvas>
                                </div>
                            </div>

                            <div class="card p-6 mt-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-6">Top Miembros</h3>
                                <div id="top-members" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Chat -->
                <div id="chat-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Mensajería</h2>
                            <p class="text-sm text-gray-500 mt-1">Comunícate con tu equipo en tiempo real</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <div class="card p-4">
                                <div class="relative mb-4">
                                    <input type="text" id="chat-search" placeholder="Buscar conversación..."
                                        class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                                        <i class="fas fa-search"></i>
                                    </div>
                                </div>

                                <div id="chat-list" class="space-y-2 max-h-[calc(100vh-240px)] overflow-y-auto">
                                    <div class="flex justify-center py-8">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <div id="no-chat-selected"
                                class="card p-6 h-full flex flex-col items-center justify-center text-center">
                                <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                                    <i class="fas fa-comments text-3xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-700">Selecciona una conversación</h3>
                                <p class="text-sm text-gray-500 mt-2">Elige un contacto de la lista para comenzar a
                                    chatear</p>
                            </div>

                            <div id="chat-container" class="card h-[calc(100vh-200px)] hidden">
                                <div id="chat-header" class="p-4 border-b flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div id="chat-avatar" class="avatar">JS</div>
                                        <div class="ml-3">
                                            <h3 id="chat-name" class="font-medium text-gray-800">Juan Silva</h3>
                                            <p id="chat-status" class="text-xs text-gray-500">En línea</p>
                                        </div>
                                    </div>
                                    <div>
                                        <button id="chat-options"
                                            class="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                                            <i class="fas fa-ellipsis-vertical"></i>
                                        </button>
                                    </div>
                                </div>

                                <div id="chat-messages" class="p-4 overflow-y-auto flex-1 space-y-4"></div>

                                <div id="chat-input-container" class="p-4 border-t">
                                    <form id="chat-form" class="flex items-center">
                                        <input type="text" id="chat-input" placeholder="Escribe un mensaje..."
                                            class="flex-1 py-2 px-4 border border-gray-300 rounded-l-full focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                        <button type="submit"
                                            class="bg-primary-600 hover:bg-primary-700 text-white p-3 rounded-r-full transition duration-150 ease-in-out">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista de Notificaciones -->
                <div id="notifications-view" class="hidden">
                    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <h2 class="text-2xl font-bold text-gray-800">Centro de Notificaciones</h2>
                            <p class="text-sm text-gray-500 mt-1">Revisa todas tus notificaciones y alertas</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="mark-all-read-btn"
                                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-check-double mr-2"></i>
                                <span>Marcar todo como leído</span>
                            </button>
                            <button id="clear-notifications-btn"
                                class="bg-white hover:bg-gray-100 text-gray-800 border border-gray-300 px-4 py-2 rounded-lg transition duration-150 ease-in-out flex items-center justify-center">
                                <i class="fas fa-trash-alt mr-2"></i>
                                <span>Limpiar notificaciones</span>
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <div class="tab active" data-tab="all-notifications">Todas</div>
                        <div class="tab" data-tab="unread-notifications">No leídas</div>
                        <div class="tab" data-tab="tasks-notifications">Tareas</div>
                        <div class="tab" data-tab="meetings-notifications">Reuniones</div>
                    </div>

                    <div class="tab-content active" id="all-notifications-content">
                        <div class="card p-6">
                            <div id="all-notifications-list"
                                class="space-y-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                                <div class="flex justify-center py-8">
                                    <div class="loader"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="unread-notifications-content">
                        <div class="card p-6">
                            <div id="unread-notifications-list"
                                class="space-y-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                                <div class="flex justify-center py-8">
                                    <div class="loader"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tasks-notifications-content">
                        <div class="card p-6">
                            <div id="tasks-notifications-list"
                                class="space-y-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                                <div class="flex justify-center py-8">
                                    <div class="loader"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="meetings-notifications-content">
                        <div class="card p-6">
                            <div id="meetings-notifications-list"
                                class="space-y-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                                <div class="flex justify-center py-8">
                                    <div class="loader"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Toast Notifications Container -->
            <div id="toast-container" class="toast-container"></div>
        </div>
    </div>

    <!-- MODALES -->

    <!-- Modal de Tarea -->
    <div id="task-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="task-modal-title" class="text-xl font-bold text-gray-800">Nueva Tarea</h2>
                <button class="task-modal-close p-2 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="space-y-4">
                    <div>
                        <label for="task-title">Título</label>
                        <input type="text" id="task-title" required>
                    </div>

                    <div>
                        <label for="task-description">Descripción</label>
                        <textarea id="task-description" rows="4"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="task-status">Estado</label>
                            <select id="task-status">
                                <option value="Pendiente">Pendiente</option>
                                <option value="En Progreso">En Progreso</option>
                                <option value="En Revisión">En Revisión</option>
                                <option value="Completada">Completada</option>
                            </select>
                        </div>

                        <div>
                            <label for="task-due-date">Fecha de Entrega</label>
                            <input type="date" id="task-due-date">
                        </div>
                    </div>

                    <div>
                        <label for="task-leader">Líder a cargo</label>
                        <select id="task-leader" required>
                            <option value="">Seleccionar líder</option>
                            <!-- Opciones de supervisores se cargarán dinámicamente -->
                        </select>
                    </div>

                    <div>
                        <label for="task-link">Enlace (Opcional)</label>
                        <input type="url" id="task-link" placeholder="https://ejemplo.com">
                    </div>

                    <div>
                        <label for="task-assignees">Asignar a (Ctrl+Click para seleccionar varios)</label>
                        <select id="task-assignees" multiple class="h-32">
                            <!-- Opciones se cargarán dinámicamente -->
                        </select>
                    </div>

                    <div>
                        <label for="task-notify">Notificar a los asignados</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="task-notify" class="w-4 h-4 mr-2" checked>
                            <span class="text-sm">Enviar notificación a todos los participantes</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button"
                        class="task-modal-close px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition duration-150 ease-in-out">
                        Guardar Tarea
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Reunión -->
    <div id="meeting-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="meeting-modal-title" class="text-xl font-bold text-gray-800">Nueva Reunión</h2>
                <button class="meeting-modal-close p-2 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="meeting-form">
                <input type="hidden" id="meeting-id">
                <div class="space-y-4">
                    <div>
                        <label for="meeting-title">Título</label>
                        <input type="text" id="meeting-title" required>
                    </div>

                    <div>
                        <label for="meeting-description">Descripción</label>
                        <textarea id="meeting-description" rows="3"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="meeting-date">Fecha</label>
                            <input type="date" id="meeting-date" required>
                        </div>

                        <div>
                            <label for="meeting-time">Hora</label>
                            <input type="time" id="meeting-time" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="meeting-duration">Duración (minutos)</label>
                            <input type="number" id="meeting-duration" min="15" step="5" value="60">
                        </div>

                        <div>
                            <label for="meeting-location">Ubicación</label>
                            <input type="text" id="meeting-location">
                        </div>
                    </div>

                    <div>
                        <label for="meeting-link">Enlace de Reunión Virtual (Opcional)</label>
                        <input type="url" id="meeting-link" placeholder="https://meet.ejemplo.com">
                    </div>

                    <div>
                        <label for="meeting-attendees">Participantes (Ctrl+Click para seleccionar varios)</label>
                        <select id="meeting-attendees" multiple class="h-32"></select>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="meeting-notify" class="w-4 h-4 mr-2">
                        <label for="meeting-notify" class="text-sm">Enviar notificación a los participantes</label>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button"
                        class="meeting-modal-close px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition duration-150 ease-in-out">
                        Guardar Reunión
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Usuario -->
    <div id="user-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="user-modal-title" class="text-xl font-bold text-gray-800">Agregar Personal</h2>
                <button class="user-modal-close p-2 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="space-y-4">
                    <div>
                        <label for="user-fullname">Nombre Completo</label>
                        <input type="text" id="user-fullname" required>
                    </div>

                    <div>
                        <label for="user-username">Nombre de Usuario (para login)</label>
                        <input type="text" id="user-username" required>
                    </div>

                    <div id="password-field">
                        <label for="user-password">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="user-password" required>
                            <button type="button" id="toggle-password"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                                <i class="far fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="user-role">Cargo</label>
                            <select id="user-role" required>
                                <option value="Inspector">Inspector</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Supervisor Admin">Supervisor Admin</option>
                                <option value="Jefe de Terminal">Jefe de Terminal</option>
                            </select>
                        </div>

                        <div>
                            <label for="user-terminal">Terminal</label>
                            <input type="text" id="user-terminal" required>
                        </div>
                    </div>

                    <div id="user-form-error" class="text-red-500 text-sm"></div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button"
                        class="user-modal-close px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition duration-150 ease-in-out">
                        Guardar Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Levantamiento -->
    <div id="inspection-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="inspection-modal-title" class="text-xl font-bold text-gray-800">Nuevo Levantamiento</h2>
                <button class="inspection-modal-close p-2 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="inspection-form">
                <input type="hidden" id="inspection-id">
                <input type="hidden" id="inspection-type">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="inspection-category">Tipo</label>
                            <select id="inspection-category" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="extintor">Extintor</option>
                                <option value="odometro">Odómetro</option>
                                <option value="luminaria">Luminaria</option>
                                <option value="wifi">WiFi</option>
                                <option value="publicidad">Publicidad</option>
                                <option value="normas-graficas">Normas Gráficas</option>
                                <option value="limpiaparabrisas">Limpiaparabrisas</option>
                                <option value="grabado-vidrios">Grabado Vidrios</option>
                                <option value="control-combustible">Control Combustible</option>
                                <option value="rack">Rack</option>
                                <option value="movileye">Movileye</option>
                                <option value="srl">SRL</option>
                            </select>
                        </div>

                        <div>
                            <label for="inspection-location">Ubicación/Terminal</label>
                            <input type="text" id="inspection-location" required>
                        </div>
                    </div>

                    <div id="inspection-form-fields">
                        <!-- Campos dinámicos según el tipo de levantamiento -->
                    </div>

                    <div>
                        <label for="inspection-notes">Observaciones</label>
                        <textarea id="inspection-notes" rows="3"></textarea>
                    </div>

                    <div>
                        <label for="inspection-file">Adjuntar archivo (opcional)</label>
                        <input type="file" id="inspection-file">
                    </div>

                    <div id="inspection-form-error" class="text-red-500 text-sm"></div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button"
                        class="inspection-modal-close px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition duration-150 ease-in-out">
                        Guardar Levantamiento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalle de Levantamiento -->
    <div id="inspection-detail-modal" class="modal-backdrop">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="inspection-detail-title" class="text-xl font-bold text-gray-800">Detalle de Levantamiento</h2>
                <button class="inspection-detail-modal-close p-2 hover:bg-gray-100 rounded-full">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="inspection-detail-content" class="space-y-6">
                <div class="flex justify-center py-8">
                    <div class="loader"></div>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button type="button"
                    class="inspection-detail-modal-close px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="delete-confirmation-modal" class="modal-backdrop">
        <div class="modal-content p-6 max-w-md">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h2 id="delete-confirmation-title" class="text-xl font-bold text-gray-800">¿Eliminar elemento?</h2>
                <p id="delete-confirmation-message" class="text-gray-600 mt-2">Esta acción no se puede deshacer.</p>
            </div>

            <div class="flex justify-center space-x-3">
                <button type="button" id="delete-cancel-btn"
                    class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150 ease-in-out">
                    Cancelar
                </button>
                <button type="button" id="delete-confirm-btn"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150 ease-in-out">
                    Eliminar
                </button>
            </div>
        </div>
    </div>


    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script type="module">
        // ===================================================================================
        // 1. CONFIGURACIÓN
        // ===================================================================================
        const SUPABASE_URL = 'https://tcmtxvuucjttngcazgff.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjbXR4dnV1Y2p0dG5nY2F6Z2ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3MjUwMDEsImV4cCI6MjA1NjMwMTAwMX0.2WcIjMUEhSM6j9kYpbsYArQocZdHx86k7wXk-NyjIs0';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Configurar tablas con nombres actualizados
        const TABLES = {
            USERS: 'Group_Red_Users',
            TASKS: 'Group_Red_Tasks',
            TASK_ASSIGNEES: 'Group_Red_Task_Assignees',
            TASK_COMMENTS: 'Group_Red_Task_Comments',
            TASK_FILES: 'Group_Red_Task_Files',
            MEETINGS: 'Group_Red_Meetings',
            MEETING_ATTENDEES: 'Group_Red_Meeting_Attendees',
            NOTIFICATIONS: 'Group_Red_Notifications',
            INSPECTIONS: 'Group_Red_Inspections',
            INSPECTION_ITEMS: 'Group_Red_Inspection_Items',
            INSPECTION_FILES: 'Group_Red_Inspection_Files',
            CHAT_MESSAGES: 'Group_Red_Chat_Messages'
        };

        // ===================================================================================
        // 2. ESTADO GLOBAL Y SELECTORES DEL DOM
        // ===================================================================================
        let currentUser = null;
        let allUsers = [];
        let currentTasks = [];
        let currentMeetings = [];
        let currentInspections = [];
        let currentNotifications = [];
        let currentPage = 'dashboard';
        let mainCalendar = null;
        let miniCalendar = null;
        let meetingMiniCalendar = null;
        let isSidebarCollapsed = false;
        let isMobile = window.innerWidth < 768;
        let charts = {};
        let subscription = null;

        // Elementos del DOM principales
        const app = document.getElementById('app-container');
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const sidebar = document.getElementById('sidebar');
        const header = document.getElementById('header');
        const mainContent = document.querySelector('.main-content');
        const pageTitle = document.getElementById('page-title');

        // Elementos de formularios
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const taskForm = document.getElementById('task-form');
        const meetingForm = document.getElementById('meeting-form');
        const userForm = document.getElementById('user-form');
        const inspectionForm = document.getElementById('inspection-form');

        // Botones y elementos de navegación
        const logoutButton = document.getElementById('logout-button');
        const dropdownLogoutButton = document.getElementById('dropdown-logout');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const navLinks = document.querySelectorAll('.nav-link');

        // Elementos de notificaciones
        const notificationBtn = document.getElementById('notification-btn');
        const notificationPanel = document.getElementById('notification-panel');
        const notificationCount = document.getElementById('notification-count');
        const markAllReadBtn = document.getElementById('mark-all-read');

        // Elementos del perfil de usuario
        const userDropdownBtn = document.getElementById('user-dropdown-btn');
        const userDropdownMenu = document.querySelector('#user-dropdown-btn + .dropdown-menu');
        const userAvatar = document.getElementById('user-avatar');
        const headerAvatar = document.getElementById('header-avatar');
        const userName = document.getElementById('user-name');
        const headerUserName = document.getElementById('header-user-name');
        const userRole = document.getElementById('user-role');

        // Vistas de la aplicación
        const views = {
            dashboard: document.getElementById('dashboard-view'),
            tasks: document.getElementById('tasks-view'),
            taskDetail: document.getElementById('task-detail-view'),
            calendar: document.getElementById('calendar-view'),
            meetings: document.getElementById('meetings-view'),
            inspections: document.getElementById('inspections-view'),
            team: document.getElementById('team-view'),
            reports: document.getElementById('reports-view'),
            chat: document.getElementById('chat-view'),
            notifications: document.getElementById('notifications-view')
        };

        // Modales
        const taskModal = document.getElementById('task-modal');
        const meetingModal = document.getElementById('meeting-modal');
        const userModal = document.getElementById('user-modal');
        const inspectionModal = document.getElementById('inspection-modal');
        const inspectionDetailModal = document.getElementById('inspection-detail-modal');
        const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');

        // Botones de acción
        const addTaskBtn = document.getElementById('add-task-btn');
        const addMeetingBtn = document.getElementById('add-meeting-btn');
        const addUserBtn = document.getElementById('add-user-btn');
        const addInspectionBtn = document.getElementById('add-inspection-btn');
        const addEventBtn = document.getElementById('add-event-btn');


        // Modificar el evento de clic para abrir el modal
        document.getElementById('add-task-btn').addEventListener('click', () => {
            document.getElementById('task-form').reset();
            document.getElementById('task-id').value = '';
            document.getElementById('task-modal-title').textContent = 'Nueva Tarea';

            // Usar la nueva función para llenar selectores basados en roles
            populateUserSelectsByRole();

            // Establecer fecha mínima como hoy para la fecha de entrega
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('task-due-date').min = today;

            openModal(taskModal);
        });



        // Función para cargar usuarios en los selectores según sus roles
        function populateUserSelectsByRole() {
            console.log('🔁 Ejecutando populateUserSelectsByRole');

            const leaderSelect = document.getElementById('task-leader');
            const assigneesSelect = document.getElementById('task-assignees');

            if (!leaderSelect || !assigneesSelect) {
                console.error('❌ Selects no encontrados en el DOM.');
                return;
            }

            if (!Array.isArray(allUsers) || allUsers.length === 0) {
                console.warn('⚠️ allUsers vacío o no inicializado.');
                return;
            }

            // Limpiar selects
            leaderSelect.innerHTML = '<option value="">Seleccionar líder</option>';
            assigneesSelect.innerHTML = '';

            // Filtrar supervisores
            const supervisors = allUsers.filter(user =>
                ['Supervisor', 'Supervisor Admin', 'Jefe de Terminal'].includes(user.cargo)
            );

            // Filtrar asignables
            const assignables = allUsers.filter(user =>
                ['Supervisor', 'Supervisor Admin', 'Inspector'].includes(user.cargo)
            );

            // Poblar líderes
            supervisors.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.nombre_completo} (${user.cargo})`;
                leaderSelect.appendChild(option);
            });

            // Poblar asignables
            assignables.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.nombre_completo} (${user.cargo})`;
                assigneesSelect.appendChild(option);
            });

            console.log(`✅ Selects actualizados: ${supervisors.length} líderes, ${assignables.length} asignables`);
        }





        // Función para editar tarea
        async function editTask(taskId) {
            try {
                // Obtener datos de la tarea
                const { data: task, error } = await supabaseClient
                    .from(TABLES.TASKS)
                    .select(`
                *,
                leader:Group_Red_Users!leader_id(id, nombre_completo, cargo),
                creator:Group_Red_Users!creator_id(id, nombre_completo, cargo),
                assignees:Group_Red_Task_Assignees!task_id(
                    user:Group_Red_Users!user_id(id, nombre_completo, cargo)
                )
            `)
                    .eq('id', taskId)
                    .single();

                if (error) throw error;

                // Llenar formulario
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-status').value = task.status;
                document.getElementById('task-link').value = task.link_url || '';
                document.getElementById('task-due-date').value = task.due_date || '';

                // Cargar usuarios en selectores
                populateUserSelectsByRole();

                // Seleccionar líder
                if (task.leader_id) {
                    document.getElementById('task-leader').value = task.leader_id;
                }

                // Seleccionar asignados
                const assigneesSelect = document.getElementById('task-assignees');
                if (task.assignees) {
                    const assigneeIds = task.assignees.map(a => a.user.id);
                    Array.from(assigneesSelect.options).forEach(option => {
                        option.selected = assigneeIds.includes(option.value);
                    });
                }

                document.getElementById('task-modal-title').textContent = 'Editar Tarea';
                openModal(taskModal);
            } catch (error) {
                console.error('Error obteniendo datos de la tarea:', error);
                showToast('Error al cargar datos de la tarea.', 'error');
            }
        }



        // ===================================================================================
        // 3. FUNCIONES DE UTILIDAD
        // ===================================================================================

        // Función para mostrar notificaciones toast
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = '';
            switch (type) {
                case 'success': icon = '<i class="fas fa-check-circle toast-icon"></i>'; break;
                case 'error': icon = '<i class="fas fa-exclamation-circle toast-icon"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>'; break;
                default: icon = '<i class="fas fa-info-circle toast-icon"></i>';
            }

            toast.innerHTML = `
                ${icon}
                <div>${message}</div>
                <button class="toast-close"><i class="fas fa-times"></i></button>
            `;

            document.getElementById('toast-container').appendChild(toast);

            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Función para reproducir sonido de notificación
        function playNotificationSound(type = 'notification') {
            const sound = document.getElementById(type === 'message' ? 'message-sound' : 'notification-sound');
            sound.currentTime = 0;
            sound.play().catch(e => console.error('Error reproduciendo sonido:', e));
        }

        // Función para formatear fechas
        function formatDate(dateString, includeTime = true) {
            const date = new Date(dateString);
            const options = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            };

            if (includeTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
            }

            return date.toLocaleDateString('es-ES', options);
        }

        // Función para generar iniciales del nombre
        function getInitials(name) {
            if (!name) return '';
            return name.split(' ')
                .map(part => part.charAt(0).toUpperCase())
                .slice(0, 2)
                .join('');
        }

        // Función para generar color aleatorio basado en string
        function stringToColor(str) {
            if (!str) return '#0ea5e9';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }

            const colors = [
                '#0ea5e9', // primary-500
                '#0284c7', // primary-600
                '#64748b', // secondary-500
                '#22c55e', // success-500
                '#16a34a', // success-600
                '#f59e0b', // warning-500
                '#d97706', // warning-600
                '#ef4444', // danger-500
                '#dc2626', // danger-600
                '#8b5cf6', // purple
                '#2dd4bf', // teal
                '#f43f5e', // rose
            ];

            return colors[Math.abs(hash) % colors.length];
        }

        // Función para abrir modal
        function openModal(modal) {
            modal.classList.add('show');
            setTimeout(() => {
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
                modal.querySelector('.modal-content').style.opacity = '1';
            }, 10);
        }

        // Función para cerrar modal
        function closeModal(modal) {
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            modal.querySelector('.modal-content').style.opacity = '0';
            setTimeout(() => {
                modal.classList.remove('show');
            }, 300);
        }

        // Función para mostrar la vista
        function showView(viewId) {
            currentPage = viewId;
            Object.values(views).forEach(view => view.classList.add('hidden'));

            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
                pageTitle.textContent = getPageTitle(viewId);

                // Actualizar estado de navegación
                navLinks.forEach(link => link.classList.remove('active'));
                document.getElementById(`nav-${viewId}`).classList.add('active');
            }
        }

        // Obtener título de la página
        function getPageTitle(viewId) {
            const titles = {
                dashboard: 'Dashboard',
                tasks: 'Gestión de Tareas',
                taskDetail: 'Detalle de Tarea',
                calendar: 'Calendario',
                meetings: 'Reuniones',
                inspections: 'Levantamientos',
                team: 'Gestión de Equipo',
                reports: 'Informes y Análisis',
                chat: 'Mensajería',
                notifications: 'Centro de Notificaciones'
            };

            return titles[viewId] || 'Dashboard';
        }

        // Función para verificar permisos de administrador
        function isAdmin() {
            return currentUser && (currentUser.cargo === 'Jefe de Terminal' || currentUser.cargo === 'Supervisor Admin');
        }

        // Función para generar avatar de usuario
        function createAvatar(user, size = 'w-10 h-10') {
            const initials = getInitials(user.nombre_completo);
            const color = stringToColor(user.nombre_completo);

            return `
                <div class="avatar ${size}" style="background-color: ${color}">
                    ${initials}
                </div>
            `;
        }

        // Función para generar estado de tarea
        function createStatusBadge(status) {
            let className = '';
            let icon = '';

            switch (status) {
                case 'Pendiente':
                    className = 'pending';
                    icon = 'fa-clock';
                    break;
                case 'En Progreso':
                    className = 'in-progress';
                    icon = 'fa-spinner';
                    break;
                case 'En Revisión':
                    className = 'in-review';
                    icon = 'fa-magnifying-glass';
                    break;
                case 'Completada':
                    className = 'completed';
                    icon = 'fa-check-circle';
                    break;
            }

            return `
                <span class="status-badge ${className}">
                    <i class="fas ${icon} mr-1"></i> ${status}
                </span>
            `;
        }

        // Función para crear notificación en el sistema
        async function createNotification(userId, title, message, type, relatedId = null) {
            try {
                const { data, error } = await supabaseClient
                    .from(TABLES.NOTIFICATIONS)
                    .insert({
                        user_id: userId,
                        title,
                        message,
                        type,
                        related_id: relatedId,
                        read: false,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error creando notificación:', error);
                return null;
            }
        }

        // Función para obtener datos de supabase con reintento
        async function fetchWithRetry(callback, maxRetries = 3) {
            let retries = 0;

            while (retries < maxRetries) {
                try {
                    const result = await callback();
                    return result;
                } catch (error) {
                    retries++;
                    if (retries === maxRetries) {
                        console.error('Error después de múltiples intentos:', error);
                        throw error;
                    }

                    // Esperar antes de reintentar (con backoff exponencial)
                    await new Promise(resolve => setTimeout(resolve, 500 * Math.pow(2, retries)));
                }
            }
        }

        // ===================================================================================
        // 4. AUTENTICACIÓN Y MANEJO DE SESIÓN
        // ===================================================================================

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', async () => {
            // Comprobar si hay una sesión guardada
            const userSession = sessionStorage.getItem('user');

            if (userSession) {
                try {
                    currentUser = JSON.parse(userSession);
                    await initializeApp();
                } catch (error) {
                    console.error('Error al recuperar la sesión:', error);
                    sessionStorage.removeItem('user');
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }

            // Listeners de respuesta adaptativa
            window.addEventListener('resize', handleResize);
            handleResize();
        });

        // Mostrar la página de login
        function showLoginPage() {
            loginPage.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        // Manejar el formulario de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';

            const username = e.target.username.value.trim();
            const password = e.target.password.value;

            if (!username || !password) {
                loginError.textContent = 'Por favor, completa todos los campos.';
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from(TABLES.USERS)
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error || !data) {
                    loginError.textContent = 'Usuario o contraseña incorrectos.';
                    return;
                }

                currentUser = data;
                sessionStorage.setItem('user', JSON.stringify(data));
                await initializeApp();

                showToast(`¡Bienvenido, ${currentUser.nombre_completo}!`, 'success');
            } catch (error) {
                console.error('Error en el login:', error);
                loginError.textContent = 'Ocurrió un error al intentar iniciar sesión.';
            }
        });

        // Cerrar sesión
        function handleLogout() {
            sessionStorage.removeItem('user');
            currentUser = null;

            // Cerrar suscripción si existe
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
            }

            // Destruir calendarios
            if (mainCalendar) {
                mainCalendar.destroy();
                mainCalendar = null;
            }

            if (miniCalendar) {
                miniCalendar.destroy();
                miniCalendar = null;
            }

            if (meetingMiniCalendar) {
                meetingMiniCalendar.destroy();
                meetingMiniCalendar = null;
            }

            // Destruir gráficos
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });

            charts = {};

            showToast('Sesión cerrada correctamente', 'info');
            showLoginPage();
            location.reload();
        }

        // Eventos de cierre de sesión
        logoutButton.addEventListener('click', handleLogout);
        dropdownLogoutButton.addEventListener('click', handleLogout);

        // Inicializar la aplicación
        async function initializeApp() {
            loginPage.classList.add('hidden');
            mainApp.classList.remove('hidden');

            // Actualizar información del usuario
            userName.textContent = currentUser.nombre_completo;
            headerUserName.textContent = currentUser.nombre_completo;
            userRole.textContent = currentUser.cargo;

            // Iniciales en avatar
            const initials = getInitials(currentUser.nombre_completo);
            userAvatar.textContent = initials;
            headerAvatar.textContent = initials;

            // Mostrar elementos de administrador si corresponde
            if (isAdmin()) {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            }

            // Configurar navegación
            setupNavigation();

            // Cargar datos iniciales
            await Promise.all([
                fetchAllUsers(),
                fetchNotifications()
            ]);

            // Mostrar dashboard como vista inicial
            showView('dashboard');
            await renderDashboard();
            await populateUserSelectsByRole();

            // Configurar suscripción para actualizaciones en tiempo real
            setupRealTimeSubscription();

            // Inicializar componentes y eventos
            setupEventListeners();
        }

        // Configurar navegación
        function setupNavigation() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = link.id.replace('nav-', '');
                    showView(viewId);

                    // Cargar datos según la vista
                    switch (viewId) {
                        case 'dashboard': renderDashboard(); break;
                        case 'tasks': renderTasks(); break;
                        case 'calendar': renderCalendar(); break;
                        case 'meetings': renderMeetings(); break;
                        case 'inspections': renderInspections(); break;
                        case 'team': renderTeam(); break;
                        case 'reports': renderReports(); break;
                        case 'chat': renderChat(); break;
                        case 'notifications': renderNotificationsView(); break;
                    }

                    // En móvil, cerrar el sidebar después de la navegación
                    if (isMobile) {
                        sidebar.classList.remove('mobile-show');
                    }
                });
            });
        }

        // Manejar cambio de tamaño de ventana
        function handleResize() {
            isMobile = window.innerWidth < 768;

            if (isMobile) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
                header.classList.remove('expanded');
                mobileSidebarToggle.classList.remove('hidden');
            } else {
                sidebar.classList.remove('mobile-show');
                mobileSidebarToggle.classList.add('hidden');

                if (isSidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    header.classList.add('expanded');
                }
            }
        }

        // Configurar eventos de la interfaz
        function setupEventListeners() {
            // Toggle del sidebar
            sidebarToggle.addEventListener('click', () => {
                isSidebarCollapsed = !isSidebarCollapsed;
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                header.classList.toggle('expanded');
            });

            // Toggle del sidebar en móvil
            mobileSidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('mobile-show');
            });

            // Dropdown del usuario
            userDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdownBtn.parentElement.classList.toggle('show');
            });

            // Panel de notificaciones
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationPanel.style.display = notificationPanel.style.display === 'block' ? 'none' : 'block';

                if (notificationPanel.style.display === 'block') {
                    renderNotificationPanel();
                }
            });

            // Marcar todas las notificaciones como leídas
            markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);

            // Cerrar dropdowns al hacer clic fuera
            document.addEventListener('click', () => {
                document.querySelectorAll('.dropdown.show').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });

                notificationPanel.style.display = 'none';
            });

            // Evitar que los clics dentro de dropdowns los cierren
            document.querySelectorAll('.dropdown-menu, #notification-panel').forEach(element => {
                element.addEventListener('click', (e) => e.stopPropagation());
            });

            // Cambio de pestañas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabGroup = this.parentElement;
                    const tabId = this.getAttribute('data-tab');
                    const contentId = `${tabId}-content`;

                    // Activar pestaña seleccionada
                    tabGroup.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Mostrar contenido correspondiente
                    const tabContents = tabGroup.parentElement.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(contentId).classList.add('active');
                });
            });

            // Setup de modales
            setupModals();

            // Configurar eventos de vistas específicas
            setupTasksView();
            setupCalendarView();
            setupMeetingsView();
            setupInspectionsView();
            setupTeamView();
            setupReportsView();
            setupChatView();
            setupNotificationsView();
        }

        // Configurar modales
        function setupModals() {
            // Cerrar modales
            document.querySelectorAll('.task-modal-close').forEach(button => {
                button.addEventListener('click', () => closeModal(taskModal));
            });

            document.querySelectorAll('.meeting-modal-close').forEach(button => {
                button.addEventListener('click', () => closeModal(meetingModal));
            });

            document.querySelectorAll('.user-modal-close').forEach(button => {
                button.addEventListener('click', () => closeModal(userModal));
            });

            document.querySelectorAll('.inspection-modal-close').forEach(button => {
                button.addEventListener('click', () => closeModal(inspectionModal));
            });

            document.querySelectorAll('.inspection-detail-modal-close').forEach(button => {
                button.addEventListener('click', () => closeModal(inspectionDetailModal));
            });

            document.getElementById('delete-cancel-btn').addEventListener('click', () => {
                closeModal(deleteConfirmationModal);
            });

            // Abrir modales
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', () => {
                    document.getElementById('task-form').reset();
                    document.getElementById('task-id').value = '';
                    document.getElementById('task-modal-title').textContent = 'Nueva Tarea';
                    populateUserSelects(document.getElementById('task-assignees'));
                    openModal(taskModal);
                });
            }

            if (addMeetingBtn) {
                addMeetingBtn.addEventListener('click', () => {
                    document.getElementById('meeting-form').reset();
                    document.getElementById('meeting-id').value = '';
                    document.getElementById('meeting-modal-title').textContent = 'Nueva Reunión';
                    populateUserSelects(document.getElementById('meeting-attendees'));
                    openModal(meetingModal);
                });
            }

            if (addUserBtn) {
                addUserBtn.addEventListener('click', () => {
                    document.getElementById('user-form').reset();
                    document.getElementById('user-id').value = '';
                    document.getElementById('user-modal-title').textContent = 'Agregar Personal';
                    document.getElementById('password-field').style.display = 'block';
                    openModal(userModal);
                });
            }

            if (addInspectionBtn) {
                addInspectionBtn.addEventListener('click', () => {
                    document.getElementById('inspection-form').reset();
                    document.getElementById('inspection-id').value = '';
                    document.getElementById('inspection-modal-title').textContent = 'Nuevo Levantamiento';
                    document.getElementById('inspection-form-fields').innerHTML = '';
                    openModal(inspectionModal);
                });
            }

            if (addEventBtn) {
                addEventBtn.addEventListener('click', () => {
                    const eventType = document.querySelector('#task-calendar-view').classList.contains('bg-primary-600') ? 'task' : 'meeting';

                    if (eventType === 'task') {
                        document.getElementById('task-form').reset();
                        document.getElementById('task-id').value = '';
                        document.getElementById('task-modal-title').textContent = 'Nueva Tarea';
                        populateUserSelects(document.getElementById('task-assignees'));
                        openModal(taskModal);
                    } else {
                        document.getElementById('meeting-form').reset();
                        document.getElementById('meeting-id').value = '';
                        document.getElementById('meeting-modal-title').textContent = 'Nueva Reunión';
                        populateUserSelects(document.getElementById('meeting-attendees'));
                        openModal(meetingModal);
                    }
                });
            }

            // Mostrar/ocultar contraseña
            document.getElementById('toggle-password').addEventListener('click', function () {
                const passwordInput = document.getElementById('user-password');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // Cambiar icono
                this.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
            });

            // Cambiar campos según tipo de levantamiento
            document.getElementById('inspection-category').addEventListener('change', function () {
                const category = this.value;
                document.getElementById('inspection-type').value = category;

                const fieldsContainer = document.getElementById('inspection-form-fields');
                fieldsContainer.innerHTML = '';

                if (!category) return;

                // Generar campos según el tipo de levantamiento
                let fields = '';

                switch (category) {
                    case 'extintor':
                        fields = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="extintor-serial">Número de Serie</label>
                                    <input type="text" id="extintor-serial" name="serial" required>
                                </div>
                                <div>
                                    <label for="extintor-tipo">Tipo</label>
                                    <select id="extintor-tipo" name="tipo" required>
                                        <option value="ABC">ABC</option>
                                        <option value="CO2">CO2</option>
                                        <option value="Agua">Agua</option>
                                        <option value="Espuma">Espuma</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="extintor-fecha-recarga">Última Recarga</label>
                                    <input type="date" id="extintor-fecha-recarga" name="fecha_recarga" required>
                                </div>
                                <div>
                                    <label for="extintor-fecha-vencimiento">Fecha de Vencimiento</label>
                                    <input type="date" id="extintor-fecha-vencimiento" name="fecha_vencimiento" required>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="extintor-estado">Estado</label>
                                <select id="extintor-estado" name="estado" required>
                                    <option value="Operativo">Operativo</option>
                                    <option value="No Operativo">No Operativo</option>
                                    <option value="Requiere Mantenimiento">Requiere Mantenimiento</option>
                                </select>
                            </div>
                        `;
                        break;

                    case 'odometro':
                        fields = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="odometro-vehiculo">Vehículo/ID</label>
                                    <input type="text" id="odometro-vehiculo" name="vehiculo" required>
                                </div>
                                <div>
                                    <label for="odometro-lectura">Lectura (km)</label>
                                    <input type="number" id="odometro-lectura" name="lectura" min="0" step="0.1" required>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="odometro-fecha-lectura">Fecha de Lectura</label>
                                <input type="date" id="odometro-fecha-lectura" name="fecha_lectura" required>
                            </div>
                        `;
                        break;

                    case 'luminaria':
                        fields = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="luminaria-sector">Sector/Área</label>
                                    <input type="text" id="luminaria-sector" name="sector" required>
                                </div>
                                <div>
                                    <label for="luminaria-tipo">Tipo</label>
                                    <select id="luminaria-tipo" name="tipo" required>
                                        <option value="LED">LED</option>
                                        <option value="Fluorescente">Fluorescente</option>
                                        <option value="Halógena">Halógena</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="luminaria-estado">Estado</label>
                                <select id="luminaria-estado" name="estado" required>
                                    <option value="Operativa">Operativa</option>
                                    <option value="Falla Parcial">Falla Parcial</option>
                                    <option value="No Operativa">No Operativa</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label for="luminaria-cantidad">Cantidad de Luminarias</label>
                                <input type="number" id="luminaria-cantidad" name="cantidad" min="1" required>
                            </div>
                        `;
                        break;

                    case 'wifi':
                        fields = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="wifi-ssid">SSID (Nombre de Red)</label>
                                    <input type="text" id="wifi-ssid" name="ssid" required>
                                </div>
                                <div>
                                    <label for="wifi-ubicacion">Ubicación del Punto</label>
                                    <input type="text" id="wifi-ubicacion" name="ubicacion" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="wifi-velocidad">Velocidad (Mbps)</label>
                                    <input type="number" id="wifi-velocidad" name="velocidad" min="0" step="0.1" required>
                                </div>
                                <div>
                                    <label for="wifi-cobertura">Nivel de Cobertura</label>
                                    <select id="wifi-cobertura" name="cobertura" required>
                                        <option value="Excelente">Excelente</option>
                                        <option value="Buena">Buena</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Deficiente">Deficiente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="wifi-estado">Estado</label>
                                <select id="wifi-estado" name="estado" required>
                                    <option value="Operativo">Operativo</option>
                                    <option value="Intermitente">Intermitente</option>
                                    <option value="No Operativo">No Operativo</option>
                                </select>
                            </div>
                        `;
                        break;

                    // Campos para los demás tipos
                    default:
                        fields = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="item-nombre">Nombre/Identificador</label>
                                    <input type="text" id="item-nombre" name="nombre" required>
                                </div>
                                <div>
                                    <label for="item-ubicacion">Ubicación</label>
                                    <input type="text" id="item-ubicacion" name="ubicacion" required>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="item-estado">Estado</label>
                                <select id="item-estado" name="estado" required>
                                    <option value="Operativo">Operativo</option>
                                    <option value="Requiere Atención">Requiere Atención</option>
                                    <option value="No Operativo">No Operativo</option>
                                </select>
                            </div>
                        `;
                }

                fieldsContainer.innerHTML = fields;
            });

            // Formularios de los modales
            taskForm.addEventListener('submit', handleTaskFormSubmit);
            meetingForm.addEventListener('submit', handleMeetingFormSubmit);
            userForm.addEventListener('submit', handleUserFormSubmit);
            inspectionForm.addEventListener('submit', handleInspectionFormSubmit);

            // Manejar confirmación de eliminación
            document.getElementById('delete-confirm-btn').addEventListener('click', async () => {
                const type = deleteConfirmationModal.getAttribute('data-type');
                const id = deleteConfirmationModal.getAttribute('data-id');

                if (!type || !id) return;

                try {
                    let success = false;

                    switch (type) {
                        case 'task':
                            success = await deleteTask(id);
                            break;
                        case 'meeting':
                            success = await deleteMeeting(id);
                            break;
                        case 'user':
                            success = await deleteUser(id);
                            break;
                        case 'inspection':
                            success = await deleteInspection(id);
                            break;
                    }

                    if (success) {
                        showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} eliminado correctamente.`, 'success');

                        // Actualizar vista correspondiente
                        switch (type) {
                            case 'task':
                                showView('tasks');
                                await renderTasks();
                                break;
                            case 'meeting':
                                await renderMeetings();
                                break;
                            case 'user':
                                await renderTeam();
                                break;
                            case 'inspection':
                                await renderInspections();
                                break;
                        }
                    } else {
                        showToast(`Error al eliminar ${type}.`, 'error');
                    }
                } catch (error) {
                    console.error(`Error eliminando ${type}:`, error);
                    showToast(`Error al eliminar ${type}.`, 'error');
                } finally {
                    closeModal(deleteConfirmationModal);
                }
            });
        }

        // ===================================================================================
        // 5. CARGA DE DATOS Y REALTIME
        // ===================================================================================

        // Obtener todos los usuarios
        async function fetchAllUsers() {
            const { data, error } = await supabaseClient
                .from('Group_Red_Users')
                .select('*');

            if (error) {
                console.error("❌ Error al obtener usuarios:", error);
                return;
            }

            allUsers = data;
            console.log("✅ Usuarios obtenidos:", allUsers);
            // Poblar ambos selects de tarea:
            const assigneesSelect = document.getElementById('task-assignees');
            const leaderSelect = document.getElementById('task-leader');
            populateUserSelects(assigneesSelect);
            populateUserSelects(leaderSelect);

        }


        function showTaskModal() {
            console.log("🧪 Abriendo modal de tarea");

            // Llenar selects SIEMPRE al abrir el modal
            populateUserSelectsByRole();

            // Mostrar modal
            const taskModal = document.getElementById('taskModal');
            if (taskModal) {
                taskModal.classList.remove('hidden');
            } else {
                console.error('❌ No se encontró el modal con id taskModal');
            }
        }






        // Obtener las tareas
        async function fetchTasks() {
            try {
                // Obtener las tareas asignadas al usuario
                const { data: assignedTasks, error: assignedError } = await supabaseClient
                    .from(TABLES.TASK_ASSIGNEES)
                    .select(`
                        task:${TABLES.TASKS}!inner(
                            *,
                            creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo)
                        )
                    `)
                    .eq('user_id', currentUser.id);

                if (assignedError) throw assignedError;

                // Obtener las tareas creadas por el usuario
                const { data: createdTasks, error: createdError } = await supabaseClient
                    .from(TABLES.TASKS)
                    .select(`
                        *,
                        creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo)
                    `)
                    .eq('creator_id', currentUser.id);

                if (createdError) throw createdError;

                // Si el usuario es admin, obtener todas las tareas
                let allTasksData = [];

                if (isAdmin()) {
                    const { data: allTasks, error: allError } = await supabaseClient
                        .from(TABLES.TASKS)
                        .select(`
                            *,
                            creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo)
                        `);

                    if (allError) throw allError;
                    allTasksData = allTasks || [];
                }

                // Procesamos las tareas asignadas
                const assigned = assignedTasks ? assignedTasks.map(item => item.task) : [];
                const created = createdTasks || [];

                // Eliminamos duplicados (tareas que el usuario creó y también está asignado)
                const uniqueCreated = created.filter(task =>
                    !assigned.some(assignedTask => assignedTask.id === task.id)
                );

                // Combinamos los resultados
                currentTasks = {
                    assigned,
                    created: uniqueCreated,
                    all: allTasksData
                };

                return currentTasks;
            } catch (error) {
                console.error('Error obteniendo tareas:', error);
                showToast('Error al cargar tareas.', 'error');
                return { assigned: [], created: [], all: [] };
            }
        }

        // Obtener reuniones
        async function fetchMeetings() {
            try {
                // Obtener reuniones donde el usuario es participante
                const { data: attendeeMeetings, error: attendeeError } = await supabaseClient
                    .from(TABLES.MEETING_ATTENDEES)
                    .select(`
                        meeting:${TABLES.MEETINGS}!inner(
                            *,
                            creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo)
                        )
                    `)
                    .eq('user_id', currentUser.id);

                if (attendeeError) throw attendeeError;

                // Obtener reuniones creadas por el usuario
                const { data: createdMeetings, error: createdError } = await supabaseClient
                    .from(TABLES.MEETINGS)
                    .select(`
                        *,
                        creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo)
                    `)
                    .eq('creator_id', currentUser.id);

                if (createdError) throw createdError;

                // Si el usuario es admin, obtener todas las reuniones
                let allMeetingsData = [];

                if (isAdmin()) {
                    const { data: allMeetings, error: allError } = await supabaseClient
                        .from(TABLES.MEETINGS)
                        .select(`
                            *,
                            creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo)
                        `);

                    if (allError) throw allError;
                    allMeetingsData = allMeetings || [];
                }

                // Procesamos las reuniones
                const upcoming = [];
                const past = [];
                const now = new Date();

                // Procesar reuniones donde es participante
                const attended = attendeeMeetings ? attendeeMeetings.map(item => item.meeting) : [];
                const created = createdMeetings || [];

                // Eliminar duplicados
                const uniqueCreated = created.filter(meeting =>
                    !attended.some(attendedMeeting => attendedMeeting.id === meeting.id)
                );

                // Combinar resultados
                const allMeetings = [...attended, ...uniqueCreated];

                // Separar en próximas y pasadas
                allMeetings.forEach(meeting => {
                    const meetingDate = new Date(meeting.date + 'T' + meeting.time);
                    if (meetingDate > now) {
                        upcoming.push(meeting);
                    } else {
                        past.push(meeting);
                    }
                });

                // Ordenar por fecha
                upcoming.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
                past.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

                currentMeetings = {
                    upcoming,
                    past,
                    all: allMeetingsData
                };

                return currentMeetings;
            } catch (error) {
                console.error('Error obteniendo reuniones:', error);
                showToast('Error al cargar reuniones.', 'error');
                return { upcoming: [], past: [], all: [] };
            }
        }

        // Obtener levantamientos
        async function fetchInspections() {
            try {
                // Obtener levantamientos creados por el usuario
                const { data: userInspections, error: userError } = await supabaseClient
                    .from(TABLES.INSPECTIONS)
                    .select(`
                        *,
                        creator:${TABLES.USERS}!user_id(id, nombre_completo, cargo)
                    `)
                    .eq('user_id', currentUser.id);

                if (userError) throw userError;

                // Si el usuario es admin o supervisor, obtener todos los levantamientos
                let allInspectionsData = [];

                if (isAdmin() || currentUser.cargo === 'Supervisor' || currentUser.cargo === 'Supervisor Admin') {
                    const { data: allInspections, error: allError } = await supabaseClient
                        .from(TABLES.INSPECTIONS)
                        .select(`
                            *,
                            creator:${TABLES.USERS}!user_id(id, nombre_completo, cargo)
                        `);

                    if (allError) throw allError;
                    allInspectionsData = allInspections || [];
                } else {
                    allInspectionsData = userInspections || [];
                }

                // Agrupar por tipo
                const byType = allInspectionsData.reduce((acc, inspection) => {
                    if (!acc[inspection.type]) {
                        acc[inspection.type] = [];
                    }
                    acc[inspection.type].push(inspection);
                    return acc;
                }, {});

                currentInspections = {
                    all: allInspectionsData,
                    byType
                };

                return currentInspections;
            } catch (error) {
                console.error('Error obteniendo levantamientos:', error);
                showToast('Error al cargar levantamientos.', 'error');
                return { all: [], byType: {} };
            }
        }

        // Obtener notificaciones
        async function fetchNotifications() {
            try {
                const { data, error } = await supabaseClient
                    .from(TABLES.NOTIFICATIONS)
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                currentNotifications = data || [];

                // Actualizar contador de notificaciones no leídas
                updateNotificationCount();

                return currentNotifications;
            } catch (error) {
                console.error('Error obteniendo notificaciones:', error);
                return [];
            }
        }

        // Actualizar contador de notificaciones
        function updateNotificationCount() {
            const unreadCount = currentNotifications.filter(notification => !notification.read).length;

            if (unreadCount > 0) {
                notificationCount.textContent = unreadCount > 99 ? '99+' : unreadCount;
                notificationCount.classList.remove('hidden');
                notificationBtn.classList.add('pulse');
            } else {
                notificationCount.classList.add('hidden');
                notificationBtn.classList.remove('pulse');
            }
        }

        // Marcar todas las notificaciones como leídas
        async function markAllNotificationsAsRead() {
            try {
                const unreadNotifications = currentNotifications.filter(notification => !notification.read);

                if (unreadNotifications.length === 0) return;

                const unreadIds = unreadNotifications.map(notification => notification.id);

                const { error } = await supabaseClient
                    .from(TABLES.NOTIFICATIONS)
                    .update({ read: true })
                    .in('id', unreadIds);

                if (error) throw error;

                // Actualizar estado local
                currentNotifications = currentNotifications.map(notification => ({
                    ...notification,
                    read: true
                }));

                // Actualizar UI
                updateNotificationCount();
                renderNotificationPanel();

                if (currentPage === 'notifications') {
                    renderNotificationsView();
                }

                showToast('Todas las notificaciones marcadas como leídas.', 'success');
            } catch (error) {
                console.error('Error marcando notificaciones como leídas:', error);
                showToast('Error al marcar notificaciones como leídas.', 'error');
            }
        }

        // Configurar suscripción en tiempo real
        function setupRealTimeSubscription() {
            // Cerrar suscripción anterior si existe
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
            }

            // Suscribirse a notificaciones
            subscription = supabaseClient
                .channel('notifications-channel')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: TABLES.NOTIFICATIONS,
                        filter: `user_id=eq.${currentUser.id}`
                    },
                    handleNotificationChange)
                .subscribe();
        }

        // Manejar cambios en notificaciones
        async function handleNotificationChange(payload) {
            if (payload.eventType === 'INSERT') {
                // Nueva notificación
                const newNotification = payload.new;

                // Añadir a la lista local
                currentNotifications = [newNotification, ...currentNotifications];

                // Actualizar UI
                updateNotificationCount();

                if (notificationPanel.style.display === 'block') {
                    renderNotificationPanel();
                }

                if (currentPage === 'notifications') {
                    renderNotificationsView();
                }

                // Reproducir sonido y mostrar toast
                playNotificationSound();
                showToast(`Nueva notificación: ${newNotification.title}`, 'info');
            } else if (payload.eventType === 'UPDATE') {
                // Actualizar notificación existente
                const updatedNotification = payload.new;

                // Actualizar en la lista local
                currentNotifications = currentNotifications.map(notification =>
                    notification.id === updatedNotification.id ? updatedNotification : notification
                );

                // Actualizar UI
                updateNotificationCount();

                if (notificationPanel.style.display === 'block') {
                    renderNotificationPanel();
                }

                if (currentPage === 'notifications') {
                    renderNotificationsView();
                }
            } else if (payload.eventType === 'DELETE') {
                // Eliminar notificación
                const deletedNotificationId = payload.old.id;

                // Eliminar de la lista local
                currentNotifications = currentNotifications.filter(notification =>
                    notification.id !== deletedNotificationId
                );

                // Actualizar UI
                updateNotificationCount();

                if (notificationPanel.style.display === 'block') {
                    renderNotificationPanel();
                }

                if (currentPage === 'notifications') {
                    renderNotificationsView();
                }
            }
        }

        // Llenar selects de usuarios
        function populateUserSelects(selectElement) {
            selectElement.innerHTML = '';

            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.nombre_completo} (${user.cargo})`;
                selectElement.appendChild(option);
            });
        }

        // ===================================================================================
        // 6. FUNCIONES DE RENDERIZADO DE VISTAS
        // ===================================================================================

        // Renderizar Dashboard
        async function renderDashboard() {
            try {
                // Cargar datos necesarios
                const tasks = await fetchTasks();
                const meetings = await fetchMeetings();
                const inspections = await fetchInspections();

                // Estadísticas de tareas
                const totalTasks = tasks.assigned.length;
                const pendingTasks = tasks.assigned.filter(task => task.status !== 'Completada').length;
                const completedTasks = totalTasks - pendingTasks;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                // Estadísticas de levantamientos
                const totalInspections = inspections.all.length;
                const pendingInspections = inspections.all.filter(inspection => inspection.status !== 'Completado').length;
                const completedInspections = totalInspections - pendingInspections;

                // Actualizar contadores
                document.getElementById('pending-tasks-count').textContent = pendingTasks;
                document.getElementById('completed-tasks-count').textContent = completedTasks;
                document.getElementById('inspections-count').textContent = totalInspections;
                document.getElementById('inspections-pending').textContent = pendingInspections;
                document.getElementById('inspections-completed').textContent = completedInspections;

                // Actualizar barra de progreso
                document.getElementById('tasks-progress-bar').style.width = `${completionRate}%`;
                document.getElementById('tasks-progress-text').textContent = `${completionRate}% completado`;

                // Próxima reunión
                const upcomingMeetings = meetings.upcoming;
                if (upcomingMeetings.length > 0) {
                    const nextMeeting = upcomingMeetings[0];
                    document.getElementById('next-meeting').textContent = nextMeeting.title;
                    document.getElementById('next-meeting-time').innerHTML = `<i class="far fa-clock mr-1"></i> ${nextMeeting.date} ${nextMeeting.time}`;
                } else {
                    document.getElementById('next-meeting').textContent = 'Sin reuniones programadas';
                    document.getElementById('next-meeting-time').innerHTML = '<i class="far fa-clock mr-1"></i> --:--';
                }

                // Renderizar mini calendario
                renderMiniCalendar();

                // Renderizar actividades recientes
                renderActivities();

                // Renderizar tareas recientes
                renderDashboardTasks(tasks.assigned);

                // Renderizar próximos eventos
                renderUpcomingEvents(upcomingMeetings);

                // Renderizar miembros del equipo
                renderTeamMembers();

                // Renderizar gráfico de completitud de tareas
                renderTaskCompletionChart(completedTasks, pendingTasks);
            } catch (error) {
                console.error('Error renderizando dashboard:', error);
                showToast('Error al cargar el dashboard.', 'error');
            }
        }

        // Renderizar mini calendario
        function renderMiniCalendar() {
            const calendarEl = document.getElementById('mini-calendar');

            if (miniCalendar) {
                miniCalendar.destroy();
            }

            miniCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'today'
                },
                locale: 'es',
                buttonText: {
                    today: 'Hoy'
                },
                dayMaxEvents: 1,
                eventDisplay: 'block',
                eventSources: [
                    {
                        events: async function (info, successCallback, failureCallback) {
                            try {
                                // Cargar tareas y reuniones
                                const tasks = await fetchTasks();
                                const meetings = await fetchMeetings();

                                // Convertir tareas a eventos
                                const taskEvents = tasks.assigned.map(task => ({
                                    id: `task-${task.id}`,
                                    title: task.title,
                                    start: task.due_date || new Date(),
                                    backgroundColor: '#0ea5e9',
                                    borderColor: '#0ea5e9',
                                    textColor: '#ffffff',
                                    extendedProps: {
                                        type: 'task',
                                        status: task.status
                                    }
                                }));

                                // Convertir reuniones a eventos
                                const meetingEvents = meetings.upcoming.map(meeting => ({
                                    id: `meeting-${meeting.id}`,
                                    title: meeting.title,
                                    start: `${meeting.date}T${meeting.time}`,
                                    backgroundColor: '#f59e0b',
                                    borderColor: '#f59e0b',
                                    textColor: '#ffffff',
                                    extendedProps: {
                                        type: 'meeting'
                                    }
                                }));

                                // Combinar eventos
                                const allEvents = [...taskEvents, ...meetingEvents];
                                successCallback(allEvents);
                            } catch (error) {
                                console.error('Error cargando eventos del calendario:', error);
                                failureCallback(error);
                            }
                        }
                    }
                ],
                eventClick: function (info) {
                    const eventType = info.event.extendedProps.type;
                    const eventId = info.event.id.split('-')[1];

                    if (eventType === 'task') {
                        showView('taskDetail');
                        renderTaskDetail(eventId);
                    } else if (eventType === 'meeting') {
                        showView('meetings');
                        // TODO: Implementar detalle de reunión
                    }
                }
            });

            miniCalendar.render();
        }

        // Renderizar actividades recientes
        async function renderActivities() {
            const container = document.getElementById('activities-list');
            container.innerHTML = '';

            try {
                // Obtener las últimas 10 notificaciones
                const recentNotifications = currentNotifications.slice(0, 10);

                if (recentNotifications.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center py-6 text-gray-500">
                            <p>No hay actividades recientes.</p>
                        </div>
                    `;
                    return;
                }

                recentNotifications.forEach((notification, index) => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'flex items-start animate-fade-in';
                    activityItem.style.animationDelay = `${index * 0.1}s`;

                    let iconClass = 'fa-bell';
                    let iconColor = 'text-blue-500';
                    let bgColor = 'bg-blue-100';

                    // Determinar ícono según el tipo
                    switch (notification.type) {
                        case 'task':
                            iconClass = 'fa-list-check';
                            iconColor = 'text-primary-600';
                            bgColor = 'bg-primary-100';
                            break;
                        case 'meeting':
                            iconClass = 'fa-users-rectangle';
                            iconColor = 'text-yellow-600';
                            bgColor = 'bg-yellow-100';
                            break;
                        case 'inspection':
                            iconClass = 'fa-clipboard-check';
                            iconColor = 'text-purple-600';
                            bgColor = 'bg-purple-100';
                            break;
                        case 'comment':
                            iconClass = 'fa-comment';
                            iconColor = 'text-green-600';
                            bgColor = 'bg-green-100';
                            break;
                        case 'user':
                            iconClass = 'fa-user';
                            iconColor = 'text-indigo-600';
                            bgColor = 'bg-indigo-100';
                            break;
                    }

                    activityItem.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full ${bgColor} flex items-center justify-center">
                                <i class="fas ${iconClass} ${iconColor}"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-900">${notification.title}</p>
                            <p class="text-sm text-gray-500">${notification.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${formatDate(notification.created_at)}</p>
                        </div>
                    `;

                    container.appendChild(activityItem);
                });
            } catch (error) {
                console.error('Error renderizando actividades:', error);
                container.innerHTML = `
                    <div class="flex items-center justify-center py-6 text-red-500">
                        <p>Error al cargar actividades recientes.</p>
                    </div>
                `;
            }
        }

        // Renderizar tareas en el dashboard
        function renderDashboardTasks(tasks) {
            const container = document.getElementById('dashboard-tasks-list');
            container.innerHTML = '';

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-6 text-gray-500">
                        <p>No tienes tareas asignadas.</p>
                    </div>
                `;
                return;
            }

            // Ordenar por estado y fecha
            const sortedTasks = [...tasks].sort((a, b) => {
                // Prioridad por estado
                const statusOrder = {
                    'Pendiente': 1,
                    'En Progreso': 2,
                    'En Revisión': 3,
                    'Completada': 4
                };

                // Primero ordenar por estado
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }

                // Luego por fecha de creación (más reciente primero)
                return new Date(b.created_at) - new Date(a.created_at);
            });

            // Mostrar máximo 5 tareas
            const displayTasks = sortedTasks.slice(0, 5);

            displayTasks.forEach((task, index) => {
                const taskCard = document.createElement('div');
                taskCard.className = 'bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer animate-slide-in-up';
                taskCard.style.animationDelay = `${index * 0.1}s`;
                taskCard.setAttribute('data-task-id', task.id);

                taskCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-medium text-gray-900 text-sm line-clamp-1">${task.title}</h3>
                            <p class="text-xs text-gray-500 mt-1 line-clamp-2">${task.description || 'Sin descripción'}</p>
                        </div>
                        ${createStatusBadge(task.status)}
                    </div>
                    <div class="flex justify-between items-center mt-4 text-xs text-gray-500">
                        <div>
                            <i class="fas fa-user-circle mr-1"></i> ${task.creator ? task.creator.nombre_completo : 'Desconocido'}
                        </div>
                        <div>
                            <i class="far fa-clock mr-1"></i> ${formatDate(task.created_at, false)}
                        </div>
                    </div>
                `;

                taskCard.addEventListener('click', () => {
                    showView('taskDetail');
                    renderTaskDetail(task.id);
                });

                container.appendChild(taskCard);
            });

            // Si hay más tareas, mostrar enlace para ver todas
            if (sortedTasks.length > 5) {
                const viewAllLink = document.createElement('div');
                viewAllLink.className = 'text-center mt-4';
                viewAllLink.innerHTML = `
                    <a href="#" class="text-sm text-primary-600 hover:text-primary-800">
                        Ver todas las tareas (${sortedTasks.length})
                    </a>
                `;

                viewAllLink.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    showView('tasks');
                    renderTasks();
                });

                container.appendChild(viewAllLink);
            }
        }

        // Renderizar próximos eventos
        function renderUpcomingEvents(meetings) {
            const container = document.getElementById('upcoming-events');
            container.innerHTML = '';

            if (!meetings || meetings.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-6 text-gray-500">
                        <p>No hay eventos próximos.</p>
                    </div>
                `;
                return;
            }

            // Mostrar máximo 5 eventos
            const displayMeetings = meetings.slice(0, 5);

            displayMeetings.forEach((meeting, index) => {
                const eventItem = document.createElement('div');
                eventItem.className = 'flex items-start animate-fade-in';
                eventItem.style.animationDelay = `${index * 0.1}s`;

                const meetingDate = new Date(`${meeting.date}T${meeting.time}`);
                const formattedDate = meetingDate.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'short'
                });
                const formattedTime = meetingDate.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                eventItem.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-yellow-100 rounded-lg flex flex-col items-center justify-center">
                        <span class="text-xs font-medium text-yellow-800">${formattedDate.split(' ')[1]}</span>
                        <span class="text-sm font-bold text-yellow-800">${formattedDate.split(' ')[0]}</span>
                    </div>
                    <div class="ml-3 flex-1">
                        <h4 class="text-sm font-medium text-gray-900 line-clamp-1">${meeting.title}</h4>
                        <p class="text-xs text-gray-500">
                            <i class="far fa-clock mr-1"></i> ${formattedTime}
                            ${meeting.location ? `<span class="mx-1">•</span><i class="fas fa-map-marker-alt mr-1"></i> ${meeting.location}` : ''}
                        </p>
                    </div>
                `;

                container.appendChild(eventItem);
            });
        }

        // Renderizar miembros del equipo
        async function renderTeamMembers() {
            const container = document.getElementById('team-members');
            container.innerHTML = '';

            if (!allUsers || allUsers.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-6 text-gray-500">
                        <p>No hay miembros en el equipo.</p>
                    </div>
                `;
                return;
            }

            // Filtrar por terminal del usuario actual
            const teamMembers = allUsers.filter(user =>
                user.terminal === currentUser.terminal
            );

            // Mostrar máximo 5 miembros
            const displayMembers = teamMembers.slice(0, 5);

            displayMembers.forEach((user, index) => {
                const userItem = document.createElement('div');
                userItem.className = 'flex items-center animate-fade-in';
                userItem.style.animationDelay = `${index * 0.1}s`;

                userItem.innerHTML = `
                    <div class="flex-shrink-0">
                        ${createAvatar(user, 'w-8 h-8 text-sm')}
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-900">${user.nombre_completo}</p>
                        <p class="text-xs text-gray-500">${user.cargo}</p>
                    </div>
                `;

                container.appendChild(userItem);
            });

            // Si hay más miembros, mostrar enlace para ver todos
            if (teamMembers.length > 5) {
                const viewAllLink = document.createElement('div');
                viewAllLink.className = 'text-center mt-4';
                viewAllLink.innerHTML = `
                    <a href="#" class="text-sm text-primary-600 hover:text-primary-800">
                        Ver todos los miembros (${teamMembers.length})
                    </a>
                `;

                viewAllLink.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    showView('team');
                    renderTeam();
                });

                container.appendChild(viewAllLink);
            }
        }

        // Renderizar gráfico de completitud de tareas
        function renderTaskCompletionChart(completed, pending) {
            const canvas = document.getElementById('tasks-completion-chart');

            if (charts.tasksCompletion) {
                charts.tasksCompletion.destroy();
            }

            if (completed === 0 && pending === 0) {
                canvas.style.display = 'none';
                return;
            }

            canvas.style.display = 'block';

            charts.tasksCompletion = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Completadas', 'Pendientes'],
                    datasets: [{
                        data: [completed, pending],
                        backgroundColor: ['#22c55e', '#94a3b8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Renderizar vista de tareas
        async function renderTasks() {
            try {
                // Mostrar loader
                document.getElementById('tasks-grid').innerHTML = `
                    <div class="flex justify-center col-span-full py-8">
                        <div class="loader"></div>
                    </div>
                `;
                document.getElementById('created-tasks-grid').innerHTML = `
                    <div class="flex justify-center col-span-full py-8">
                        <div class="loader"></div>
                    </div>
                `;
                document.getElementById('all-tasks-grid').innerHTML = `
                    <div class="flex justify-center col-span-full py-8">
                        <div class="loader"></div>
                    </div>
                `;

                // Cargar tareas
                const tasks = await fetchTasks();

                // Renderizar las diferentes secciones
                renderTasksGrid(tasks.assigned, 'tasks-grid');
                renderTasksGrid(tasks.created, 'created-tasks-grid');
                renderTasksGrid(tasks.all, 'all-tasks-grid');

                // Configurar eventos de búsqueda y filtrado
                setupTaskSearch();
            } catch (error) {
                console.error('Error renderizando tareas:', error);
                showToast('Error al cargar tareas.', 'error');
            }
        }

        // Renderizar grilla de tareas
        function renderTasksGrid(tasks, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-gray-500">
                        <i class="fas fa-tasks text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">No hay tareas para mostrar</p>
                        <p class="text-sm mt-1">Las tareas que crees o te asignen aparecerán aquí.</p>
                    </div>
                `;
                return;
            }

            // Ordenar por estado y fecha
            const sortedTasks = [...tasks].sort((a, b) => {
                // Prioridad por estado
                const statusOrder = {
                    'Pendiente': 1,
                    'En Progreso': 2,
                    'En Revisión': 3,
                    'Completada': 4
                };

                // Primero ordenar por estado
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }

                // Luego por fecha de creación (más reciente primero)
                return new Date(b.created_at) - new Date(a.created_at);
            });

            sortedTasks.forEach((task, index) => {
                const taskCard = document.createElement('div');
                taskCard.className = 'card p-5 animate-slide-in-up task-card';
                taskCard.style.animationDelay = `${index * 0.05}s`;
                taskCard.setAttribute('data-task-id', task.id);
                taskCard.setAttribute('data-task-status', task.status);
                taskCard.setAttribute('data-task-title', task.title);

                // Calcular fecha límite o duración
                let dateInfo = '';
                if (task.due_date) {
                    const dueDate = new Date(task.due_date);
                    const now = new Date();
                    const diff = Math.round((dueDate - now) / (1000 * 60 * 60 * 24)); // días de diferencia

                    if (diff < 0) {
                        dateInfo = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i> Vencida hace ${Math.abs(diff)} días</span>`;
                    } else if (diff === 0) {
                        dateInfo = `<span class="text-amber-600"><i class="fas fa-clock mr-1"></i> Vence hoy</span>`;
                    } else if (diff <= 3) {
                        dateInfo = `<span class="text-amber-600"><i class="fas fa-clock mr-1"></i> Vence en ${diff} días</span>`;
                    } else {
                        dateInfo = `<span class="text-gray-600"><i class="far fa-calendar-alt mr-1"></i> Vence el ${formatDate(task.due_date, false)}</span>`;
                    }
                } else {
                    const created = new Date(task.created_at);
                    const now = new Date();
                    const diff = Math.round((now - created) / (1000 * 60 * 60 * 24)); // días desde creación

                    if (diff === 0) {
                        dateInfo = `<span class="text-gray-600"><i class="fas fa-clock mr-1"></i> Creada hoy</span>`;
                    } else {
                        dateInfo = `<span class="text-gray-600"><i class="fas fa-clock mr-1"></i> Creada hace ${diff} ${diff === 1 ? 'día' : 'días'}</span>`;
                    }
                }

                taskCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-medium text-gray-800 text-lg line-clamp-1">${task.title}</h3>
                        ${createStatusBadge(task.status)}
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-5 line-clamp-2">${task.description || 'Sin descripción'}</p>
                    
                    <div class="flex justify-between items-center text-xs">
                        <div>
                            ${dateInfo}
                        </div>
                        <div class="flex items-center">
                            <span class="mr-2"><i class="fas fa-user mr-1"></i> ${task.creator ? task.creator.nombre_completo : 'Desconocido'}</span>
                        </div>
                    </div>
                `;

                taskCard.addEventListener('click', () => {
                    showView('taskDetail');
                    renderTaskDetail(task.id);
                });

                container.appendChild(taskCard);
            });
        }

        // Configurar búsqueda y filtrado de tareas
        function setupTaskSearch() {
            const searchInput = document.getElementById('task-search');
            const filterSelect = document.getElementById('task-filter');

            const filterTasks = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filterValue = filterSelect.value;

                document.querySelectorAll('.task-card').forEach(card => {
                    const title = card.getAttribute('data-task-title').toLowerCase();
                    const status = card.getAttribute('data-task-status');

                    const matchesSearch = title.includes(searchTerm);
                    const matchesFilter = filterValue === 'all' ||
                        (filterValue === 'pending' && status === 'Pendiente') ||
                        (filterValue === 'in-progress' && status === 'En Progreso') ||
                        (filterValue === 'in-review' && status === 'En Revisión') ||
                        (filterValue === 'completed' && status === 'Completada');

                    if (matchesSearch && matchesFilter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            };

            searchInput.addEventListener('input', filterTasks);
            filterSelect.addEventListener('change', filterTasks);
        }

        // Configurar eventos específicos de la vista de tareas
        function setupTasksView() {
            // Ir a todas las tareas desde el dashboard
            document.getElementById('view-all-tasks').addEventListener('click', (e) => {
                e.preventDefault();
                showView('tasks');
                renderTasks();
            });
        }

        // Renderizar detalle de tarea
        async function renderTaskDetail(taskId) {
            try {
                // Mostrar loader
                document.getElementById('task-detail-view').innerHTML = `
                    <div class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                `;

                // Obtener detalle de la tarea
                const { data: task, error } = await supabaseClient
                    .from(TABLES.TASKS)
                    .select(`
                        *,
                        creator:${TABLES.USERS}!creator_id(id, nombre_completo, cargo),
                        assignees:${TABLES.TASK_ASSIGNEES}!task_id(
                            user:${TABLES.USERS}!user_id(id, nombre_completo, cargo)
                        ),
                        comments:${TABLES.TASK_COMMENTS}!task_id(
                            *,
                            author:${TABLES.USERS}!user_id(id, nombre_completo, cargo)
                        ),
                        files:${TABLES.TASK_FILES}!task_id(*)
                    `)
                    .eq('id', taskId)
                    .single();

                if (error) throw error;

                if (task.leader) {
                    const leaderElement = document.createElement('div');
                    leaderElement.className = 'mb-6';
                    leaderElement.innerHTML = `
        <p class="text-xs text-gray-500 mb-1">Líder a cargo</p>
        <div class="flex items-center">
            ${createAvatar(task.leader, 'w-8 h-8 text-sm')}
            <span class="ml-2 text-sm font-medium">${task.leader.nombre_completo}</span>
        </div>
    `;
                    document.getElementById('task-detail-info-container').appendChild(leaderElement);
                }

                // Además, añade la fecha de entrega donde muestras las fechas
                if (task.due_date) {
                    const dueDateElement = document.createElement('div');
                    dueDateElement.innerHTML = `
        <p class="text-xs text-gray-500">Fecha de entrega</p>
        <p class="text-sm">${formatDate(task.due_date, false)}</p>
    `;
                    document.getElementById('task-dates-container').appendChild(dueDateElement);
                }

                // Volver a la vista original
                document.getElementById('task-detail-view').innerHTML = document.getElementById('task-detail-view').innerHTML = `
                    <button id="back-to-tasks" class="mb-6 flex items-center text-primary-600 hover:text-primary-800 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Volver a Tareas</span>
                    </button>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card p-6">
                                <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6">
                                    <div>
                                        <div class="flex items-center">
                                            <h2 id="task-detail-title" class="text-2xl font-bold text-gray-800"></h2>
                                            <span id="task-detail-status" class="ml-3 status-badge"></span>
                                        </div>
                                        <p id="task-detail-date" class="text-sm text-gray-500 mt-1"></p>
                                    </div>
                                    <div class="mt-4 md:mt-0 flex space-x-2">
                                        <div id="task-detail-actions" class="dropdown">
                                            <button class="p-2 text-gray-600 hover:bg-gray-100 rounded-md">
                                                <i class="fas fa-ellipsis-vertical"></i>
                                            </button>
                                            <div class="dropdown-menu p-2 right-0 mt-1 z-50">
                                                <button id="edit-task-btn" class="admin-only w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                                                    <i class="fas fa-edit mr-2 text-gray-500"></i> Editar Tarea
                                                </button>
                                                <button id="delete-task-btn" class="admin-only w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded-md">
                                                    <i class="fas fa-trash-alt mr-2"></i> Eliminar Tarea
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Descripción</h3>
                                    <p id="task-detail-description" class="text-gray-600 whitespace-pre-line"></p>
                                </div>
                                
                                <div class="mb-6" id="task-detail-link-container">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Enlace</h3>
                                    <a id="task-detail-link" href="#" target="_blank" class="text-primary-600 hover:text-primary-800 break-all"></a>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Avance</h3>
                                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div id="task-detail-progress" class="h-full bg-primary-500" style="width: 0%"></div>
                                    </div>
                                    <div class="flex justify-between mt-1">
                                        <span id="task-detail-progress-text" class="text-xs text-gray-500">0%</span>
                                        <div>
                                            <select id="task-status-update" class="text-xs text-gray-700 border border-gray-300 rounded-md">
                                                <option value="Pendiente">Pendiente</option>
                                                <option value="En Progreso">En Progreso</option>
                                                <option value="En Revisión">En Revisión</option>
                                                <option value="Completada">Completada</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-2">
                                        <h3 class="text-sm font-medium text-gray-700">Archivos Adjuntos</h3>
                                        <button id="upload-file-btn" class="text-xs text-primary-600 hover:text-primary-800 flex items-center">
                                            <i class="fas fa-upload mr-1"></i>
                                            <span>Subir Archivo</span>
                                        </button>
                                    </div>
                                    <div id="file-upload-form" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                                        <form id="file-form" class="flex flex-col space-y-3">
                                            <div>
                                                <label for="file-upload" class="text-xs font-medium text-gray-700">Seleccionar archivo</label>
                                                <input type="file" id="file-upload" class="mt-1 text-sm" accept=".xlsx,.xls,.doc,.docx,.pdf,.jpg,.jpeg,.png">
                                            </div>
                                            <div>
                                                <label for="file-description" class="text-xs font-medium text-gray-700">Descripción (opcional)</label>
                                                <input type="text" id="file-description" class="mt-1 text-sm">
                                            </div>
                                            <div class="flex justify-end space-x-2">
                                                <button type="button" id="cancel-file-upload" class="px-3 py-1 text-xs text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                                    Cancelar
                                                </button>
                                                <button type="submit" class="px-3 py-1 text-xs text-white bg-primary-600 rounded-md hover:bg-primary-700">
                                                    Subir
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    <div id="task-files" class="border rounded-md divide-y"></div>
                                </div>
                                
                                <div>
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">Comentarios</h3>
                                    <div id="task-comments" class="space-y-4 max-h-96 overflow-y-auto mb-4"></div>
                                    <form id="comment-form" class="flex space-x-2">
                                        <input type="text" id="comment-input" placeholder="Añadir un comentario..." class="flex-1 focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md">
                                        <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md flex items-center justify-center transition duration-150 ease-in-out">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-1">
                            <div class="card p-6 mb-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Información</h3>
                                
                                <div class="mb-6">
                                    <p class="text-xs text-gray-500 mb-1">Creador</p>
                                    <div id="task-creator" class="flex items-center">
                                        <div class="avatar w-8 h-8 text-sm">JS</div>
                                        <span class="ml-2 text-sm font-medium"></span>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <p class="text-xs text-gray-500 mb-1">Asignado a</p>
                                    <div id="task-assignees" class="flex flex-wrap"></div>
                                </div>
                                
                                <div class="mb-4">
                                    <p class="text-xs text-gray-500 mb-1">Fechas</p>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <p class="text-xs text-gray-500">Creación</p>
                                            <p id="task-created-date" class="text-sm"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Última actualización</p>
                                            <p id="task-updated-date" class="text-sm"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card p-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-4">Historial de Actividad</h3>
                                <div id="task-activity-timeline" class="timeline"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Llenar los datos de la tarea
                document.getElementById('task-detail-title').textContent = task.title;
                document.getElementById('task-detail-description').textContent = task.description || 'Sin descripción';
                document.getElementById('task-detail-date').textContent = `Creada el ${formatDate(task.created_at, false)}`;
                document.getElementById('task-detail-status').innerHTML = createStatusBadge(task.status);
                document.getElementById('task-status-update').value = task.status;

                // Enlace
                if (task.link_url) {
                    document.getElementById('task-detail-link').href = task.link_url;
                    document.getElementById('task-detail-link').textContent = task.link_url;
                } else {
                    document.getElementById('task-detail-link-container').style.display = 'none';
                }

                // Progreso según estado
                let progress = 0;
                switch (task.status) {
                    case 'Pendiente': progress = 0; break;
                    case 'En Progreso': progress = 33; break;
                    case 'En Revisión': progress = 66; break;
                    case 'Completada': progress = 100; break;
                }

                document.getElementById('task-detail-progress').style.width = `${progress}%`;
                document.getElementById('task-detail-progress-text').textContent = `${progress}%`;

                // Información del creador
                const creatorElement = document.getElementById('task-creator');
                if (task.creator) {
                    creatorElement.innerHTML = `
                        ${createAvatar(task.creator, 'w-8 h-8 text-sm')}
                        <span class="ml-2 text-sm font-medium">${task.creator.nombre_completo}</span>
                    `;
                }

                // Asignados
                const assigneesElement = document.getElementById('task-assignees');
                if (task.assignees && task.assignees.length > 0) {
                    task.assignees.forEach(assignee => {
                        const user = assignee.user;
                        const assigneeItem = document.createElement('div');
                        assigneeItem.className = 'flex items-center mr-4 mb-2';
                        assigneeItem.innerHTML = `
                            ${createAvatar(user, 'w-7 h-7 text-xs')}
                            <span class="ml-2 text-xs">${user.nombre_completo}</span>
                        `;
                        assigneesElement.appendChild(assigneeItem);
                    });
                } else {
                    assigneesElement.innerHTML = '<p class="text-xs text-gray-500">No hay asignados</p>';
                }

                // Fechas
                document.getElementById('task-created-date').textContent = formatDate(task.created_at, false);
                document.getElementById('task-updated-date').textContent = formatDate(task.updated_at || task.created_at, false);

                // Archivos
                const filesElement = document.getElementById('task-files');
                if (task.files && task.files.length > 0) {
                    task.files.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'p-3 hover:bg-gray-50';

                        // Determinar icono según tipo de archivo
                        let fileIcon = 'fa-file';

                        if (file.file_name) {
                            const extension = file.file_name.split('.').pop().toLowerCase();

                            if (['xls', 'xlsx', 'csv'].includes(extension)) {
                                fileIcon = 'fa-file-excel';
                            } else if (['doc', 'docx'].includes(extension)) {
                                fileIcon = 'fa-file-word';
                            } else if (['pdf'].includes(extension)) {
                                fileIcon = 'fa-file-pdf';
                            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
                                fileIcon = 'fa-file-image';
                            }
                        }

                        fileItem.innerHTML = `
                            <div class="flex items-center">
                                <div class="text-gray-500 mr-3">
                                    <i class="far ${fileIcon} text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800 line-clamp-1">${file.file_name}</p>
                                    <p class="text-xs text-gray-500">${formatDate(file.created_at)}</p>
                                </div>
                                <button class="download-file-btn p-2 text-gray-500 hover:text-primary-600 hover:bg-gray-100 rounded-full" data-file-path="${file.file_path}" data-file-name="${file.file_name}">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        `;

                        filesElement.appendChild(fileItem);
                    });
                } else {
                    filesElement.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            <p class="text-sm">No hay archivos adjuntos</p>
                        </div>
                    `;
                }

                // Comentarios
                const commentsElement = document.getElementById('task-comments');
                if (task.comments && task.comments.length > 0) {
                    task.comments.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)).forEach(comment => {
                        const commentItem = document.createElement('div');
                        commentItem.className = 'flex items-start';

                        const isCurrentUser = comment.author.id === currentUser.id;

                        commentItem.innerHTML = `
                            <div class="flex-shrink-0 mr-3">
                                ${createAvatar(comment.author, 'w-8 h-8 text-sm')}
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-lg p-3 relative">
                                <div class="flex justify-between">
                                    <p class="text-sm font-medium">${comment.author.nombre_completo}</p>
                                    <p class="text-xs text-gray-500">${formatDate(comment.created_at)}</p>
                                </div>
                                <p class="text-sm mt-1">${comment.comment_text}</p>
                            </div>
                        `;

                        commentsElement.appendChild(commentItem);
                    });
                } else {
                    commentsElement.innerHTML = `
                        <div class="text-center text-gray-500 py-6">
                            <p class="text-sm">No hay comentarios aún</p>
                            <p class="text-xs mt-1">Sé el primero en comentar</p>
                        </div>
                    `;
                }

                // Historial de actividad
                const timelineElement = document.getElementById('task-activity-timeline');

                // Añadir evento de creación
                const timelineItems = [
                    {
                        text: `${task.creator ? task.creator.nombre_completo : 'Usuario'} creó esta tarea`,
                        date: task.created_at
                    }
                ];

                // Añadir comentarios al timeline
                if (task.comments && task.comments.length > 0) {
                    task.comments.forEach(comment => {
                        timelineItems.push({
                            text: `${comment.author.nombre_completo} comentó en la tarea`,
                            date: comment.created_at
                        });
                    });
                }

                // Añadir archivos al timeline
                if (task.files && task.files.length > 0) {
                    task.files.forEach(file => {
                        const user = allUsers.find(u => u.id === file.user_id);
                        timelineItems.push({
                            text: `${user ? user.nombre_completo : 'Usuario'} subió un archivo: ${file.file_name}`,
                            date: file.created_at
                        });
                    });
                }

                // Ordenar timeline por fecha
                timelineItems.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Renderizar timeline
                timelineItems.forEach(item => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    timelineItem.innerHTML = `
                        <p class="text-sm">${item.text}</p>
                        <p class="text-xs text-gray-500 mt-1">${formatDate(item.date)}</p>
                    `;
                    timelineElement.appendChild(timelineItem);
                });

                // Configurar eventos
                setupTaskDetailEvents(task);
            } catch (error) {
                console.error('Error renderizando detalle de tarea:', error);
                showToast('Error al cargar el detalle de la tarea.', 'error');
                showView('tasks');
            }
        }

        // Configurar eventos para el detalle de tarea
        function setupTaskDetailEvents(task) {
            // Volver a la lista de tareas
            document.getElementById('back-to-tasks').addEventListener('click', () => {
                showView('tasks');
                renderTasks();
            });

            // Actualizar estado de la tarea
            document.getElementById('task-status-update').addEventListener('change', async (e) => {
                const newStatus = e.target.value;

                try {
                    const { error } = await supabaseClient
                        .from(TABLES.TASKS)
                        .update({ status: newStatus, updated_at: new Date().toISOString() })
                        .eq('id', task.id);

                    if (error) throw error;

                    // Actualizar UI
                    document.getElementById('task-detail-status').innerHTML = createStatusBadge(newStatus);

                    // Actualizar progreso
                    let progress = 0;
                    switch (newStatus) {
                        case 'Pendiente': progress = 0; break;
                        case 'En Progreso': progress = 33; break;
                        case 'En Revisión': progress = 66; break;
                        case 'Completada': progress = 100; break;
                    }

                    document.getElementById('task-detail-progress').style.width = `${progress}%`;
                    document.getElementById('task-detail-progress-text').textContent = `${progress}%`;

                    // Actualizar fecha de modificación
                    document.getElementById('task-updated-date').textContent = formatDate(new Date(), false);

                    // Notificar al creador y asignados
                    if (task.creator && task.creator.id !== currentUser.id) {
                        await createNotification(
                            task.creator.id,
                            `Tarea actualizada: ${task.title}`,
                            `${currentUser.nombre_completo} cambió el estado de la tarea a "${newStatus}"`,
                            'task',
                            task.id
                        );
                    }

                    if (task.assignees) {
                        task.assignees.forEach(async assignee => {
                            if (assignee.user.id !== currentUser.id) {
                                await createNotification(
                                    assignee.user.id,
                                    `Tarea actualizada: ${task.title}`,
                                    `${currentUser.nombre_completo} cambió el estado de la tarea a "${newStatus}"`,
                                    'task',
                                    task.id
                                );
                            }
                        });
                    }

                    showToast('Estado de la tarea actualizado.', 'success');
                } catch (error) {
                    console.error('Error actualizando estado de tarea:', error);
                    showToast('Error al actualizar el estado.', 'error');
                    // Restaurar valor anterior
                    e.target.value = task.status;
                }
            });

            // Mostrar/ocultar formulario de subida de archivos
            document.getElementById('upload-file-btn').addEventListener('click', () => {
                const fileForm = document.getElementById('file-upload-form');
                fileForm.classList.toggle('hidden');
            });

            document.getElementById('cancel-file-upload').addEventListener('click', () => {
                document.getElementById('file-upload-form').classList.add('hidden');
                document.getElementById('file-form').reset();
            });

            // Subir archivo
            document.getElementById('file-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const fileInput = document.getElementById('file-upload');
                const descriptionInput = document.getElementById('file-description');

                if (!fileInput.files || fileInput.files.length === 0) {
                    showToast('Por favor, selecciona un archivo.', 'warning');
                    return;
                }

                const file = fileInput.files[0];
                const description = descriptionInput.value;

                try {
                    // Mostrar loader
                    const submitBtn = e.target.querySelector('[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    submitBtn.disabled = true;

                    // Subir archivo a storage
                    const filePath = `${currentUser.id}/${task.id}/${Date.now()}-${file.name}`;
                    const { data, error: uploadError } = await supabaseClient.storage
                        .from('task-files')
                        .upload(filePath, file);

                    if (uploadError) throw uploadError;

                    // Registrar archivo en la base de datos
                    const { error: dbError } = await supabaseClient
                        .from(TABLES.TASK_FILES)
                        .insert({
                            task_id: task.id,
                            user_id: currentUser.id,
                            file_path: filePath,
                            file_name: file.name,
                            file_description: description,
                            created_at: new Date().toISOString()
                        });

                    if (dbError) throw dbError;

                    // Actualizar fecha de modificación de la tarea
                    await supabaseClient
                        .from(TABLES.TASKS)
                        .update({ updated_at: new Date().toISOString() })
                        .eq('id', task.id);

                    // Notificar al creador y asignados
                    if (task.creator && task.creator.id !== currentUser.id) {
                        await createNotification(
                            task.creator.id,
                            `Nuevo archivo en tarea: ${task.title}`,
                            `${currentUser.nombre_completo} subió un archivo: ${file.name}`,
                            'task',
                            task.id
                        );
                    }

                    if (task.assignees) {
                        task.assignees.forEach(async assignee => {
                            if (assignee.user.id !== currentUser.id) {
                                await createNotification(
                                    assignee.user.id,
                                    `Nuevo archivo en tarea: ${task.title}`,
                                    `${currentUser.nombre_completo} subió un archivo: ${file.name}`,
                                    'task',
                                    task.id
                                );
                            }
                        });
                    }

                    showToast('Archivo subido correctamente.', 'success');

                    // Ocultar formulario y resetear
                    document.getElementById('file-upload-form').classList.add('hidden');
                    document.getElementById('file-form').reset();

                    // Refrescar detalle para mostrar el nuevo archivo
                    renderTaskDetail(task.id);
                } catch (error) {
                    console.error('Error subiendo archivo:', error);
                    showToast('Error al subir el archivo.', 'error');

                    // Restaurar botón
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                }
            });

            // Descargar archivo
            document.querySelectorAll('.download-file-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const filePath = button.getAttribute('data-file-path');
                    const fileName = button.getAttribute('data-file-name');

                    try {
                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                        const { data, error } = await supabaseClient.storage
                            .from('task-files')
                            .download(filePath);

                        if (error) throw error;

                        // Crear URL para descarga
                        const url = URL.createObjectURL(data);

                        // Crear elemento de descarga
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();

                        // Limpiar
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);

                        button.innerHTML = '<i class="fas fa-download"></i>';
                    } catch (error) {
                        console.error('Error descargando archivo:', error);
                        showToast('Error al descargar el archivo.', 'error');
                        button.innerHTML = '<i class="fas fa-download"></i>';
                    }
                });
            });

            // Enviar comentario
            document.getElementById('comment-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const commentInput = document.getElementById('comment-input');
                const commentText = commentInput.value.trim();

                if (!commentText) return;

                try {
                    const { error } = await supabaseClient
                        .from(TABLES.TASK_COMMENTS)
                        .insert({
                            task_id: task.id,
                            user_id: currentUser.id,
                            comment_text: commentText,
                            created_at: new Date().toISOString()
                        });

                    if (error) throw error;

                    // Actualizar fecha de modificación de la tarea
                    await supabaseClient
                        .from(TABLES.TASKS)
                        .update({ updated_at: new Date().toISOString() })
                        .eq('id', task.id);

                    // Notificar al creador y asignados
                    if (task.creator && task.creator.id !== currentUser.id) {
                        await createNotification(
                            task.creator.id,
                            `Nuevo comentario en tarea: ${task.title}`,
                            `${currentUser.nombre_completo} comentó: "${commentText.substring(0, 50)}${commentText.length > 50 ? '...' : ''}"`,
                            'comment',
                            task.id
                        );
                    }

                    if (task.assignees) {
                        task.assignees.forEach(async assignee => {
                            if (assignee.user.id !== currentUser.id) {
                                await createNotification(
                                    assignee.user.id,
                                    `Nuevo comentario en tarea: ${task.title}`,
                                    `${currentUser.nombre_completo} comentó: "${commentText.substring(0, 50)}${commentText.length > 50 ? '...' : ''}"`,
                                    'comment',
                                    task.id
                                );
                            }
                        });
                    }

                    // Limpiar input
                    commentInput.value = '';

                    // Refrescar detalle para mostrar el nuevo comentario
                    renderTaskDetail(task.id);
                } catch (error) {
                    console.error('Error enviando comentario:', error);
                    showToast('Error al enviar el comentario.', 'error');
                }
            });

            // Editar tarea (solo para admin o creador)
            if (isAdmin() || task.creator.id === currentUser.id) {
                const editTaskBtn = document.getElementById('edit-task-btn');
                if (editTaskBtn) {
                    editTaskBtn.addEventListener('click', () => {
                        document.getElementById('task-id').value = task.id;
                        document.getElementById('task-title').value = task.title;
                        document.getElementById('task-description').value = task.description || '';
                        document.getElementById('task-status').value = task.status;
                        document.getElementById('task-link').value = task.link_url || '';

                        // Seleccionar líder
                        const leaderSelect = document.getElementById('task-leader');
                        populateUserSelects(leaderSelect);
                        if (task.leader) {
                            leaderSelect.value = task.leader.id;
                        }
                        populateUserSelectsByRole();

                        // Seleccionar asignados
                        const assigneesSelect = document.getElementById('task-assignees');
                        populateUserSelects(assigneesSelect);

                        if (task.assignees) {
                            const assigneeIds = task.assignees.map(a => a.user.id);
                            Array.from(assigneesSelect.options).forEach(option => {
                                option.selected = assigneeIds.includes(option.value);
                            });
                        }

                        document.getElementById('task-modal-title').textContent = 'Editar Tarea';
                        openModal(taskModal);
                    });
                }

                // Eliminar tarea
                const deleteTaskBtn = document.getElementById('delete-task-btn');
                if (deleteTaskBtn) {
                    deleteTaskBtn.addEventListener('click', () => {
                        deleteConfirmationModal.setAttribute('data-type', 'task');
                        deleteConfirmationModal.setAttribute('data-id', task.id);
                        document.getElementById('delete-confirmation-title').textContent = '¿Eliminar tarea?';
                        document.getElementById('delete-confirmation-message').textContent = `¿Estás seguro de que deseas eliminar la tarea "${task.title}"? Esta acción no se puede deshacer.`;
                        openModal(deleteConfirmationModal);
                    });
                }
            }
        }

       // ⏺ Manejar envío del formulario de tarea
async function handleTaskFormSubmit(e) {
    e.preventDefault();

    // 1. Captura de campos
    const form        = e.target;
    const taskId      = form.querySelector('#task-id').value;
    const title       = form.querySelector('#task-title').value.trim();
    const description = form.querySelector('#task-description').value.trim();
    const status      = form.querySelector('#task-status').value;
    const link        = form.querySelector('#task-link').value.trim();
    const dueDate     = form.querySelector('#task-due-date')?.value || null;
    const leaderId    = form.querySelector('#task-leader')?.value || null;
    const notifyAll   = form.querySelector('#task-notify')?.checked || false;

    // Opciones múltiple
    const assigneesSelect = document.getElementById('task-assignees');
    const selectedAssignees = Array.from(assigneesSelect.options)
        .filter(opt => opt.selected)
        .map(opt => opt.value);

    try {
        const now = new Date().toISOString();

        if (taskId) {
            // ─── 2A. ACTUALIZAR TAREA EXISTENTE ───────────────────────────────────
            let { error: updateError } = await supabaseClient
                .from('Group_Red_Tasks')
                .update({
                    title,
                    description,
                    status,
                    link_url: link,
                    due_date: dueDate,
                    leader_id: leaderId,
                    updated_at: now
                })
                .eq('id', taskId);

            if (updateError) throw updateError;

            // ─── 3A. REFRESCAR ASIGNADOS ───────────────────────────────────────────
            await supabaseClient
                .from('Group_Red_Task_Assignees')
                .delete()
                .eq('task_id', taskId);

            if (selectedAssignees.length) {
                const rows = selectedAssignees.map(userId => ({
                    task_id: taskId,
                    user_id: userId
                }));
                const { error: assigneesError } = await supabaseClient
                    .from('Group_Red_Task_Assignees')
                    .insert(rows);
                if (assigneesError) throw assigneesError;
            }

            showToast('Tarea actualizada correctamente.', 'success');

        } else {
            // ─── 2B. CREAR NUEVA TAREA ─────────────────────────────────────────────
            const { data: newTask, error: insertError } = await supabaseClient
                .from('Group_Red_Tasks')
                .insert({
                    title,
                    description,
                    status,
                    link_url: link,
                    due_date: dueDate,
                    leader_id: leaderId,
                    creator_id: currentUser.id,
                    created_at: now,
                    updated_at: now
                })
                .select()
                .single();

            if (insertError) throw insertError;
            const newTaskId = newTask.id;

            // ─── 3B. ASIGNAR USUARIOS ──────────────────────────────────────────────
            if (selectedAssignees.length) {
                const rows = selectedAssignees.map(userId => ({
                    task_id: newTaskId,
                    user_id: userId
                }));
                const { error: assigneesError } = await supabaseClient
                    .from('Group_Red_Task_Assignees')
                    .insert(rows);
                if (assigneesError) throw assigneesError;
            }

            // ─── 4. NOTIFICACIONES ────────────────────────────────────────────────
            if (notifyAll) {
                // Al líder
                if (leaderId && leaderId !== currentUser.id) {
                    await createNotification(
                        leaderId,
                        `Nueva tarea asignada: ${title}`,
                        `${currentUser.nombre_completo} te ha puesto como líder`,
                        'task',
                        newTaskId
                    );
                }
                // A los asignados
                for (const userId of selectedAssignees) {
                    if (userId !== currentUser.id) {
                        await createNotification(
                            userId,
                            `Nueva tarea asignada: ${title}`,
                            `${currentUser.nombre_completo} te ha asignado una tarea`,
                            'task',
                            newTaskId
                        );
                    }
                }
            }

            showToast('Tarea creada correctamente.', 'success');
        }

        // ─── 5. Cerrar modal y refrescar ───────────────────────────────────────
        closeModal(taskModal);

        switch (currentPage) {
            case 'tasks':      renderTasks();        break;
            case 'dashboard':  renderDashboard();    break;
            case 'calendar':   renderCalendar();     break;
            case 'taskDetail': renderTaskDetail(taskId || newTask.id); break;
        }

    } catch (error) {
        console.error('Error guardando tarea:', error);
        showToast('Error al guardar la tarea. Revisa la consola.', 'error');
    }
}


        // Eliminar tarea
        async function deleteTask(taskId) {
            try {
                // Primero eliminar registros relacionados
                await supabaseClient
                    .from(TABLES.TASK_ASSIGNEES)
                    .delete()
                    .eq('task_id', taskId);

                await supabaseClient
                    .from(TABLES.TASK_COMMENTS)
                    .delete()
                    .eq('task_id', taskId);

                // Obtener archivos para eliminar del storage
                const { data: files } = await supabaseClient
                    .from(TABLES.TASK_FILES)
                    .select('file_path')
                    .eq('task_id', taskId);

                if (files && files.length > 0) {
                    // Eliminar archivos del storage
                    for (const file of files) {
                        await supabaseClient.storage
                            .from('task-files')
                            .remove([file.file_path]);
                    }

                    // Eliminar registros de archivos
                    await supabaseClient
                        .from(TABLES.TASK_FILES)
                        .delete()
                        .eq('task_id', taskId);
                }

                // Finalmente eliminar la tarea
                const { error } = await supabaseClient
                    .from(TABLES.TASKS)
                    .delete()
                    .eq('id', taskId);

                if (error) throw error;

                return true;
            } catch (error) {
                console.error('Error eliminando tarea:', error);
                return false;
            }
        }

        // Renderizar calendario
        async function renderCalendar() {
            const calendarEl = document.getElementById('main-calendar');

            if (mainCalendar) {
                mainCalendar.destroy();
            }

            mainCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                locale: 'es',
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día'
                },
                eventSources: [
                    {
                        events: async function (info, successCallback, failureCallback) {
                            try {
                                const showTasks = document.querySelector('#task-calendar-view').classList.contains('bg-primary-600');
                                const showMeetings = document.querySelector('#meeting-calendar-view').classList.contains('bg-primary-600');

                                // Cargar tareas y reuniones en paralelo
                                const [tasks, meetings] = await Promise.all([fetchTasks(), fetchMeetings()]);

                                let events = [];

                                // Convertir tareas a eventos (omitimos completadas)
                                if (showTasks) {
                                    const allTasks = (tasks.all && tasks.all.length)
                                        ? tasks.all
                                        : [
                                            ...tasks.assigned,
                                            ...tasks.created.filter(task => !tasks.assigned.some(t => t.id === task.id))
                                        ];

                                    events = events.concat(
                                        allTasks
                                            .filter(task => task.status !== 'Completada')
                                            .map(task => ({
                                                id: `task-${task.id}`,
                                                title: task.title,
                                                start: task.due_date || task.created_at,
                                                backgroundColor: getStatusColor(task.status),
                                                borderColor: getStatusColor(task.status),
                                                textColor: '#ffffff',
                                                extendedProps: {
                                                    type: 'task',
                                                    description: task.description,
                                                    status: task.status,
                                                    creator: task.creator ? task.creator.nombre_completo : 'Desconocido'
                                                }
                                            }))
                                    );
                                }

                                // Convertir reuniones a eventos (solo próximas si están disponibles)
                                if (showMeetings) {
                                    const meetingList = (meetings.all && meetings.all.length)
                                        ? meetings.all
                                        : [...meetings.upcoming, ...meetings.past];

                                    events = events.concat(
                                        meetingList.map(meeting => {
                                            const start = `${meeting.date}T${meeting.time}`;
                                            const end = meeting.duration
                                                ? new Date(new Date(start).getTime() + meeting.duration * 60000).toISOString()
                                                : undefined;

                                            return {
                                                id: `meeting-${meeting.id}`,
                                                title: meeting.title,
                                                start,
                                                end,
                                                backgroundColor: '#f59e0b',
                                                borderColor: '#f59e0b',
                                                textColor: '#ffffff',
                                                extendedProps: {
                                                    type: 'meeting',
                                                    description: meeting.description,
                                                    location: meeting.location,
                                                    creator: meeting.creator ? meeting.creator.nombre_completo : 'Desconocido'
                                                }
                                            };
                                        })
                                    );
                                }

                                successCallback(events);
                            } catch (error) {
                                console.error('Error cargando eventos del calendario:', error);
                                failureCallback(error);
                            }
                        }
                    }
                ],
                eventClick: function (info) {
                    const eventType = info.event.extendedProps.type;
                    const eventId = info.event.id.split('-')[1];

                    if (eventType === 'task') {
                        showView('taskDetail');
                        renderTaskDetail(eventId);
                    } else if (eventType === 'meeting') {
                        // Mostrar detalles de la reunión con SweetAlert2
                        Swal.fire({
                            title: info.event.title,
                            html: `
                                <div class="text-left">
                                    <p class="mb-2"><strong>Descripción:</strong> ${info.event.extendedProps.description || 'Sin descripción'}</p>
                                    <p class="mb-2"><strong>Fecha:</strong> ${formatDate(info.event.start, true)}</p>
                                    ${info.event.extendedProps.location ? `<p class="mb-2"><strong>Ubicación:</strong> ${info.event.extendedProps.location}</p>` : ''}
                                    <p><strong>Organizador:</strong> ${info.event.extendedProps.creator}</p>
                                </div>
                            `,
                            icon: 'info',
                            confirmButtonText: 'Cerrar',
                            confirmButtonColor: '#0ea5e9'
                        });
                    }
                },
                eventDidMount: function (info) {
                    // Tooltip para eventos
                    const title = info.event.title;
                    const type = info.event.extendedProps.type === 'task' ? 'Tarea' : 'Reunión';
                    const status = info.event.extendedProps.status ? `Estado: ${info.event.extendedProps.status}` : '';
                    const description = info.event.extendedProps.description ? info.event.extendedProps.description.substring(0, 50) + (info.event.extendedProps.description.length > 50 ? '...' : '') : '';

                    tippy(info.el, {
                        content: `
                            <div class="p-2">
                                <p class="font-bold">${title}</p>
                                <p>${type}</p>
                                ${status ? `<p>${status}</p>` : ''}
                                ${description ? `<p>${description}</p>` : ''}
                            </div>
                        `,
                        allowHTML: true,
                        theme: 'light',
                        placement: 'top'
                    });
                }
            });

            mainCalendar.render();
        }

        // Obtener color según estado
        function getStatusColor(status) {
            switch (status) {
                case 'Pendiente': return '#f59e0b'; // warning-500
                case 'En Progreso': return '#0ea5e9'; // primary-500
                case 'En Revisión': return '#8b5cf6'; // purple-500
                case 'Completada': return '#22c55e'; // success-500
                default: return '#64748b'; // secondary-500
            }
        }

        // Configurar eventos específicos de la vista de calendario
        function setupCalendarView() {
            const taskBtn = document.getElementById('task-calendar-view');
            const meetingBtn = document.getElementById('meeting-calendar-view');

            taskBtn.addEventListener('click', () => {
                taskBtn.classList.add('bg-primary-600', 'hover:bg-primary-700', 'text-white');
                taskBtn.classList.remove('bg-white', 'hover:bg-gray-100', 'text-gray-800', 'border', 'border-gray-300');

                meetingBtn.classList.remove('bg-primary-600', 'hover:bg-primary-700', 'text-white');
                meetingBtn.classList.add('bg-white', 'hover:bg-gray-100', 'text-gray-800', 'border', 'border-gray-300');

                mainCalendar.refetchEvents();
            });

            meetingBtn.addEventListener('click', () => {
                meetingBtn.classList.add('bg-primary-600', 'hover:bg-primary-700', 'text-white');
                meetingBtn.classList.remove('bg-white', 'hover:bg-gray-100', 'text-gray-800', 'border', 'border-gray-300');

                taskBtn.classList.remove('bg-primary-600', 'hover:bg-primary-700', 'text-white');
                taskBtn.classList.add('bg-white', 'hover:bg-gray-100', 'text-gray-800', 'border', 'border-gray-300');

                mainCalendar.refetchEvents();
            });
        }

        // Renderizar reuniones
        async function renderMeetings() {
            try {
                // Mostrar loader
                document.getElementById('upcoming-meetings-list').innerHTML = `
                    <div class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                `;
                document.getElementById('past-meetings-list').innerHTML = `
                    <div class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                `;
                document.getElementById('all-meetings-list').innerHTML = `
                    <div class="flex justify-center py-8">
                        <div class="loader"></div>
                    </div>
                `;

                // Cargar reuniones
                const meetings = await fetchMeetings();

                // Renderizar mini calendario
                renderMeetingMiniCalendar(meetings);

                // Renderizar próximas reuniones en sidebar
                renderNextMeetings(meetings.upcoming);

                // Renderizar listas de reuniones
                renderMeetingsList(meetings.upcoming, 'upcoming-meetings-list');
                renderMeetingsList(meetings.past, 'past-meetings-list');
                renderMeetingsList(meetings.all, 'all-meetings-list');
            } catch (error) {
                console.error('Error renderizando reuniones:', error);
                showToast('Error al cargar reuniones.', 'error');
            }
        }

        // Renderizar mini calendario para reuniones
        function renderMeetingMiniCalendar(meetings) {
            const calendarEl = document.getElementById('meeting-mini-calendar');

            if (meetingMiniCalendar) {
                meetingMiniCalendar.destroy();
            }

            meetingMiniCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'today'
                },
                locale: 'es',
                buttonText: {
                    today: 'Hoy'
                },
                dayMaxEvents: 1,
                eventDisplay: 'block',
                events: meetings.upcoming.map(meeting => ({
                    id: `meeting-${meeting.id}`,
                    title: meeting.title,
                    start: `${meeting.date}T${meeting.time}`,
                    backgroundColor: '#f59e0b',
                    borderColor: '#f59e0b',
                    textColor: '#ffffff'
                }))
            });

            meetingMiniCalendar.render();
        }

        // Renderizar próximas reuniones en sidebar
        function renderNextMeetings(meetings) {
            const container = document.getElementById('next-meetings-sidebar');
            container.innerHTML = '';

            if (meetings.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p class="text-sm">No hay reuniones programadas</p>
                    </div>
                `;
                return;
            }

            // Mostrar las próximas 3 reuniones
            const nextMeetings = meetings.slice(0, 3);

            nextMeetings.forEach(meeting => {
                const meetingDate = new Date(`${meeting.date}T${meeting.time}`);
                const now = new Date();
                const diffDays = Math.floor((meetingDate - now) / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((meetingDate - now) / (1000 * 60 * 60));

                let timeText = '';
                if (diffDays === 0) {
                    if (diffHours === 0) {
                        timeText = 'En menos de 1 hora';
                    } else if (diffHours === 1) {
                        timeText = 'En 1 hora';
                    } else {
                        timeText = `En ${diffHours} horas`;
                    }
                } else if (diffDays === 1) {
                    timeText = 'Mañana';
                } else {
                    timeText = `En ${diffDays} días`;
                }

                const meetingItem = document.createElement('div');
                meetingItem.className = 'border-l-4 border-yellow-500 pl-3 py-2';

                meetingItem.innerHTML = `
                    <h4 class="text-sm font-medium">${meeting.title}</h4>
                    <p class="text-xs text-gray-500">
                        <i class="far fa-calendar-alt mr-1"></i> ${formatDate(meeting.date, false)}
                        <span class="mx-1">•</span>
                        <i class="far fa-clock mr-1"></i> ${meeting.time.substring(0, 5)}
                    </p>
                    <p class="text-xs text-yellow-600 mt-1">
                        <i class="fas fa-hourglass-half mr-1"></i> ${timeText}
                    </p>
                `;

                container.appendChild(meetingItem);
            });
        }

        // Renderizar listas de reuniones
        function renderMeetingsList(meetings, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (meetings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">No hay reuniones para mostrar</p>
                        <p class="text-sm mt-1">Las reuniones programadas aparecerán aquí.</p>
                    </div>
                `;
                return;
            }

            meetings.forEach((meeting, index) => {
                const meetingItem = document.createElement('div');
                meetingItem.className = 'card p-4 animate-slide-in-up';
                meetingItem.style.animationDelay = `${index * 0.05}s`;

                const meetingDate = new Date(`${meeting.date}T${meeting.time}`);
                const now = new Date();
                const isPast = meetingDate < now;

                const meetingStatus = isPast
                    ? `<span class="status-badge completed"><i class="fas fa-check-circle mr-1"></i> Finalizada</span>`
                    : `<span class="status-badge pending"><i class="fas fa-clock mr-1"></i> Programada</span>`;

                meetingItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 rounded-lg bg-yellow-100 text-yellow-800 flex flex-col items-center justify-center">
                                <span class="text-xs font-medium">${meetingDate.toLocaleDateString('es-ES', { month: 'short' })}</span>
                                <span class="text-base font-bold">${meetingDate.getDate()}</span>
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between">
                                <div>
                                    <h3 class="font-medium text-gray-800">${meeting.title}</h3>
                                    <p class="text-sm text-gray-500 mt-1">${meeting.description || 'Sin descripción'}</p>
                                </div>
                                <div class="mt-2 sm:mt-0">
                                    ${meetingStatus}
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-y-2 gap-x-4 mt-3 text-xs text-gray-600">
                                <div>
                                    <i class="far fa-clock mr-1"></i> ${meeting.time.substring(0, 5)}
                                    ${meeting.duration ? ` (${meeting.duration} min)` : ''}
                                </div>
                                ${meeting.location ? `
                                <div>
                                    <i class="fas fa-map-marker-alt mr-1"></i> ${meeting.location}
                                </div>
                                ` : ''}
                                <div>
                                    <i class="fas fa-user mr-1"></i> ${meeting.creator ? meeting.creator.nombre_completo : 'Desconocido'}
                                </div>
                                ${meeting.link ? `
                                <div>
                                    <a href="${meeting.link}" target="_blank" class="text-primary-600 hover:text-primary-800">
                                        <i class="fas fa-video mr-1"></i> Enlace de reunión
                                    </a>
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex justify-end mt-3">
                                ${!isPast ? `
                                <button class="px-3 py-1 text-xs text-primary-600 hover:text-primary-800 border border-primary-600 rounded-md hover:bg-primary-50 mr-2 join-meeting-btn" data-meeting-id="${meeting.id}" data-meeting-link="${meeting.link || ''}">
                                    <i class="fas fa-sign-in-alt mr-1"></i> Unirse
                                </button>
                                ` : ''}
                                ${isAdmin() || meeting.creator.id === currentUser.id ? `
                                <button class="px-3 py-1 text-xs text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md hover:bg-gray-50 mr-2 edit-meeting-btn" data-meeting-id="${meeting.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="px-3 py-1 text-xs text-red-600 hover:text-red-800 border border-red-600 rounded-md hover:bg-red-50 delete-meeting-btn" data-meeting-id="${meeting.id}">
                                    <i class="fas fa-trash-alt mr-1"></i> Eliminar
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(meetingItem);
            });

            // Configurar botones de acción
            setupMeetingButtons();
        }

        // Configurar botones de reuniones
        function setupMeetingButtons() {
            // Botones de unirse a reunión
            document.querySelectorAll('.join-meeting-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const meetingId = button.getAttribute('data-meeting-id');
                    const meetingLink = button.getAttribute('data-meeting-link');

                    if (meetingLink) {
                        window.open(meetingLink, '_blank');
                    } else {
                        Swal.fire({
                            title: 'Unirse a la reunión',
                            text: 'Esta reunión no tiene un enlace virtual configurado.',
                            icon: 'info',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#0ea5e9'
                        });
                    }
                });
            });

            // Botones de editar reunión
            document.querySelectorAll('.edit-meeting-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const meetingId = button.getAttribute('data-meeting-id');
                    await editMeeting(meetingId);
                });
            });

            // Botones de eliminar reunión
            document.querySelectorAll('.delete-meeting-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const meetingId = button.getAttribute('data-meeting-id');

                    deleteConfirmationModal.setAttribute('data-type', 'meeting');
                    deleteConfirmationModal.setAttribute('data-id', meetingId);
                    document.getElementById('delete-confirmation-title').textContent = '¿Eliminar reunión?';
                    document.getElementById('delete-confirmation-message').textContent = 'Esta acción no se puede deshacer y eliminará la reunión para todos los participantes.';
                    openModal(deleteConfirmationModal);
                });
            });
        }

        // Configurar eventos específicos de la vista de reuniones
        function setupMeetingsView() {
            const searchInput = document.getElementById('meeting-search');

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();

                    document.querySelectorAll('#upcoming-meetings-content .card, #past-meetings-content .card, #all-meetings-content .card').forEach(card => {
                        const title = card.querySelector('h3').textContent.toLowerCase();
                        const description = card.querySelector('p').textContent.toLowerCase();

                        if (title.includes(searchTerm) || description.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Editar reunión
        async function editMeeting(meetingId) {
            try {
                // Obtener datos de la reunión
                const { data: meeting, error } = await supabaseClient
                    .from(TABLES.MEETINGS)
                    .select(`
                        *,
                        attendees:${TABLES.MEETING_ATTENDEES}!meeting_id(
                            user_id
                        )
                    `)
                    .eq('id', meetingId)
                    .single();

                if (error) throw error;

                // Llenar formulario
                document.getElementById('meeting-id').value = meeting.id;
                document.getElementById('meeting-title').value = meeting.title;
                document.getElementById('meeting-description').value = meeting.description || '';
                document.getElementById('meeting-date').value = meeting.date;
                document.getElementById('meeting-time').value = meeting.time;
                document.getElementById('meeting-duration').value = meeting.duration || 60;
                document.getElementById('meeting-location').value = meeting.location || '';
                document.getElementById('meeting-link').value = meeting.link || '';
                document.getElementById('meeting-notify').checked = true;

                // Seleccionar participantes
                const attendeesSelect = document.getElementById('meeting-attendees');
                populateUserSelects(attendeesSelect);

                if (meeting.attendees) {
                    const attendeeIds = meeting.attendees.map(a => a.user_id);
                    Array.from(attendeesSelect.options).forEach(option => {
                        option.selected = attendeeIds.includes(option.value);
                    });
                }

                document.getElementById('meeting-modal-title').textContent = 'Editar Reunión';
                openModal(meetingModal);
            } catch (error) {
                console.error('Error obteniendo datos de la reunión:', error);
                showToast('Error al cargar datos de la reunión.', 'error');
            }
        }

        // Manejar envío del formulario de reunión
        async function handleMeetingFormSubmit(e) {
            e.preventDefault();

            const meetingId = document.getElementById('meeting-id').value;
            const title = document.getElementById('meeting-title').value.trim();
            const description = document.getElementById('meeting-description').value.trim();
            const date = document.getElementById('meeting-date').value;
            const time = document.getElementById('meeting-time').value;
            const duration = document.getElementById('meeting-duration').value;
            const location = document.getElementById('meeting-location').value.trim();
            const link = document.getElementById('meeting-link').value.trim();
            const notify = document.getElementById('meeting-notify').checked;

            const attendeesSelect = document.getElementById('meeting-attendees');
            const selectedAttendees = Array.from(attendeesSelect.selectedOptions).map(option => option.value);

            try {
                const now = new Date().toISOString();

                if (meetingId) {
                    // Actualizar reunión existente
                    const { error: meetingError } = await supabaseClient
                        .from(TABLES.MEETINGS)
                        .update({
                            title,
                            description,
                            date,
                            time,
                            duration,
                            location,
                            link,
                            updated_at: now
                        })
                        .eq('id', meetingId);

                    if (meetingError) throw meetingError;

                    // Actualizar participantes (eliminar todos y agregar los nuevos)
                    await supabaseClient
                        .from(TABLES.MEETING_ATTENDEES)
                        .delete()
                        .eq('meeting_id', meetingId);

                    if (selectedAttendees.length > 0) {
                        const attendeesToInsert = selectedAttendees.map(userId => ({
                            meeting_id: meetingId,
                            user_id: userId
                        }));

                        const { error: attendeesError } = await supabaseClient
                            .from(TABLES.MEETING_ATTENDEES)
                            .insert(attendeesToInsert);

                        if (attendeesError) throw attendeesError;
                    }

                    // Notificar a nuevos participantes
                    if (notify) {
                        selectedAttendees.forEach(async userId => {
                            if (userId !== currentUser.id) {
                                await createNotification(
                                    userId,
                                    `Reunión actualizada: ${title}`,
                                    `${currentUser.nombre_completo} ha actualizado la reunión "${title}" para el ${formatDate(date, false)} a las ${time.substring(0, 5)}`,
                                    'meeting',
                                    meetingId
                                );
                            }
                        });
                    }

                    showToast('Reunión actualizada correctamente.', 'success');
                } else {
                    // Crear nueva reunión
                    const { data: meetingData, error: meetingError } = await supabaseClient
                        .from(TABLES.MEETINGS)
                        .insert({
                            title,
                            description,
                            date,
                            time,
                            duration,
                            location,
                            link,
                            creator_id: currentUser.id,
                            created_at: now,
                            updated_at: now
                        })
                        .select()
                        .single();

                    if (meetingError) throw meetingError;

                    // Agregar participantes
                    if (selectedAttendees.length > 0) {
                        const attendeesToInsert = selectedAttendees.map(userId => ({
                            meeting_id: meetingData.id,
                            user_id: userId
                        }));

                        const { error: attendeesError } = await supabaseClient
                            .from(TABLES.MEETING_ATTENDEES)
                            .insert(attendeesToInsert);

                        if (attendeesError) throw attendeesError;
                    }

                    // Notificar a participantes
                    if (notify) {
                        selectedAttendees.forEach(async userId => {
                            if (userId !== currentUser.id) {
                                await createNotification(
                                    userId,
                                    `Nueva reunión: ${title}`,
                                    `${currentUser.nombre_completo} te ha invitado a una reunión el ${formatDate(date, false)} a las ${time.substring(0, 5)}`,
                                    'meeting',
                                    meetingData.id
                                );
                            }
                        });
                    }

                    showToast('Reunión creada correctamente.', 'success');
                }

                // Cerrar modal y refrescar vista
                closeModal(meetingModal);

                if (currentPage === 'meetings') {
                    renderMeetings();
                } else if (currentPage === 'calendar') {
                    renderCalendar();
                } else if (currentPage === 'dashboard') {
                    renderDashboard();
                }
            } catch (error) {
                console.error('Error guardando reunión:', error);
                showToast('Error al guardar la reunión.', 'error');
            }
        }

        // Eliminar reunión
        async function deleteMeeting(meetingId) {
            try {
                // Primero eliminar participantes
                await supabaseClient
                    .from(TABLES.MEETING_ATTENDEES)
                    .delete()
                    .eq('meeting_id', meetingId);

                // Luego eliminar la reunión
                const { error } = await supabaseClient
                    .from(TABLES.MEETINGS)
                    .delete()
                    .eq('id', meetingId);

                if (error) throw error;

                return true;
            } catch (error) {
                console.error('Error eliminando reunión:', error);
                return false;
            }
        }

        // Renderizar levantamientos
        async function renderInspections() {
            try {
                // Obtener datos de levantamientos
                const inspections = await fetchInspections();

                // Renderizar tabla de levantamientos
                renderInspectionsTable(inspections.all);
            } catch (error) {
                console.error('Error renderizando levantamientos:', error);
                showToast('Error al cargar levantamientos.', 'error');
            }
        }

        // Renderizar tabla de levantamientos
        function renderInspectionsTable(inspections) {
            const tbody = document.getElementById('inspections-list');
            tbody.innerHTML = '';

            if (inspections.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-clipboard-list text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg font-medium">No hay levantamientos registrados</p>
                            <p class="text-sm mt-1">Los levantamientos que realices aparecerán aquí.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Ordenar por fecha (más reciente primero)
            const sortedInspections = [...inspections].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            sortedInspections.forEach(inspection => {
                const tr = document.createElement('tr');

                // Determinar icono según tipo
                let iconClass = '';
                let iconColor = '';

                switch (inspection.type) {
                    case 'extintor':
                        iconClass = 'fa-fire-extinguisher';
                        iconColor = 'text-red-600';
                        break;
                    case 'odometro':
                        iconClass = 'fa-gauge-high';
                        iconColor = 'text-blue-600';
                        break;
                    case 'luminaria':
                        iconClass = 'fa-lightbulb';
                        iconColor = 'text-yellow-600';
                        break;
                    case 'wifi':
                        iconClass = 'fa-wifi';
                        iconColor = 'text-green-600';
                        break;
                    case 'publicidad':
                        iconClass = 'fa-rectangle-ad';
                        iconColor = 'text-purple-600';
                        break;
                    case 'normas-graficas':
                        iconClass = 'fa-ruler-combined';
                        iconColor = 'text-indigo-600';
                        break;
                    case 'limpiaparabrisas':
                        iconClass = 'fa-car-side';
                        iconColor = 'text-teal-600';
                        break;
                    case 'grabado-vidrios':
                        iconClass = 'fa-glasses';
                        iconColor = 'text-cyan-600';
                        break;
                    case 'control-combustible':
                        iconClass = 'fa-gas-pump';
                        iconColor = 'text-amber-600';
                        break;
                    case 'rack':
                        iconClass = 'fa-server';
                        iconColor = 'text-orange-600';
                        break;
                    case 'movileye':
                        iconClass = 'fa-eye';
                        iconColor = 'text-sky-600';
                        break;
                    case 'srl':
                        iconClass = 'fa-shield-halved';
                        iconColor = 'text-emerald-600';
                        break;
                    default:
                        iconClass = 'fa-clipboard-check';
                        iconColor = 'text-gray-600';
                }

                // Obtener nombre formateado del tipo
                const typeNames = {
                    'extintor': 'Extintor',
                    'odometro': 'Odómetro',
                    'luminaria': 'Luminaria',
                    'wifi': 'WiFi',
                    'publicidad': 'Publicidad',
                    'normas-graficas': 'Normas Gráficas',
                    'limpiaparabrisas': 'Limpiaparabrisas',
                    'grabado-vidrios': 'Grabado Vidrios',
                    'control-combustible': 'Control Combustible',
                    'rack': 'Rack',
                    'movileye': 'Movileye',
                    'srl': 'SRL'
                };

                const typeName = typeNames[inspection.type] || inspection.type;

                // Determinar clase de estado
                let statusClass = '';
                switch (inspection.status) {
                    case 'Pendiente':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        break;
                    case 'En Proceso':
                        statusClass = 'bg-blue-100 text-blue-800';
                        break;
                    case 'Completado':
                        statusClass = 'bg-green-100 text-green-800';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                }

                tr.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fas ${iconClass} ${iconColor}"></i>
                            </div>
                            <span>${typeName}</span>
                        </div>
                    </td>
                    <td class="p-3">${formatDate(inspection.created_at, false)}</td>
                    <td class="p-3">
                        <div class="flex items-center">
                            ${inspection.creator ? createAvatar(inspection.creator, 'w-7 h-7 text-xs mr-2') : ''}
                            <span>${inspection.creator ? inspection.creator.nombre_completo : 'Desconocido'}</span>
                        </div>
                    </td>
                    <td class="p-3">${inspection.location || '-'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${inspection.status}</span>
                    </td>
                    <td class="p-3">
                        <div class="flex items-center space-x-2">
                            <button class="view-inspection-btn p-2 text-primary-600 hover:bg-primary-50 rounded-full" data-inspection-id="${inspection.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${isAdmin() || inspection.creator.id === currentUser.id ? `
                            <button class="edit-inspection-btn p-2 text-gray-600 hover:bg-gray-100 rounded-full" data-inspection-id="${inspection.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-inspection-btn p-2 text-red-600 hover:bg-red-50 rounded-full" data-inspection-id="${inspection.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            // Configurar botones de acción
            setupInspectionButtons();
        }

        // Configurar botones de levantamientos
        function setupInspectionButtons() {
            // Ver detalle
            document.querySelectorAll('.view-inspection-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const inspectionId = button.getAttribute('data-inspection-id');
                    await showInspectionDetail(inspectionId);
                });
            });

            // Editar
            document.querySelectorAll('.edit-inspection-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const inspectionId = button.getAttribute('data-inspection-id');
                    await editInspection(inspectionId);
                });
            });

            // Eliminar
            document.querySelectorAll('.delete-inspection-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const inspectionId = button.getAttribute('data-inspection-id');

                    deleteConfirmationModal.setAttribute('data-type', 'inspection');
                    deleteConfirmationModal.setAttribute('data-id', inspectionId);
                    document.getElementById('delete-confirmation-title').textContent = '¿Eliminar levantamiento?';
                    document.getElementById('delete-confirmation-message').textContent = 'Esta acción no se puede deshacer y eliminará permanentemente este levantamiento y todos sus datos asociados.';
                    openModal(deleteConfirmationModal);
                });
            });

            // Tipos de levantamiento
            document.querySelectorAll('.inspection-type-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    e.preventDefault();

                    const type = card.getAttribute('data-inspection-type');
                    document.getElementById('inspection-id').value = '';
                    document.getElementById('inspection-type').value = type;
                    document.getElementById('inspection-category').value = type;
                    document.getElementById('inspection-modal-title').textContent = `Nuevo Levantamiento: ${getInspectionTypeName(type)}`;

                    // Generar campos según el tipo
                    document.getElementById('inspection-category').dispatchEvent(new Event('change'));

                    openModal(inspectionModal);
                });
            });
        }

        // Obtener nombre de tipo de levantamiento
        function getInspectionTypeName(type) {
            const typeNames = {
                'extintor': 'Extintor',
                'odometro': 'Odómetro',
                'luminaria': 'Luminaria',
                'wifi': 'WiFi',
                'publicidad': 'Publicidad',
                'normas-graficas': 'Normas Gráficas',
                'limpiaparabrisas': 'Limpiaparabrisas',
                'grabado-vidrios': 'Grabado Vidrios',
                'control-combustible': 'Control Combustible',
                'rack': 'Rack',
                'movileye': 'Movileye',
                'srl': 'SRL'
            };

            return typeNames[type] || type;
        }

        // Configurar eventos específicos de la vista de levantamientos
        function setupInspectionsView() {
            const searchInput = document.getElementById('inspection-search');

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();

                    document.querySelectorAll('#inspections-list tr').forEach(row => {
                        if (row.querySelector('td[colspan]')) return; // Skip empty message row

                        const type = row.cells[0].textContent.toLowerCase();
                        const responsable = row.cells[2].textContent.toLowerCase();
                        const terminal = row.cells[3].textContent.toLowerCase();

                        if (type.includes(searchTerm) || responsable.includes(searchTerm) || terminal.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Mostrar detalle de levantamiento
        async function showInspectionDetail(inspectionId) {
            try {
                // Obtener datos del levantamiento
                const { data: inspection, error } = await supabaseClient
                    .from(TABLES.INSPECTIONS)
                    .select(`
                        *,
                        creator:${TABLES.USERS}!user_id(id, nombre_completo, cargo),
                        items:${TABLES.INSPECTION_ITEMS}(*),
                        files:${TABLES.INSPECTION_FILES}(*)
                    `)
                    .eq('id', inspectionId)
                    .single();

                if (error) throw error;

                // Preparar contenido del modal
                const typeName = getInspectionTypeName(inspection.type);
                document.getElementById('inspection-detail-title').textContent = `Levantamiento: ${typeName}`;

                // Llenar contenido del modal
                const contentElement = document.getElementById('inspection-detail-content');

                // Determinar icono según tipo
                let iconClass = '';
                let iconColor = '';

                switch (inspection.type) {
                    case 'extintor':
                        iconClass = 'fa-fire-extinguisher';
                        iconColor = 'text-red-600';
                        break;
                    case 'odometro':
                        iconClass = 'fa-gauge-high';
                        iconColor = 'text-blue-600';
                        break;
                    case 'luminaria':
                        iconClass = 'fa-lightbulb';
                        iconColor = 'text-yellow-600';
                        break;
                    case 'wifi':
                        iconClass = 'fa-wifi';
                        iconColor = 'text-green-600';
                        break;
                    case 'publicidad':
                        iconClass = 'fa-rectangle-ad';
                        iconColor = 'text-purple-600';
                        break;
                    case 'normas-graficas':
                        iconClass = 'fa-ruler-combined';
                        iconColor = 'text-indigo-600';
                        break;
                    case 'limpiaparabrisas':
                        iconClass = 'fa-car-side';
                        iconColor = 'text-teal-600';
                        break;
                    case 'grabado-vidrios':
                        iconClass = 'fa-glasses';
                        iconColor = 'text-cyan-600';
                        break;
                    case 'control-combustible':
                        iconClass = 'fa-gas-pump';
                        iconColor = 'text-amber-600';
                        break;
                    case 'rack':
                        iconClass = 'fa-server';
                        iconColor = 'text-orange-600';
                        break;
                    case 'movileye':
                        iconClass = 'fa-eye';
                        iconColor = 'text-sky-600';
                        break;
                    case 'srl':
                        iconClass = 'fa-shield-halved';
                        iconColor = 'text-emerald-600';
                        break;
                    default:
                        iconClass = 'fa-clipboard-check';
                        iconColor = 'text-gray-600';
                }

                // Clase de estado
                let statusClass = '';
                switch (inspection.status) {
                    case 'Pendiente':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        break;
                    case 'En Proceso':
                        statusClass = 'bg-blue-100 text-blue-800';
                        break;
                    case 'Completado':
                        statusClass = 'bg-green-100 text-green-800';
                        break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800';
                }

                // Construir contenido del modal
                let html = `
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mr-4">
                            <i class="fas ${iconClass} ${iconColor} text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-medium">${typeName}</h3>
                            <div class="flex items-center text-sm text-gray-500">
                                <span class="mr-3">${formatDate(inspection.created_at)}</span>
                                <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${inspection.status}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Responsable</h4>
                            <div class="flex items-center">
                                ${inspection.creator ? createAvatar(inspection.creator, 'w-8 h-8 text-sm mr-2') : ''}
                                <span>${inspection.creator ? inspection.creator.nombre_completo : 'Desconocido'}</span>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Ubicación</h4>
                            <p>${inspection.location || '-'}</p>
                        </div>
                    </div>
                `;

                // Añadir detalles específicos según tipo
                if (inspection.items && inspection.items.length > 0) {
                    html += `
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Detalles</h4>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <table class="w-full">
                    `;

                    // Mostrar propiedades de los items
                    inspection.items.forEach(item => {
                        Object.entries(item).forEach(([key, value]) => {
                            if (['id', 'inspection_id', 'created_at'].includes(key)) return;

                            const keyFormatted = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            html += `
                                <tr>
                                    <td class="py-2 text-sm font-medium text-gray-600">${keyFormatted}</td>
                                    <td class="py-2 text-sm">${value}</td>
                                </tr>
                            `;
                        });
                    });

                    html += `
                                </table>
                            </div>
                        </div>
                    `;
                }

                // Añadir observaciones
                if (inspection.notes) {
                    html += `
                        <div class="mb-6">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Observaciones</h4>
                            <p class="text-sm bg-gray-50 p-4 rounded-lg">${inspection.notes}</p>
                        </div>
                    `;
                }

                // Añadir archivos
                if (inspection.files && inspection.files.length > 0) {
                    html += `
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Archivos</h4>
                            <div class="border rounded-lg divide-y">
                    `;

                    inspection.files.forEach(file => {
                        // Determinar icono según tipo de archivo
                        let fileIcon = 'fa-file';

                        if (file.file_name) {
                            const extension = file.file_name.split('.').pop().toLowerCase();

                            if (['xls', 'xlsx', 'csv'].includes(extension)) {
                                fileIcon = 'fa-file-excel';
                            } else if (['doc', 'docx'].includes(extension)) {
                                fileIcon = 'fa-file-word';
                            } else if (['pdf'].includes(extension)) {
                                fileIcon = 'fa-file-pdf';
                            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
                                fileIcon = 'fa-file-image';
                            }
                        }

                        html += `
                            <div class="p-3 hover:bg-gray-50">
                                <div class="flex items-center">
                                    <div class="text-gray-500 mr-3">
                                        <i class="far ${fileIcon} text-lg"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-800 line-clamp-1">${file.file_name || 'Archivo'}</p>
                                        <p class="text-xs text-gray-500">${formatDate(file.created_at)}</p>
                                    </div>
                                    <button class="inspection-download-file-btn p-2 text-gray-500 hover:text-primary-600 hover:bg-gray-100 rounded-full" data-file-path="${file.file_path}" data-file-name="${file.file_name || 'archivo'}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                }

                contentElement.innerHTML = html;

                // Configurar botones de descarga
                document.querySelectorAll('.inspection-download-file-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const filePath = button.getAttribute('data-file-path');
                        const fileName = button.getAttribute('data-file-name');

                        try {
                            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                            const { data, error } = await supabaseClient.storage
                                .from('inspection-files')
                                .download(filePath);

                            if (error) throw error;

                            // Crear URL para descarga
                            const url = URL.createObjectURL(data);

                            // Crear elemento de descarga
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();

                            // Limpiar
                            setTimeout(() => {
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            }, 100);

                            button.innerHTML = '<i class="fas fa-download"></i>';
                        } catch (error) {
                            console.error('Error descargando archivo:', error);
                            showToast('Error al descargar el archivo.', 'error');
                            button.innerHTML = '<i class="fas fa-download"></i>';
                        }
                    });
                });

                // Mostrar modal
                openModal(inspectionDetailModal);
            } catch (error) {
                console.error('Error obteniendo detalle de levantamiento:', error);
                showToast('Error al cargar el detalle del levantamiento.', 'error');
            }
        }

        // Editar levantamiento
        async function editInspection(inspectionId) {
            try {
                // Obtener datos del levantamiento
                const { data: inspection, error } = await supabaseClient
                    .from(TABLES.INSPECTIONS)
                    .select(`
                        *,
                        items:${TABLES.INSPECTION_ITEMS}(*)
                    `)
                    .eq('id', inspectionId)
                    .single();

                if (error) throw error;

                // Llenar formulario
                document.getElementById('inspection-id').value = inspection.id;
                document.getElementById('inspection-type').value = inspection.type;
                document.getElementById('inspection-category').value = inspection.type;
                document.getElementById('inspection-location').value = inspection.location || '';
                document.getElementById('inspection-notes').value = inspection.notes || '';

                // Generar campos según el tipo
                document.getElementById('inspection-category').dispatchEvent(new Event('change'));

                // Llenar campos específicos según los items
                if (inspection.items && inspection.items.length > 0) {
                    const item = inspection.items[0]; // Tomamos el primer item

                    Object.entries(item).forEach(([key, value]) => {
                        if (['id', 'inspection_id', 'created_at'].includes(key)) return;

                        const input = document.getElementById(`${inspection.type}-${key}`);
                        if (input) {
                            input.value = value;
                        }
                    });
                }

                document.getElementById('inspection-modal-title').textContent = `Editar Levantamiento: ${getInspectionTypeName(inspection.type)}`;
                openModal(inspectionModal);
            } catch (error) {
                console.error('Error obteniendo datos del levantamiento:', error);
                showToast('Error al cargar datos del levantamiento.', 'error');
            }
        }

        // Manejar envío del formulario de levantamiento
        async function handleInspectionFormSubmit(e) {
            e.preventDefault();

            const inspectionId = document.getElementById('inspection-id').value;
            const type = document.getElementById('inspection-type').value;
            const location = document.getElementById('inspection-location').value.trim();
            const notes = document.getElementById('inspection-notes').value.trim();
            const fileInput = document.getElementById('inspection-file');

            try {
                const now = new Date().toISOString();

                // Recopilar datos de los campos dinámicos
                const formFields = document.getElementById('inspection-form-fields');
                const inputs = formFields.querySelectorAll('input, select');
                const itemData = {};

                inputs.forEach(input => {
                    // Obtener nombre del campo (eliminar el prefijo del tipo)
                    const fieldName = input.id.replace(`${type}-`, '');
                    itemData[fieldName] = input.value;
                });

                if (inspectionId) {
                    // Actualizar levantamiento existente
                    const { error: inspectionError } = await supabaseClient
                        .from(TABLES.INSPECTIONS)
                        .update({
                            type,
                            location,
                            notes,
                            updated_at: now
                        })
                        .eq('id', inspectionId);

                    if (inspectionError) throw inspectionError;

                    // Actualizar items (eliminar y recrear)
                    await supabaseClient
                        .from(TABLES.INSPECTION_ITEMS)
                        .delete()
                        .eq('inspection_id', inspectionId);

                    const { error: itemError } = await supabaseClient
                        .from(TABLES.INSPECTION_ITEMS)
                        .insert({
                            inspection_id: inspectionId,
                            ...itemData,
                            created_at: now
                        });

                    if (itemError) throw itemError;

                    // Subir archivo si se proporciona
                    if (fileInput.files && fileInput.files.length > 0) {
                        const file = fileInput.files[0];

                        // Subir a storage
                        const filePath = `${currentUser.id}/${inspectionId}/${Date.now()}-${file.name}`;
                        const { error: uploadError } = await supabaseClient.storage
                            .from('inspection-files')
                            .upload(filePath, file);

                        if (uploadError) throw uploadError;

                        // Guardar referencia en la base de datos
                        const { error: fileError } = await supabaseClient
                            .from(TABLES.INSPECTION_FILES)
                            .insert({
                                inspection_id: inspectionId,
                                file_path: filePath,
                                file_name: file.name,
                                created_at: now
                            });

                        if (fileError) throw fileError;
                    }

                    showToast('Levantamiento actualizado correctamente.', 'success');
                } else {
                    // Crear nuevo levantamiento
                    const { data: inspectionData, error: inspectionError } = await supabaseClient
                        .from(TABLES.INSPECTIONS)
                        .insert({
                            type,
                            location,
                            notes,
                            user_id: currentUser.id,
                            status: 'Pendiente',
                            created_at: now,
                            updated_at: now
                        })
                        .select()
                        .single();

                    if (inspectionError) throw inspectionError;

                    // Insertar item con los datos recopilados
                    const { error: itemError } = await supabaseClient
                        .from(TABLES.INSPECTION_ITEMS)
                        .insert({
                            inspection_id: inspectionData.id,
                            ...itemData,
                            created_at: now
                        });

                    if (itemError) throw itemError;

                    // Subir archivo si se proporciona
                    if (fileInput.files && fileInput.files.length > 0) {
                        const file = fileInput.files[0];

                        // Subir a storage
                        const filePath = `${currentUser.id}/${inspectionData.id}/${Date.now()}-${file.name}`;
                        const { error: uploadError } = await supabaseClient.storage
                            .from('inspection-files')
                            .upload(filePath, file);

                        if (uploadError) throw uploadError;

                        // Guardar referencia en la base de datos
                        const { error: fileError } = await supabaseClient
                            .from(TABLES.INSPECTION_FILES)
                            .insert({
                                inspection_id: inspectionData.id,
                                file_path: filePath,
                                file_name: file.name,
                                created_at: now
                            });

                        if (fileError) throw fileError;
                    }

                    // Notificar a supervisores
                    const supervisors = allUsers.filter(user =>
                        user.terminal === currentUser.terminal &&
                        (user.cargo === 'Supervisor' || user.cargo === 'Supervisor Admin' || user.cargo === 'Jefe de Terminal')
                    );

                    supervisors.forEach(async supervisor => {
                        if (supervisor.id !== currentUser.id) {
                            await createNotification(
                                supervisor.id,
                                `Nuevo levantamiento: ${getInspectionTypeName(type)}`,
                                `${currentUser.nombre_completo} ha registrado un nuevo levantamiento en ${location || 'ubicación no especificada'}`,
                                'inspection',
                                inspectionData.id
                            );
                        }
                    });

                    showToast('Levantamiento creado correctamente.', 'success');
                }

                // Cerrar modal y refrescar vista
                closeModal(inspectionModal);

                if (currentPage === 'inspections') {
                    renderInspections();
                } else if (currentPage === 'dashboard') {
                    renderDashboard();
                }
            } catch (error) {
                console.error('Error guardando levantamiento:', error);
                showToast('Error al guardar el levantamiento.', 'error');
            }
        }

        // Eliminar levantamiento
        async function deleteInspection(inspectionId) {
            try {
                // Obtener archivos para eliminar del storage
                const { data: files } = await supabaseClient
                    .from(TABLES.INSPECTION_FILES)
                    .select('file_path')
                    .eq('inspection_id', inspectionId);

                if (files && files.length > 0) {
                    // Eliminar archivos del storage
                    for (const file of files) {
                        await supabaseClient.storage
                            .from('inspection-files')
                            .remove([file.file_path]);
                    }

                    // Eliminar registros de archivos
                    await supabaseClient
                        .from(TABLES.INSPECTION_FILES)
                        .delete()
                        .eq('inspection_id', inspectionId);
                }

                // Eliminar items
                await supabaseClient
                    .from(TABLES.INSPECTION_ITEMS)
                    .delete()
                    .eq('inspection_id', inspectionId);

                // Finalmente eliminar el levantamiento
                const { error } = await supabaseClient
                    .from(TABLES.INSPECTIONS)
                    .delete()
                    .eq('id', inspectionId);

                if (error) throw error;

                return true;
            } catch (error) {
                console.error('Error eliminando levantamiento:', error);
                return false;
            }
        }

        // Renderizar vista de equipo
        async function renderTeam() {
            try {
                // Refrescar lista de usuarios
                await fetchAllUsers();

                // Renderizar tabla de usuarios
                renderTeamTable(allUsers);

                // Renderizar estadísticas
                renderTeamStats(allUsers);
            } catch (error) {
                console.error('Error renderizando equipo:', error);
                showToast('Error al cargar datos del equipo.', 'error');
            }
        }

        // Renderizar tabla de usuarios
        async function renderTeamTable(users) {
            const tbody = document.getElementById('team-list');
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg font-medium">No hay miembros en el equipo</p>
                            <p class="text-sm mt-1">Agrega miembros al equipo usando el botón "Agregar Personal".</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Obtener recuento de tareas asignadas para cada usuario
            const taskCounts = {};

            try {
                const { data, error } = await supabaseClient
                    .from(TABLES.TASK_ASSIGNEES)
                    .select('user_id, task_id');

                if (error) throw error;

                if (data) {
                    data.forEach(assignee => {
                        if (!taskCounts[assignee.user_id]) {
                            taskCounts[assignee.user_id] = 0;
                        }
                        taskCounts[assignee.user_id]++;
                    });
                }
            } catch (error) {
                console.error('Error obteniendo recuento de tareas:', error);
            }

            // Ordenar usuarios por cargo y nombre
            const sortedUsers = [...users].sort((a, b) => {
                // Orden de cargos
                const roleOrder = {
                    'Jefe de Terminal': 1,
                    'Supervisor Admin': 2,
                    'Supervisor': 3,
                    'Inspector': 4
                };

                // Primero ordenar por cargo
                if (roleOrder[a.cargo] !== roleOrder[b.cargo]) {
                    return roleOrder[a.cargo] - roleOrder[b.cargo];
                }

                // Luego por nombre
                return a.nombre_completo.localeCompare(b.nombre_completo);
            });

            sortedUsers.forEach(user => {
                const tr = document.createElement('tr');

                tr.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center">
                            ${createAvatar(user, 'w-8 h-8 text-sm mr-3')}
                            <span class="font-medium">${user.nombre_completo}</span>
                        </div>
                    </td>
                    <td class="p-3">${user.username}</td>
                    <td class="p-3">${user.cargo}</td>
                    <td class="p-3">${user.terminal}</td>
                    <td class="p-3">${taskCounts[user.id] || 0}</td>
                    <td class="p-3">
                        <div class="flex items-center space-x-2">
                            <button class="view-user-tasks-btn p-2 text-primary-600 hover:bg-primary-50 rounded-full" data-user-id="${user.id}" data-user-name="${user.nombre_completo}">
                                <i class="fas fa-tasks"></i>
                            </button>
                            ${isAdmin() ? `
                            <button class="edit-user-btn p-2 text-gray-600 hover:bg-gray-100 rounded-full" data-user-id="${user.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-user-btn p-2 text-red-600 hover:bg-red-50 rounded-full" data-user-id="${user.id}" data-user-name="${user.nombre_completo}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;

                tbody.appendChild(tr);
            });

            // Configurar botones de acción
            setupTeamButtons();
        }

        // Renderizar estadísticas del equipo
        function renderTeamStats(users) {
            // Gráfico de distribución por cargo
            const roleLabels = [];
            const roleData = [];
            const roleColors = [];

            const roles = users.reduce((acc, user) => {
                if (!acc[user.cargo]) {
                    acc[user.cargo] = 0;
                }
                acc[user.cargo]++;
                return acc;
            }, {});

            Object.entries(roles).forEach(([role, count]) => {
                roleLabels.push(role);
                roleData.push(count);

                // Asignar color según rol
                let color = '';
                switch (role) {
                    case 'Jefe de Terminal': color = '#0ea5e9'; break; // primary-500
                    case 'Supervisor Admin': color = '#8b5cf6'; break; // purple-500
                    case 'Supervisor': color = '#22c55e'; break; // green-500
                    case 'Inspector': color = '#f59e0b'; break; // amber-500
                    default: color = '#64748b'; break; // gray-500
                }

                roleColors.push(color);
            });

            if (charts.teamRoles) {
                charts.teamRoles.destroy();
            }

            const roleChartCtx = document.getElementById('team-roles-chart').getContext('2d');
            charts.teamRoles = new Chart(roleChartCtx, {
                type: 'doughnut',
                data: {
                    labels: roleLabels,
                    datasets: [{
                        data: roleData,
                        backgroundColor: roleColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de distribución por terminal
            const terminalLabels = [];
            const terminalData = [];
            const terminalColors = [
                '#0ea5e9', // primary-500
                '#22c55e', // green-500
                '#f59e0b', // amber-500
                '#ef4444', // red-500
                '#8b5cf6', // purple-500
                '#ec4899', // pink-500
                '#14b8a6', // teal-500
            ];

            const terminals = users.reduce((acc, user) => {
                if (!acc[user.terminal]) {
                    acc[user.terminal] = 0;
                }
                acc[user.terminal]++;
                return acc;
            }, {});

            Object.entries(terminals).forEach(([terminal, count], index) => {
                terminalLabels.push(terminal);
                terminalData.push(count);
            });

            if (charts.teamTerminals) {
                charts.teamTerminals.destroy();
            }

            const terminalChartCtx = document.getElementById('team-terminals-chart').getContext('2d');
            charts.teamTerminals = new Chart(terminalChartCtx, {
                type: 'doughnut',
                data: {
                    labels: terminalLabels,
                    datasets: [{
                        data: terminalData,
                        backgroundColor: terminalColors.slice(0, terminalLabels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de productividad simulada
            const userNames = users.slice(0, 10).map(user => user.nombre_completo);
            const productivityData = users.slice(0, 10).map(() => Math.floor(Math.random() * 100));

            if (charts.teamProductivity) {
                charts.teamProductivity.destroy();
            }

            const productivityChartCtx = document.getElementById('team-productivity-chart').getContext('2d');
            charts.teamProductivity = new Chart(productivityChartCtx, {
                type: 'bar',
                data: {
                    labels: userNames,
                    datasets: [{
                        label: 'Tareas completadas',
                        data: productivityData,
                        backgroundColor: '#0ea5e9',
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Configurar botones de equipo
        function setupTeamButtons() {
            // Ver tareas de usuario
            document.querySelectorAll('.view-user-tasks-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const userId = button.getAttribute('data-user-id');
                    const userName = button.getAttribute('data-user-name');

                    try {
                        const { data, error } = await supabaseClient
                            .from(TABLES.TASK_ASSIGNEES)
                            .select(`
                                task:${TABLES.TASKS}!inner(
                                    *,
                                    creator:${TABLES.USERS}!creator_id(nombre_completo)
                                )
                            `)
                            .eq('user_id', userId);

                        if (error) throw error;

                        const tasks = data.map(item => item.task);

                        if (tasks.length === 0) {
                            Swal.fire({
                                title: `Tareas de ${userName}`,
                                text: 'Este usuario no tiene tareas asignadas.',
                                icon: 'info',
                                confirmButtonText: 'Entendido',
                                confirmButtonColor: '#0ea5e9'
                            });
                            return;
                        }

                        // Organizar tareas por estado
                        const tasksByStatus = {
                            'Pendiente': [],
                            'En Progreso': [],
                            'En Revisión': [],
                            'Completada': []
                        };

                        tasks.forEach(task => {
                            if (tasksByStatus[task.status]) {
                                tasksByStatus[task.status].push(task);
                            } else {
                                tasksByStatus['Pendiente'].push(task);
                            }
                        });

                        // Construir contenido HTML
                        let html = `<div class="text-left">`;

                        for (const [status, statusTasks] of Object.entries(tasksByStatus)) {
                            if (statusTasks.length === 0) continue;

                            let statusClass = '';
                            switch (status) {
                                case 'Pendiente': statusClass = 'text-yellow-600'; break;
                                case 'En Progreso': statusClass = 'text-blue-600'; break;
                                case 'En Revisión': statusClass = 'text-purple-600'; break;
                                case 'Completada': statusClass = 'text-green-600'; break;
                            }

                            html += `<h3 class="font-bold mt-3 mb-2 ${statusClass}">${status} (${statusTasks.length})</h3><ul class="space-y-1">`;

                            statusTasks.forEach(task => {
                                html += `
                                    <li class="text-sm">
                                        <span class="font-medium">${task.title}</span>
                                        <span class="text-gray-500 text-xs"> - Creada por ${task.creator.nombre_completo}</span>
                                    </li>
                                `;
                            });

                            html += `</ul>`;
                        }

                        html += `</div>`;

                        Swal.fire({
                            title: `Tareas de ${userName}`,
                            html: html,
                            icon: 'info',
                            confirmButtonText: 'Cerrar',
                            confirmButtonColor: '#0ea5e9',
                            width: '600px'
                        });
                    } catch (error) {
                        console.error('Error obteniendo tareas del usuario:', error);
                        showToast('Error al cargar tareas del usuario.', 'error');
                    }
                });
            });

            // Editar usuario
            document.querySelectorAll('.edit-user-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    const userId = button.getAttribute('data-user-id');
                    await editUser(userId);
                });
            });

            // Eliminar usuario
            document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const userId = button.getAttribute('data-user-id');
                    const userName = button.getAttribute('data-user-name');

                    deleteConfirmationModal.setAttribute('data-type', 'user');
                    deleteConfirmationModal.setAttribute('data-id', userId);
                    document.getElementById('delete-confirmation-title').textContent = '¿Eliminar usuario?';
                    document.getElementById('delete-confirmation-message').textContent = `¿Estás seguro de que deseas eliminar a ${userName}? Esta acción no se puede deshacer.`;
                    openModal(deleteConfirmationModal);
                });
            });
        }

        // Configurar eventos específicos de la vista de equipo
        function setupTeamView() {
            const searchInput = document.getElementById('team-search');

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();

                    document.querySelectorAll('#team-list tr').forEach(row => {
                        if (row.querySelector('td[colspan]')) return; // Skip empty message row

                        const name = row.cells[0].textContent.toLowerCase();
                        const username = row.cells[1].textContent.toLowerCase();
                        const cargo = row.cells[2].textContent.toLowerCase();
                        const terminal = row.cells[3].textContent.toLowerCase();

                        if (name.includes(searchTerm) || username.includes(searchTerm) ||
                            cargo.includes(searchTerm) || terminal.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Editar usuario
        async function editUser(userId) {
            try {
                // Buscar usuario en la lista local
                const user = allUsers.find(u => u.id === userId);

                if (!user) {
                    throw new Error('Usuario no encontrado');
                }

                // Llenar formulario
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-fullname').value = user.nombre_completo;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-role').value = user.cargo;
                document.getElementById('user-terminal').value = user.terminal;

                // Ocultar campo de contraseña en edición
                document.getElementById('password-field').style.display = 'none';

                document.getElementById('user-modal-title').textContent = 'Editar Usuario';
                openModal(userModal);
            } catch (error) {
                console.error('Error obteniendo datos del usuario:', error);
                showToast('Error al cargar datos del usuario.', 'error');
            }
        }

        // Manejar envío del formulario de usuario
        async function handleUserFormSubmit(e) {
            e.preventDefault();

            const userId = document.getElementById('user-id').value;
            const fullname = document.getElementById('user-fullname').value.trim();
            const username = document.getElementById('user-username').value.trim();
            const role = document.getElementById('user-role').value;
            const terminal = document.getElementById('user-terminal').value.trim();

            // Validaciones
            if (!fullname || !username || !role || !terminal) {
                document.getElementById('user-form-error').textContent = 'Todos los campos son obligatorios.';
                return;
            }

            try {
                const now = new Date().toISOString();

                if (userId) {
                    // Actualizar usuario existente
                    const { error } = await supabaseClient
                        .from(TABLES.USERS)
                        .update({
                            nombre_completo: fullname,
                            username: username,
                            cargo: role,
                            terminal: terminal,
                            updated_at: now
                        })
                        .eq('id', userId);

                    if (error) {
                        if (error.code === '23505') { // Unique constraint violation
                            document.getElementById('user-form-error').textContent = 'El nombre de usuario ya está en uso.';
                            return;
                        }
                        throw error;
                    }

                    showToast('Usuario actualizado correctamente.', 'success');
                } else {
                    // Crear nuevo usuario
                    const password = document.getElementById('user-password').value;

                    if (!password) {
                        document.getElementById('user-form-error').textContent = 'La contraseña es obligatoria.';
                        return;
                    }

                    const { error } = await supabaseClient
                        .from(TABLES.USERS)
                        .insert({
                            nombre_completo: fullname,
                            username: username,
                            password: password,
                            cargo: role,
                            terminal: terminal,
                            created_at: now,
                            updated_at: now
                        });

                    if (error) {
                        if (error.code === '23505') { // Unique constraint violation
                            document.getElementById('user-form-error').textContent = 'El nombre de usuario ya está en uso.';
                            return;
                        }
                        throw error;
                    }

                    showToast('Usuario creado correctamente.', 'success');
                }

                // Cerrar modal y refrescar vista
                closeModal(userModal);
                await renderTeam();
            } catch (error) {
                console.error('Error guardando usuario:', error);
                document.getElementById('user-form-error').textContent = 'Error al guardar el usuario.';
            }
        }

        // Eliminar usuario
        async function deleteUser(userId) {
            try {
                // Verificar que no sea el usuario actual
                if (userId === currentUser.id) {
                    showToast('No puedes eliminarte a ti mismo.', 'error');
                    return false;
                }

                // Eliminar asignaciones de tareas
                await supabaseClient
                    .from(TABLES.TASK_ASSIGNEES)
                    .delete()
                    .eq('user_id', userId);

                // Eliminar asistencia a reuniones
                await supabaseClient
                    .from(TABLES.MEETING_ATTENDEES)
                    .delete()
                    .eq('user_id', userId);

                // Eliminar notificaciones
                await supabaseClient
                    .from(TABLES.NOTIFICATIONS)
                    .delete()
                    .eq('user_id', userId);

                // Finalmente eliminar el usuario
                const { error } = await supabaseClient
                    .from(TABLES.USERS)
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                return true;
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                return false;
            }
        }

        // Renderizar vista de informes
        async function renderReports() {
            try {
                // Obtener datos necesarios
                const tasks = await fetchTasks();
                const inspections = await fetchInspections();

                // Calcular estadísticas
                const totalTasks = tasks.all.length;
                const completedTasks = tasks.all.filter(task => task.status === 'Completada').length;
                const inProgressTasks = tasks.all.filter(task => task.status === 'En Progreso' || task.status === 'En Revisión').length;
                const totalInspections = inspections.all.length;

                // Actualizar contadores
                document.getElementById('report-total-tasks').textContent = totalTasks;
                document.getElementById('report-completed-tasks').textContent = completedTasks;
                document.getElementById('report-in-progress-tasks').textContent = inProgressTasks;
                document.getElementById('report-inspections').textContent = totalInspections;

                // Esperar al siguiente ciclo de renderizado para asegurar tamaños correctos
                await new Promise(requestAnimationFrame);

                // Renderizar gráficos
                renderTasksStatusChart(tasks.all);
                renderTasksTrendChart(tasks.all);
                renderInspectionsTypeChart(inspections.all);
                renderTerminalProductivityChart();
                renderTopMembers();
            } catch (error) {
                console.error('Error renderizando informes:', error);
                showToast('Error al cargar datos para informes.', 'error');
            }
        }

        // Renderizar gráfico de estado de tareas
        function renderTasksStatusChart(tasks) {
            // Contar tareas por estado
            const taskCounts = {
                'Pendiente': 0,
                'En Progreso': 0,
                'En Revisión': 0,
                'Completada': 0
            };

            tasks.forEach(task => {
                if (taskCounts[task.status] !== undefined) {
                    taskCounts[task.status]++;
                } else {
                    taskCounts['Pendiente']++;
                }
            });

            // Preparar datos para el gráfico
            const labels = Object.keys(taskCounts);
            const data = Object.values(taskCounts);
            const colors = [
                '#f59e0b', // Pendiente
                '#0ea5e9', // En Progreso
                '#8b5cf6', // En Revisión
                '#22c55e'  // Completada
            ];

            if (charts.tasksStatus) {
                charts.tasksStatus.destroy();
            }

            const ctx = document.getElementById('tasks-status-chart').getContext('2d');
            charts.tasksStatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Renderizar gráfico de tendencia de tareas
        function renderTasksTrendChart(tasks) {
            // Agrupar tareas por fecha (últimos 30 días)
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Crear array de fechas para los últimos 30 días
            const dateLabels = [];
            const createdData = [];
            const completedData = [];

            for (let i = 0; i < 30; i++) {
                const date = new Date(thirtyDaysAgo.getTime() + i * 24 * 60 * 60 * 1000);
                const dateString = date.toISOString().split('T')[0];
                dateLabels.push(dateString);
                createdData.push(0);
                completedData.push(0);
            }

            // Contar tareas creadas y completadas por día
            tasks.forEach(task => {
                const createdDate = task.created_at.split('T')[0];
                const createdIndex = dateLabels.indexOf(createdDate);

                if (createdIndex !== -1) {
                    createdData[createdIndex]++;
                }

                if (task.status === 'Completada' && task.updated_at) {
                    const completedDate = task.updated_at.split('T')[0];
                    const completedIndex = dateLabels.indexOf(completedDate);

                    if (completedIndex !== -1) {
                        completedData[completedIndex]++;
                    }
                }
            });

            // Formatear fechas para mostrar
            const formattedLabels = dateLabels.map(date => {
                const [year, month, day] = date.split('-');
                return `${day}/${month}`;
            });

            if (charts.tasksTrend) {
                charts.tasksTrend.destroy();
            }

            const ctx = document.getElementById('tasks-trend-chart').getContext('2d');
            charts.tasksTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [
                        {
                            label: 'Tareas Creadas',
                            data: createdData,
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Tareas Completadas',
                            data: completedData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // Renderizar gráfico de tipos de levantamiento
        function renderInspectionsTypeChart(inspections) {
            // Contar levantamientos por tipo
            const typeCounts = {};

            inspections.forEach(inspection => {
                if (!typeCounts[inspection.type]) {
                    typeCounts[inspection.type] = 0;
                }
                typeCounts[inspection.type]++;
            });

            // Obtener nombres formateados de los tipos
            const typeNames = {
                'extintor': 'Extintor',
                'odometro': 'Odómetro',
                'luminaria': 'Luminaria',
                'wifi': 'WiFi',
                'publicidad': 'Publicidad',
                'normas-graficas': 'Normas Gráficas',
                'limpiaparabrisas': 'Limpiaparabrisas',
                'grabado-vidrios': 'Grabado Vidrios',
                'control-combustible': 'Control Combustible',
                'rack': 'Rack',
                'movileye': 'Movileye',
                'srl': 'SRL'
            };

            // Preparar datos para el gráfico
            const labels = Object.keys(typeCounts).map(type => typeNames[type] || type);
            const data = Object.values(typeCounts);

            const colors = [
                '#ef4444', // red
                '#0ea5e9', // blue
                '#f59e0b', // yellow
                '#22c55e', // green
                '#8b5cf6', // purple
                '#ec4899', // pink
                '#14b8a6', // teal
                '#06b6d4', // cyan
                '#f97316', // orange
                '#84cc16', // lime
                '#a855f7', // purple
                '#64748b', // gray
            ];

            if (charts.inspectionsType) {
                charts.inspectionsType.destroy();
            }

            const ctx = document.getElementById('inspections-type-chart').getContext('2d');
            charts.inspectionsType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Levantamientos',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Renderizar gráfico de productividad por terminal
        function renderTerminalProductivityChart() {
            // Datos simulados
            const terminals = [...new Set(allUsers.map(user => user.terminal))];
            const productivityData = terminals.map(() => Math.floor(Math.random() * 100));

            if (charts.terminalProductivity) {
                charts.terminalProductivity.destroy();
            }

            const ctx = document.getElementById('terminal-productivity-chart').getContext('2d');
            charts.terminalProductivity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: terminals,
                    datasets: [{
                        label: 'Productividad',
                        data: productivityData,
                        backgroundColor: '#0ea5e9',
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Renderizar top miembros
        function renderTopMembers() {
            const container = document.getElementById('top-members');
            container.innerHTML = '';

            // Datos simulados
            const topUsers = allUsers.slice(0, 5);
            const scores = [98, 92, 85, 78, 72];

            topUsers.forEach((user, index) => {
                const memberItem = document.createElement('div');
                memberItem.className = 'flex items-center justify-between';

                memberItem.innerHTML = `
                    <div class="flex items-center">
                        ${createAvatar(user, 'w-8 h-8 text-sm mr-3')}
                        <div>
                            <p class="font-medium text-sm">${user.nombre_completo}</p>
                            <p class="text-xs text-gray-500">${user.cargo}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-primary-500 h-2 rounded-full" style="width: ${scores[index]}%"></div>
                        </div>
                        <span class="text-sm font-medium">${scores[index]}</span>
                    </div>
                `;

                container.appendChild(memberItem);
            });
        }

        // Configurar eventos específicos de la vista de informes
        function setupReportsView() {
            const periodSelect = document.getElementById('report-period');

            if (periodSelect) {
                periodSelect.addEventListener('change', renderReports);
            }

            const exportBtn = document.getElementById('export-report-btn');

            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    Swal.fire({
                        title: 'Exportar Informe',
                        text: 'Selecciona el formato de exportación',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'PDF',
                        cancelButtonText: 'Excel',
                        confirmButtonColor: '#0ea5e9',
                        cancelButtonColor: '#22c55e',
                        showCloseButton: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            showToast('Exportando informe en PDF...', 'info');

                            // Simulación de exportación
                            setTimeout(() => {
                                showToast('Informe exportado exitosamente.', 'success');
                            }, 1500);
                        } else if (result.dismiss === Swal.DismissReason.cancel) {
                            showToast('Exportando informe en Excel...', 'info');

                            // Simulación de exportación
                            setTimeout(() => {
                                showToast('Informe exportado exitosamente.', 'success');
                            }, 1500);
                        }
                    });
                });
            }
        }

        // Renderizar vista de chat (simulada)
        function renderChat() {
            // Simular lista de chats
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';

            // Filtrar usuarios de la misma terminal
            const terminalUsers = allUsers.filter(user =>
                user.terminal === currentUser.terminal && user.id !== currentUser.id
            );

            if (terminalUsers.length === 0) {
                chatList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">No hay contactos disponibles</p>
                        <p class="text-sm mt-1">No hay otros usuarios en tu terminal.</p>
                    </div>
                `;
                return;
            }

            terminalUsers.forEach((user, index) => {
                const chatItem = document.createElement('div');
                chatItem.className = 'flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer chat-item';
                chatItem.setAttribute('data-user-id', user.id);
                chatItem.setAttribute('data-user-name', user.nombre_completo);

                // Simular estado en línea aleatorio
                const isOnline = Math.random() > 0.5;

                // Simular mensaje reciente
                const messages = [
                    'Hola, ¿cómo estás?',
                    'Necesito que revises esto',
                    'Ya completé la tarea',
                    'Te envié un documento',
                    'Buenos días',
                    'Gracias por la información'
                ];

                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                const timestamp = new Date(Date.now() - Math.floor(Math.random() * 24 * 60 * 60 * 1000));

                chatItem.innerHTML = `
                    <div class="relative flex-shrink-0">
                        ${createAvatar(user, 'w-10 h-10')}
                        <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-300'} border-2 border-white"></span>
                    </div>
                    <div class="ml-3 flex-1 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <h3 class="text-sm font-medium text-gray-900">${user.nombre_completo}</h3>
                            <p class="text-xs text-gray-500">${formatTimeAgo(timestamp)}</p>
                        </div>
                        <p class="text-xs text-gray-500 truncate">${randomMessage}</p>
                    </div>
                `;

                chatList.appendChild(chatItem);
            });

            // Añadir eventos de clic
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', () => {
                    const userId = item.getAttribute('data-user-id');
                    const userName = item.getAttribute('data-user-name');

                    document.querySelectorAll('.chat-item').forEach(el => {
                        el.classList.remove('bg-gray-100');
                    });

                    item.classList.add('bg-gray-100');
                    openChatWithUser(userId, userName);
                });
            });
        }

        // Formatear tiempo relativo
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;

            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                return `${days}d`;
            } else if (hours > 0) {
                return `${hours}h`;
            } else if (minutes > 0) {
                return `${minutes}m`;
            } else {
                return 'Ahora';
            }
        }

        // Abrir chat con usuario
        function openChatWithUser(userId, userName) {
            // Ocultar mensaje de selección y mostrar contenedor de chat
            document.getElementById('no-chat-selected').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';

            // Actualizar encabezado
            document.getElementById('chat-name').textContent = userName;
            document.getElementById('chat-avatar').textContent = getInitials(userName);
            document.getElementById('chat-avatar').style.backgroundColor = stringToColor(userName);

            // Generar mensajes aleatorios simulados
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';

            // Número aleatorio de mensajes (3-10)
            const numMessages = Math.floor(Math.random() * 8) + 3;

            // Generar mensajes simulados
            for (let i = 0; i < numMessages; i++) {
                const isSent = Math.random() > 0.5;
                const messageContent = getRandomMessage();
                const timestamp = new Date(Date.now() - (numMessages - i) * 15 * 60 * 1000);

                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${isSent ? 'sent' : 'received'}`;

                if (!isSent) {
                    messageDiv.innerHTML = `
                        <div class="flex items-end">
                            <div class="flex-shrink-0 mr-2">
                                ${createAvatar({ nombre_completo: userName }, 'w-8 h-8 text-xs')}
                            </div>
                            <div>
                                <div class="chat-bubble bg-gray-100 text-gray-800">
                                    ${messageContent}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${formatTimeShort(timestamp)}</p>
                            </div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="flex items-end justify-end">
                            <div>
                                <div class="chat-bubble bg-primary-600 text-white">
                                    ${messageContent}
                                </div>
                                <p class="text-xs text-gray-500 mt-1 text-right">${formatTimeShort(timestamp)}</p>
                            </div>
                        </div>
                    `;
                }

                chatMessages.appendChild(messageDiv);
            }

            // Desplazar al último mensaje
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Configurar formulario de envío
            document.getElementById('chat-form').onsubmit = function (e) {
                e.preventDefault();

                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                if (!message) return;

                // Agregar mensaje enviado
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message sent';
                messageDiv.innerHTML = `
                    <div class="flex items-end justify-end">
                        <div>
                            <div class="chat-bubble bg-primary-600 text-white">
                                ${message}
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-right">${formatTimeShort(new Date())}</p>
                        </div>
                    </div>
                `;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Limpiar input
                input.value = '';

                // Simular respuesta después de un tiempo aleatorio
                setTimeout(() => {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'chat-message received';
                    responseDiv.innerHTML = `
                        <div class="flex items-end">
                            <div class="flex-shrink-0 mr-2">
                                ${createAvatar({ nombre_completo: userName }, 'w-8 h-8 text-xs')}
                            </div>
                            <div>
                                <div class="chat-bubble bg-gray-100 text-gray-800">
                                    ${getRandomResponse(message)}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${formatTimeShort(new Date())}</p>
                            </div>
                        </div>
                    `;

                    chatMessages.appendChild(responseDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    // Reproducir sonido de mensaje
                    playNotificationSound('message');
                }, Math.random() * 2000 + 1000);
            };
        }

        // Formatear hora corta
        function formatTimeShort(date) {
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        // Obtener mensaje aleatorio
        function getRandomMessage() {
            const messages = [
                '¡Hola! ¿Cómo va todo?',
                '¿Ya revisaste el informe de ayer?',
                'Necesito que me ayudes con algo cuando tengas tiempo',
                'Ya completé la tarea que me asignaste',
                '¿A qué hora es la reunión de mañana?',
                'Te acabo de enviar los archivos por correo',
                'Revisa el levantamiento que hice, por favor',
                '¿Podemos hablar sobre el proyecto?',
                'Gracias por la información',
                'Acabo de terminar la inspección'
            ];

            return messages[Math.floor(Math.random() * messages.length)];
        }

        // Obtener respuesta aleatoria
        function getRandomResponse(message) {
            const responses = [
                '¡Claro! Te responderé en un momento',
                'Gracias por avisar',
                'Voy a revisarlo ahora mismo',
                'Perfecto, lo tendré en cuenta',
                '¿Necesitas algo más?',
                'Entendido, me pondré a trabajar en eso',
                'Ok, hablamos luego entonces',
                'Sí, sin problema',
                'Te confirmo en cuanto lo termine',
                'Ya lo estoy revisando'
            ];

            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Configurar eventos específicos de la vista de chat
        function setupChatView() {
            const searchInput = document.getElementById('chat-search');

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();

                    document.querySelectorAll('.chat-item').forEach(item => {
                        const userName = item.getAttribute('data-user-name').toLowerCase();

                        if (userName.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Renderizar vista de notificaciones
        function renderNotificationsView() {
            // Refrescar notificaciones
            fetchNotifications().then(() => {
                renderNotificationsList(currentNotifications, 'all-notifications-list');

                // Filtrar no leídas
                const unreadNotifications = currentNotifications.filter(notification => !notification.read);
                renderNotificationsList(unreadNotifications, 'unread-notifications-list');

                // Filtrar por tipo
                const taskNotifications = currentNotifications.filter(notification => notification.type === 'task');
                renderNotificationsList(taskNotifications, 'tasks-notifications-list');

                const meetingNotifications = currentNotifications.filter(notification => notification.type === 'meeting');
                renderNotificationsList(meetingNotifications, 'meetings-notifications-list');
            });
        }

        // Renderizar panel de notificaciones
        function renderNotificationPanel() {
            const container = document.getElementById('notifications-list');
            container.innerHTML = '';

            // Mostrar máximo 5 notificaciones recientes
            const recentNotifications = currentNotifications.slice(0, 5);

            if (recentNotifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">No hay notificaciones</p>
                    </div>
                `;
                return;
            }

            recentNotifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `p-3 hover:bg-gray-50 ${notification.read ? '' : 'bg-blue-50'}`;

                // Determinar icono según tipo
                let iconClass = '';
                let iconColor = '';

                switch (notification.type) {
                    case 'task':
                        iconClass = 'fa-list-check';
                        iconColor = 'text-primary-600';
                        break;
                    case 'meeting':
                        iconClass = 'fa-users-rectangle';
                        iconColor = 'text-yellow-600';
                        break;
                    case 'inspection':
                        iconClass = 'fa-clipboard-check';
                        iconColor = 'text-purple-600';
                        break;
                    case 'comment':
                        iconClass = 'fa-comment';
                        iconColor = 'text-green-600';
                        break;
                    case 'user':
                        iconClass = 'fa-user';
                        iconColor = 'text-indigo-600';
                        break;
                    default:
                        iconClass = 'fa-bell';
                        iconColor = 'text-gray-600';
                }

                notificationItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="fas ${iconClass} ${iconColor}"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="text-sm font-medium text-gray-900">${notification.title}</h4>
                                <p class="text-xs text-gray-500">${formatTimeAgo(new Date(notification.created_at))}</p>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">${notification.message}</p>
                        </div>
                    </div>
                `;

                // Marcar como leída al hacer clic
                notificationItem.addEventListener('click', () => {
                    markNotificationAsRead(notification.id);

                    // Si es una notificación relacionada, navegar a la vista correspondiente
                    if (notification.related_id) {
                        switch (notification.type) {
                            case 'task':
                                showView('taskDetail');
                                renderTaskDetail(notification.related_id);
                                break;
                            case 'meeting':
                                showView('meetings');
                                // TODO: Implementar detalle de reunión
                                break;
                            case 'inspection':
                                showView('inspections');
                                showInspectionDetail(notification.related_id);
                                break;
                        }

                        // Cerrar panel
                        notificationPanel.style.display = 'none';
                    }
                });

                container.appendChild(notificationItem);
            });

            // Mostrar enlace para ver todas
            if (currentNotifications.length > 5) {
                const viewAllLink = document.createElement('div');
                viewAllLink.className = 'text-center p-2 border-t';
                viewAllLink.innerHTML = `
                    <a href="#" class="text-sm text-primary-600 hover:text-primary-800">
                        Ver todas (${currentNotifications.length})
                    </a>
                `;

                viewAllLink.querySelector('a').addEventListener('click', () => {
                    showView('notifications');
                    renderNotificationsView();
                    notificationPanel.style.display = 'none';
                });

                container.appendChild(viewAllLink);
            }
        }

        // Renderizar lista de notificaciones
        function renderNotificationsList(notifications, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-bell-slash text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">No hay notificaciones</p>
                        <p class="text-sm mt-1">Las nuevas notificaciones aparecerán aquí.</p>
                    </div>
                `;
                return;
            }

            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `p-4 border-b hover:bg-gray-50 ${notification.read ? '' : 'bg-blue-50'}`;
                notificationItem.setAttribute('data-notification-id', notification.id);

                // Determinar icono según tipo
                let iconClass = '';
                let iconColor = '';

                switch (notification.type) {
                    case 'task':
                        iconClass = 'fa-list-check';
                        iconColor = 'text-primary-600';
                        break;
                    case 'meeting':
                        iconClass = 'fa-users-rectangle';
                        iconColor = 'text-yellow-600';
                        break;
                    case 'inspection':
                        iconClass = 'fa-clipboard-check';
                        iconColor = 'text-purple-600';
                        break;
                    case 'comment':
                        iconClass = 'fa-comment';
                        iconColor = 'text-green-600';
                        break;
                    case 'user':
                        iconClass = 'fa-user';
                        iconColor = 'text-indigo-600';
                        break;
                    default:
                        iconClass = 'fa-bell';
                        iconColor = 'text-gray-600';
                }

                notificationItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="fas ${iconClass} ${iconColor} text-lg"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="text-base font-medium text-gray-900">${notification.title}</h4>
                                <div class="flex items-center">
                                    <p class="text-xs text-gray-500 mr-2">${formatDate(notification.created_at)}</p>
                                    <button class="mark-read-btn p-1 text-gray-400 hover:text-gray-600 rounded-full" title="${notification.read ? 'Marcar como no leída' : 'Marcar como leída'}">
                                        <i class="far ${notification.read ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${notification.message}</p>
                            ${notification.related_id ? `
                            <div class="mt-3">
                                <button class="view-related-btn px-3 py-1 text-xs text-primary-600 hover:text-primary-800 border border-primary-600 rounded-md hover:bg-primary-50">
                                    <i class="fas fa-arrow-right mr-1"></i> Ver detalle
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Configurar botones
                const markReadBtn = notificationItem.querySelector('.mark-read-btn');
                markReadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNotificationReadStatus(notification.id, notification.read);
                });

                const viewRelatedBtn = notificationItem.querySelector('.view-related-btn');
                if (viewRelatedBtn) {
                    viewRelatedBtn.addEventListener('click', () => {
                        // Marcar como leída
                        if (!notification.read) {
                            markNotificationAsRead(notification.id);
                        }

                        // Navegar a la vista correspondiente
                        switch (notification.type) {
                            case 'task':
                                showView('taskDetail');
                                renderTaskDetail(notification.related_id);
                                break;
                            case 'meeting':
                                showView('meetings');
                                // TODO: Implementar detalle de reunión
                                break;
                            case 'inspection':
                                showView('inspections');
                                showInspectionDetail(notification.related_id);
                                break;
                        }
                    });
                }

                container.appendChild(notificationItem);
            });
        }

        // Marcar notificación como leída
        async function markNotificationAsRead(notificationId) {
            try {
                const { error } = await supabaseClient
                    .from(TABLES.NOTIFICATIONS)
                    .update({ read: true })
                    .eq('id', notificationId);

                if (error) throw error;

                // Actualizar estado local
                currentNotifications = currentNotifications.map(notification =>
                    notification.id === notificationId ? { ...notification, read: true } : notification
                );

                // Actualizar UI
                updateNotificationCount();
            } catch (error) {
                console.error('Error marcando notificación como leída:', error);
            }
        }

        // Cambiar estado de lectura de una notificación
        async function toggleNotificationReadStatus(notificationId, currentStatus) {
            try {
                const { error } = await supabaseClient
                    .from(TABLES.NOTIFICATIONS)
                    .update({ read: !currentStatus })
                    .eq('id', notificationId);

                if (error) throw error;

                // Actualizar estado local
                currentNotifications = currentNotifications.map(notification =>
                    notification.id === notificationId ? { ...notification, read: !currentStatus } : notification
                );

                // Actualizar UI
                updateNotificationCount();
                renderNotificationsView();
            } catch (error) {
                console.error('Error cambiando estado de notificación:', error);
                showToast('Error al actualizar la notificación.', 'error');
            }
        }

        // Configurar eventos específicos de la vista de notificaciones
        function setupNotificationsView() {
            const markAllReadBtn = document.getElementById('mark-all-read-btn');
            const clearNotificationsBtn = document.getElementById('clear-notifications-btn');

            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
            }

            if (clearNotificationsBtn) {
                clearNotificationsBtn.addEventListener('click', async () => {
                    try {
                        Swal.fire({
                            title: '¿Limpiar notificaciones?',
                            text: 'Esta acción eliminará todas tus notificaciones. No se puede deshacer.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, limpiar',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#ef4444'
                        }).then(async (result) => {
                            if (result.isConfirmed) {
                                const { error } = await supabaseClient
                                    .from(TABLES.NOTIFICATIONS)
                                    .delete()
                                    .eq('user_id', currentUser.id);

                                if (error) throw error;

                                // Actualizar estado local
                                currentNotifications = [];

                                // Actualizar UI
                                updateNotificationCount();
                                renderNotificationsView();

                                showToast('Notificaciones eliminadas correctamente.', 'success');
                            }
                        });
                    } catch (error) {
                        console.error('Error eliminando notificaciones:', error);
                        showToast('Error al eliminar notificaciones.', 'error');
                    }
                });
            }
        }
    </script>

</body>

</html>
