<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Sistema Empresarial de Administraci√≥n</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%230061ab'/%3E%3Cpath d='M64 152l48-72 32 48 16-24 32 48' stroke='%23fff' stroke-width='20' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Color palette - Light mode */
            --primary: #0056a4;
            --primary-light: #3d7cb9;
            --primary-dark: #004080;
            --primary-transparent: rgba(0, 86, 164, 0.08);
            --accent: #00909e;
            --accent-light: #3bafbc;
            --accent-dark: #007580;
            --accent-transparent: rgba(0, 144, 158, 0.08);
            --success: #0c9e70;
            --success-light: #2db58a;
            --success-dark: #088160;
            --success-transparent: rgba(12, 158, 112, 0.08);
            --warning: #e6930f;
            --warning-light: #f7ab3b;
            --warning-dark: #c97d0c;
            --warning-transparent: rgba(230, 147, 15, 0.08);
            --danger: #dc3545;
            --danger-light: #e35d6a;
            --danger-dark: #bd2130;
            --danger-transparent: rgba(220, 53, 69, 0.08);
            --neutral-50: #fafafa;
            --neutral-100: #f5f5f5;
            --neutral-200: #e9e9e9;
            --neutral-300: #d9d9d9;
            --neutral-400: #c4c4c4;
            --neutral-500: #9d9d9d;
            --neutral-600: #6e6e6e;
            --neutral-700: #4b4b4b;
            --neutral-800: #2c2c2c;
            --neutral-900: #1a1a1a;
            
            /* System variables */
            --light-bg: var(--neutral-100);
            --panel-bg: #ffffff;
            --panel-bg-alt: var(--neutral-50);
            --text: var(--neutral-800);
            --text-light: var(--neutral-600);
            --text-subtle: var(--neutral-500);
            --border: var(--neutral-200);
            --border-dark: var(--neutral-300);
            --focus-ring: rgba(0, 86, 164, 0.25);
            
            /* Shapes */
            --border-radius-xs: 4px;
            --border-radius-sm: 6px;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-2xl: 24px;
            --border-radius-full: 9999px;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.08), 0 4px 8px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 16px 24px rgba(0, 0, 0, 0.08), 0 6px 12px rgba(0, 0, 0, 0.04);
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Layout */
            --header-height: 64px;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 72px;
            
            /* Typography */
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size: 13px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            
            /* Z-index layers */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-fixed: 300;
            --z-modal: 400;
            --z-tooltip: 500;
        }
        
        /* DARK MODE VARIABLES */
        .dark-mode {
            --light-bg: #0f1421;
            --panel-bg: #151b2d;
            --panel-bg-alt: #1b2238;
            --text: #e6e9f0;
            --text-light: #a3adc2;
            --text-subtle: #697186;
            --border: #242c44;
            --border-dark: #303a57;
            --focus-ring: rgba(59, 130, 246, 0.5);
            
            /* Futuristic dark mode colors */
            --primary: #3b82f6;
            --primary-light: #60a5fa;
            --primary-dark: #2563eb;
            --primary-transparent: rgba(59, 130, 246, 0.15);
            --accent: #00c0d6;
            --accent-light: #22d3e7;
            --accent-dark: #0097a7;
            --accent-transparent: rgba(0, 192, 214, 0.15);
            --success: #10b981;
            --success-light: #34d399;
            --success-dark: #059669;
            --success-transparent: rgba(16, 185, 129, 0.15);
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --warning-dark: #d97706;
            --warning-transparent: rgba(245, 158, 11, 0.15);
            --danger: #ef4444;
            --danger-light: #f87171;
            --danger-dark: #dc2626;
            --danger-transparent: rgba(239, 68, 68, 0.15);
            
            /* Shadow enhancements for dark mode */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 16px 24px rgba(0, 0, 0, 0.4), 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Base Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--light-bg);
            color: var(--text);
            font-size: var(--font-size);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition);
        }
        
        /* AUTHENTICATION SCREEN */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--panel-bg) 0%, var(--light-bg) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .auth-screen::before,
        .auth-screen::after {
            content: "";
            position: absolute;
            background: radial-gradient(circle, var(--primary-transparent) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
            animation: pulse 25s infinite alternate ease-in-out;
        }
        
        .auth-screen::before {
            width: 100vw;
            height: 100vw;
            top: -50vw;
            right: -30vw;
        }
        
        .auth-screen::after {
            width: 80vw;
            height: 80vw;
            bottom: -40vw;
            left: -20vw;
            animation-delay: -5s;
        }
        
        .dark-mode .auth-screen {
            background: radial-gradient(circle at 10% 20%, var(--panel-bg) 0%, var(--light-bg) 100%);
        }
        
        .dark-mode .auth-screen::before,
        .dark-mode .auth-screen::after {
            opacity: 0.3;
            background: radial-gradient(circle, var(--primary-transparent) 0%, rgba(59, 130, 246, 0.05) 70%);
        }
        
        /* Add a futuristic grid pattern in dark mode */
        .dark-mode .auth-screen::before {
            background-image: 
                radial-gradient(rgba(59, 130, 246, 0.15) 1px, transparent 1px),
                radial-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        
        .auth-container {
            width: 400px;
            max-width: 92%;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 36px;
        }
        
        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 12px;
        }
        
        .auth-logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
        }
        
        .auth-logo-icon i {
            font-size: 24px;
            color: white;
        }
        
        .auth-logo-text {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--primary);
        }
        
        .dark-mode .auth-logo-text {
            color: white;
        }
        
        .auth-card {
            background: var(--panel-bg);
            border-radius: var(--border-radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-xl);
            animation: fadeIn 0.5s ease-out;
            border: 1px solid var(--border);
        }
        
        .dark-mode .auth-card {
            background: rgba(21, 27, 45, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.2),
                0 10px 10px -5px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(59, 130, 246, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .auth-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            color: var(--text);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-light);
        }
        
        .form-control {
            height: 42px;
            width: 100%;
            padding: 0 14px;
            font-size: var(--font-size);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            background-color: var(--panel-bg);
            color: var(--text);
            transition: all var(--transition-fast);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        
        .dark-mode .form-control {
            background-color: var(--panel-bg-alt);
            border-color: var(--border);
        }
        
        .dark-mode .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        .btn {
            height: 42px;
            padding: 0 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size);
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            white-space: nowrap;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            transition: background-color var(--transition-fast);
        }
        
        .btn:hover::after {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn:active::after {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 2px 8px rgba(0, 86, 164, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(0, 86, 164, 0.4);
        }
        
        .dark-mode .btn-primary {
            background: linear-gradient(45deg, #2563eb, #3b82f6);
            box-shadow: 
                0 4px 12px rgba(37, 99, 235, 0.3),
                0 0 0 1px rgba(59, 130, 246, 0.5);
        }
        
        .dark-mode .btn-primary:hover {
            box-shadow: 
                0 6px 16px rgba(37, 99, 235, 0.4),
                0 0 0 1px rgba(59, 130, 246, 0.6);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn i {
            font-size: var(--font-size-md);
        }
        
        .auth-footer {
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--text-light);
        }
        
        /* MAIN APP LAYOUT */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Utilities for showing/hiding content */
        .auth-no .app-content {
            display: none;
        }
        
        .auth-yes .auth-screen {
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Header */
        .app-header {
            height: var(--header-height);
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: var(--z-sticky);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .dark-mode .app-header {
            background: rgba(21, 27, 45, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: 20px;
        }
        
        .header-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-logo i {
            font-size: 16px;
            color: white;
        }
        
        .header-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text);
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .header-subtitle {
            font-size: var(--font-size-xs);
            font-weight: normal;
            color: var(--text-light);
        }
        
        .header-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-toggle:hover {
            background-color: var(--panel-bg-alt);
            color: var(--text);
        }
        
        .header-search {
            flex: 1;
            position: relative;
            max-width: 480px;
            margin: 0 16px;
        }
        
        .header-search input {
            width: 100%;
            height: 36px;
            padding: 0 36px 0 14px;
            font-size: var(--font-size);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-full);
            background-color: var(--panel-bg-alt);
            color: var(--text);
            transition: all var(--transition-fast);
        }
        
        .header-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--focus-ring);
        }
        
        .header-search i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 14px;
            pointer-events: none;
        }
        
        .dark-mode .header-search input {
            background-color: rgba(27, 34, 56, 0.6);
            border-color: var(--border);
        }
        
        .dark-mode .header-search input:focus {
            background-color: rgba(27, 34, 56, 0.8);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 4px;
        }
        
        .header-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .header-icon-btn:hover {
            background-color: var(--panel-bg-alt);
            color: var(--text);
        }
        
        .header-icon-btn .badge {
            position: absolute;
            top: 1px;
            right: 1px;
            width: 16px;
            height: 16px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--panel-bg);
            pointer-events: none;
        }
        
        .dark-mode .header-icon-btn .badge {
            border-color: var(--panel-bg);
        }
        
        .user-menu {
            margin-left: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 6px 4px 4px;
            border-radius: var(--border-radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .user-menu:hover {
            background-color: var(--panel-bg-alt);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius-full);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-sm);
        }
        
        .dark-mode .user-avatar {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .user-name {
            font-weight: 500;
            font-size: var(--font-size);
            color: var(--text);
        }
        
        .user-role {
            font-size: var(--font-size-xs);
            color: var(--text-light);
        }
        
        /* Content Layout */
        .app-content {
            display: flex;
            flex: 1;
        }
        
        /* Sidebar */
        .sidebar {
    width: var(--sidebar-width);
    background-color: var(--panel-bg);
    border-right: 1px solid var(--border);
    height: calc(100vh - var(--header-height));
    position: fixed;
    top: var(--header-height);
    right: 0; /* Posicionar en el lado derecho */
    z-index: 90;
    transition: width 0.3s ease, transform 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

/* Secciones del Sidebar */
.sidebar-section {
    padding: 16px 12px;
}

.sidebar-heading {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-light);
    padding: 0 12px 8px;
    margin-bottom: 8px;
}

/* Items de navegaci√≥n */
.sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.sidebar-nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    color: var(--text);
    position: relative;
}

.sidebar-nav-item:hover {
    background-color: var(--panel-bg-alt);
}

.sidebar-nav-item.active {
    background-color: var(--primary-transparent);
    color: var(--primary);
}

.sidebar-nav-item.active::before {
    content: "";
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 20px;
    background-color: var(--primary);
    border-radius: 0 2px 2px 0;
}

.sidebar-nav-item i {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.sidebar-nav-text {
    font-size: 14px;
    font-weight: 500;
}

/* √Årea principal de contenido */
.main {
    flex: 1;
    padding: 20px;
    margin-right: var(--sidebar-width); /* Espacio para el sidebar derecho */
}

/* Media queries para dispositivos m√≥viles */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(100%);
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar.expanded {
        transform: translateX(0);
    }
    
    .main {
        margin-right: 0;
    }
}


        /* Main Content */
        .main {
    flex: 1;
    padding: 20px;
    margin-right: var(--sidebar-width); /* Espacio para el sidebar derecho */
}
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text);
        }
        
        .page-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Dashboard Views */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: fadeSlideIn 0.3s ease-out;
        }
        
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card Components */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all var(--transition-fast);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .dark-mode .card {
            background-color: rgba(21, 27, 45, 0.8);
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .dark-mode .card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-color: var(--border-dark);
        }
        
        .stat-card {
            position: relative;
            overflow: hidden;
        }
        
        .stat-card-icon {
            position: absolute;
            right: -15px;
            bottom: -15px;
            font-size: 70px;
            opacity: 0.08;
            color: var(--primary);
        }
        
        .dark-mode .stat-card-icon {
            opacity: 0.1;
            color: var(--primary-light);
        }
        
        .stat-card-content {
            position: relative;
            z-index: 1;
        }
        
        .stat-card-title {
            font-size: var(--font-size-xs);
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .dark-mode .stat-card-value {
            background: linear-gradient(to right, #fff, #a3adc2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: var(--font-size-xs);
            font-weight: 500;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text);
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        .task-list, .meeting-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .task-list::-webkit-scrollbar, .meeting-list::-webkit-scrollbar {
            width: 5px;
        }
        
        .task-list::-webkit-scrollbar-track, .meeting-list::-webkit-scrollbar-track {
            background: var(--panel-bg-alt);
            border-radius: 10px;
        }
        
        .task-list::-webkit-scrollbar-thumb, .meeting-list::-webkit-scrollbar-thumb {
            background-color: var(--border-dark);
            border-radius: 10px;
        }
        
        .task-list::-webkit-scrollbar-thumb:hover, .meeting-list::-webkit-scrollbar-thumb:hover {
            background-color: var(--text-subtle);
        }
        
        .task-item, .meeting-item {
            background-color: var(--panel-bg-alt);
            border-radius: var(--border-radius);
            padding: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--primary);
            transition: all var(--transition-fast);
        }
        
        .task-item:hover, .meeting-item:hover {
            transform: translateX(2px);
            box-shadow: var(--shadow-sm);
        }
        
        .dark-mode .task-item, .dark-mode .meeting-item {
            background-color: rgba(27, 34, 56, 0.5);
        }
        
        .dark-mode .task-item:hover, .dark-mode .meeting-item:hover {
            background-color: rgba(27, 34, 56, 0.7);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .task-item-status-pending {
            border-left-color: var(--warning);
        }
        
        .task-item-status-progress {
            border-left-color: var(--primary);
        }
        
        .task-item-status-completed {
            border-left-color: var(--success);
        }
        
        .task-item-status-overdue {
            border-left-color: var(--danger);
        }
        
        .task-item-content, .meeting-item-content {
            flex: 1;
        }
        
        .task-item-title, .meeting-item-title {
            font-weight: 500;
            font-size: var(--font-size);
            margin-bottom: 4px;
            color: var(--text);
        }
        
        .task-item-meta, .meeting-item-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .task-item-badge, .meeting-item-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
            background-color: var(--panel-bg);
            color: var(--text-light);
            border: 1px solid var(--border);
            line-height: 1;
        }
        
        .dark-mode .task-item-badge, .dark-mode .meeting-item-badge {
            background-color: rgba(27, 34, 56, 0.5);
            border-color: var(--border);
        }
        
        .badge-pending {
            background-color: var(--warning-transparent);
            color: var(--warning-dark);
            border-color: rgba(230, 147, 15, 0.2);
        }
        
        .badge-progress {
            background-color: var(--primary-transparent);
            color: var(--primary-dark);
            border-color: rgba(0, 86, 164, 0.2);
        }
        
        .dark-mode .badge-progress {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--primary-light);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .badge-completed {
            background-color: var(--success-transparent);
            color: var(--success-dark);
            border-color: rgba(12, 158, 112, 0.2);
        }
        
        .badge-overdue {
            background-color: var(--danger-transparent);
            color: var(--danger-dark);
            border-color: rgba(220, 53, 69, 0.2);
        }
        
        .dark-mode .badge-pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning-light);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .dark-mode .badge-completed {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success-light);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .dark-mode .badge-overdue {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger-light);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .task-item-actions, .meeting-item-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn-icon {
            width: 30px;
            height: 30px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
        }
        
        .btn-icon i {
            font-size: var(--font-size);
        }
        
        .btn-sm {
            height: 30px;
            padding: 0 10px;
            font-size: var(--font-size-sm);
        }
        
        .btn-secondary {
            background-color: var(--panel-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background-color: var(--panel-bg-alt);
        }
        
        .dark-mode .btn-secondary {
            background-color: rgba(27, 34, 56, 0.7);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .dark-mode .btn-secondary:hover {
            background-color: rgba(27, 34, 56, 0.9);
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), var(--success-light));
            color: white;
            box-shadow: 0 2px 8px rgba(12, 158, 112, 0.2);
        }
        
        .btn-success:hover {
            box-shadow: 0 4px 12px rgba(12, 158, 112, 0.3);
        }
        
        .dark-mode .btn-success {
            background: linear-gradient(45deg, #059669, #10b981);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .dark-mode .btn-success:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning), var(--warning-light));
            color: white;
            box-shadow: 0 2px 8px rgba(230, 147, 15, 0.2);
        }
        
        .btn-warning:hover {
            box-shadow: 0 4px 12px rgba(230, 147, 15, 0.3);
        }
        
        .dark-mode .btn-warning {
            background: linear-gradient(45deg, #d97706, #f59e0b);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .dark-mode .btn-warning:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), var(--danger-light));
            color: white;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .dark-mode .btn-danger {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .dark-mode .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        
        /* Badges and Status Indicators */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: var(--border-radius-full);
            font-size: var(--font-size-xs);
            font-weight: 500;
            line-height: 1;
        }
        
        /* Grid Systems */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .col-12 { grid-column: span 12; }
        .col-9 { grid-column: span 9; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }
        
        /* Form Components */
        .form-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
        }
        
        textarea.form-control {
            height: auto;
            padding: 10px 14px;
            resize: vertical;
            min-height: 80px;
        }
        
        .input-group {
            display: flex;
            width: 100%;
        }
        
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            flex: 1;
        }
        
        .input-group .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .dark-mode .modal-overlay {
            background-color: rgba(10, 15, 30, 0.7);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-container {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 750px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.3s ease-out;
            border: 1px solid var(--border);
        }
        
        .dark-mode .modal-container {
            background-color: rgba(21, 27, 45, 0.95);
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-light);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .modal-close:hover {
            background-color: var(--panel-bg-alt);
            color: var(--text);
        }
        
        .dark-mode .modal-close:hover {
            background-color: rgba(27, 34, 56, 0.7);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: var(--z-tooltip);
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 100%;
            width: 360px;
        }
        
        .toast {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 14px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 3px solid var(--primary);
            border: 1px solid var(--border);
        }
        
        .dark-mode .toast {
            background-color: rgba(21, 27, 45, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast.closing {
            animation: toastSlideOut 0.3s ease-in forwards;
        }
        
        @keyframes toastSlideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size);
            background-color: var(--primary-transparent);
            color: var(--primary);
        }
        
        .dark-mode .toast-icon {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--primary-light);
        }
        
        .toast-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .toast-title {
            font-weight: 500;
            font-size: var(--font-size);
            color: var(--text);
        }
        
        .toast-message {
            font-size: var(--font-size-sm);
            color: var(--text-light);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 12px;
        }
        
        .toast-close:hover {
            background-color: var(--panel-bg-alt);
            color: var(--text);
        }
        
        .toast-success {
            border-left-color: var(--success);
        }
        
        .toast-success .toast-icon {
            background-color: var(--success-transparent);
            color: var(--success);
        }
        
        .dark-mode .toast-success .toast-icon {
            background-color: rgba(16, 185, 129, 0.15);
            color: var(--success-light);
        }
        
        .toast-warning {
            border-left-color: var(--warning);
        }
        
        .toast-warning .toast-icon {
            background-color: var(--warning-transparent);
            color: var(--warning);
        }
        
        .dark-mode .toast-warning .toast-icon {
            background-color: rgba(245, 158, 11, 0.15);
            color: var(--warning-light);
        }
        
        .toast-error {
            border-left-color: var(--danger);
        }
        
        .toast-error .toast-icon {
            background-color: var(--danger-transparent);
            color: var(--danger);
        }
        
        .dark-mode .toast-error .toast-icon {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--danger-light);
        }
        
        /* Mention system */
        .mention-popup {
            position: absolute;
            background-color: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 220px;
            max-height: 180px;
            overflow-y: auto;
            z-index: var(--z-dropdown);
            display: none;
        }
        
        .dark-mode .mention-popup {
            background-color: rgba(21, 27, 45, 0.95);
            border: 1px solid var(--border);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .mention-popup.active {
            display: block;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .mention-item:hover {
            background-color: var(--panel-bg-alt);
        }
        
        .dark-mode .mention-item:hover {
            background-color: rgba(27, 34, 56, 0.7);
        }
        
        .mention-avatar {
            width: 24px;
            height: 24px;
            border-radius: var(--border-radius-sm);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
        }
        
        .dark-mode .mention-avatar {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        }
        
        .mention-name {
            font-size: var(--font-size);
            font-weight: 500;
            color: var(--text);
        }
        
        /* Calendar Customization */
        .fc {
            font-family: 'Inter', sans-serif;
        }
        
        .fc .fc-toolbar-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .fc .fc-button {
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            background-color: var(--panel-bg);
            color: var(--text);
            font-weight: 500;
            transition: all var(--transition-fast);
            padding: 6px 10px;
            font-size: var(--font-size-sm);
        }
        
        .fc .fc-button:hover {
            background-color: var(--panel-bg-alt);
        }
        
        .fc .fc-button-primary:not(:disabled).fc-button-active,
        .fc .fc-button-primary:not(:disabled):active {
            background-color: var(--primary);
            border-color: var(--primary-dark);
            color: white;
        }
        
        .dark-mode .fc .fc-button {
            background-color: rgba(27, 34, 56, 0.6);
            border-color: var(--border);
        }
        
        .dark-mode .fc .fc-button:hover {
            background-color: rgba(27, 34, 56, 0.8);
        }
        
        .dark-mode .fc .fc-button-primary:not(:disabled).fc-button-active,
        .dark-mode .fc .fc-button-primary:not(:disabled):active {
            background-color: var(--primary);
            border-color: var(--primary-dark);
            color: white;
        }
        
        .fc .fc-daygrid-day.fc-day-today {
            background-color: var(--primary-transparent);
        }
        
        .dark-mode .fc .fc-daygrid-day.fc-day-today {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .fc .fc-h-event {
            background-color: var(--primary);
            border-color: var(--primary-dark);
            border-radius: var(--border-radius-xs);
        }
        
        .fc .fc-daygrid-day-number,
        .fc .fc-col-header-cell-cushion {
            color: var(--text);
            text-decoration: none;
        }
        
        .dark-mode .fc-theme-standard .fc-scrollgrid,
        .dark-mode .fc-theme-standard td,
        .dark-mode .fc-theme-standard th {
            border-color: var(--border);
        }
        
        .dark-mode .fc-theme-standard .fc-scrollgrid {
            background-color: rgba(27, 34, 56, 0.3);
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--panel-bg);
            border-top: 1px solid var(--border);
            z-index: var(--z-fixed);
            padding: 6px 12px;
            box-shadow: var(--shadow-md);
        }
        
        .dark-mode .mobile-nav {
            background-color: rgba(21, 27, 45, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
        }
        
        .mobile-nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 6px;
            border-radius: var(--border-radius);
            color: var(--text-light);
            transition: all var(--transition-fast);
        }
        
        .mobile-nav-item.active {
            color: var(--primary);
        }
        
        .dark-mode .mobile-nav-item.active {
            color: var(--primary-light);
            background-color: rgba(59, 130, 246, 0.15);
        }
        
        .mobile-nav-item i {
            font-size: 18px;
        }
        
        .mobile-nav-text {
            font-size: var(--font-size-xs);
            font-weight: 500;
        }
        
        /* Dark Mode Enhanced Futuristic Styles */
        .dark-mode .fc-h-event {
            background-color: var(--primary);
            border-color: var(--primary-dark);
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        
        .dark-mode .sidebar-nav-item.active i,
        .dark-mode .mobile-nav-item.active i {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
        }
        
        .dark-mode .header-icon-btn .badge {
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
        }
        
        .dark-mode .stat-card {
            background: linear-gradient(145deg, rgba(21, 27, 45, 0.8), rgba(27, 34, 56, 0.8));
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(59, 130, 246, 0.1);
        }
        
        .dark-mode .stat-card:hover {
            box-shadow: 
                0 8px 16px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        
        /* Glow effects for interactive elements in dark mode */
        .dark-mode .btn-primary:hover,
        .dark-mode .btn-success:hover,
        .dark-mode .btn-warning:hover,
        .dark-mode .btn-danger:hover {
            box-shadow: 0 0 15px rgba(var(--glow-color, 59, 130, 246), 0.6);
        }
        
        .dark-mode .btn-primary {
            --glow-color: 59, 130, 246;
        }
        
        .dark-mode .btn-success {
            --glow-color: 16, 185, 129;
        }
        
        .dark-mode .btn-warning {
            --glow-color: 245, 158, 11;
        }
        
        .dark-mode .btn-danger {
            --glow-color: 239, 68, 68;
        }
        
        /* Custom futuristic scrollbar for dark mode */
        .dark-mode::-webkit-scrollbar {
            width: 5px;
        }
        
        .dark-mode::-webkit-scrollbar-track {
            background: rgba(27, 34, 56, 0.3);
        }
        
        .dark-mode::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.4);
            border-radius: 10px;
        }
        
        .dark-mode::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.6);
        }
        
        /* Responsive Styles */
        @media (max-width: 1200px) {
            .sidebar {
                width: var(--sidebar-collapsed-width);
            }
            
            .sidebar-nav-text {
                display: none;
            }
            
            .sidebar-nav-item {
                justify-content: center;
                padding: 10px;
            }
            
            .sidebar-heading {
                text-align: center;
                padding: 0;
            }
            
            .sidebar.expanded {
                position: fixed;
                width: var(--sidebar-width);
                box-shadow: var(--shadow-lg);
                z-index: var(--z-fixed);
            }
            
            .sidebar.expanded .sidebar-nav-text {
                display: block;
            }
            
            .sidebar.expanded .sidebar-nav-item {
                justify-content: flex-start;
                padding: 10px 12px;
            }
            
            .sidebar.expanded .sidebar-heading {
                text-align: left;
                padding: 0 10px;
            }
        }
        
        @media (max-width: 992px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .col-6, .col-4, .col-3 {
                grid-column: span 6;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
        transform: translateX(100%);
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar.expanded {
        transform: translateX(0);
    }
            
            .mobile-nav {
                display: block;
            }
            
            main {
        margin-right: 0;
    }
            
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .page-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .header-search {
                display: none;
            }
            
            .header-title {
                font-size: var(--font-size);
            }
            
            .col-8, .col-6, .col-4, .col-3 {
                grid-column: span 12;
            }
            
            .toast-container {
                width: calc(100% - 32px);
                top: 16px;
                right: 16px;
            }
            
            .auth-card {
                padding: 24px;
            }
            
            .stat-card-value {
                font-size: 24px;
            }
        }
        
        @media (max-width: 576px) {
            .header-actions {
                gap: 2px;
            }
            
            .user-info {
                display: none;
            }
            
            .modal-container {
                width: 100%;
            }
            
            .task-item, .meeting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .task-item-actions, .meeting-item-actions {
                align-self: flex-end;
            }
            
            .btn {
                font-size: var(--font-size-xs);
            }
            
            .stat-card-value {
                font-size: 22px;
            }
        }
    </style>
</head>
<body class="auth-no">
    <!-- Authentication Screen -->
    <div class="auth-screen">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="auth-logo-text">Sistema de Administraci√≥n</div>
            </div>
            
            <div class="auth-card">
                <h1 class="auth-title">Iniciar Sesi√≥n</h1>
                <form class="auth-form" id="login-form">
                    <div class="form-group">
                        <label class="form-label" for="lg-user">Usuario</label>
                        <input type="text" class="form-control" id="lg-user" placeholder="Ingrese su usuario" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="lg-pass">Contrase√±a</label>
                        <input type="password" class="form-control" id="lg-pass" placeholder="Ingrese su contrase√±a">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="btn-login">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Ingresar al Sistema</span>
                    </button>
                </form>
            </div>
            
            <div class="auth-footer">
                <p>Sistema Empresarial de Administraci√≥n de Equipo v2.0</p>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div class="app-content">
        <!-- Header -->
        <header class="app-header">
            <button id="sidebar-toggle" class="header-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="header-brand">
                <div class="header-logo">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="header-title">
                    <span>Sistema de Administraci√≥n</span>
                    <span class="header-subtitle">Panel de Control</span>
                </div>
            </div>
            
            <div class="header-search">
                <input type="text" placeholder="Buscar..." id="global-search">
                <i class="fas fa-search"></i>
            </div>
            
            <div class="header-actions">
                <button class="header-icon-btn" id="btn-notifications">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notifications-count">0</span>
                </button>
                
                <button class="header-icon-btn" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-menu" id="user-dropdown-toggle">
                    <div class="user-avatar" id="ui-avatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="ui-name">Usuario</div>
                        <div class="user-role" id="ui-role">Rol</div>
                    </div>
                    <i class="fas fa-chevron-down" style="font-size: 10px; color: var(--text-light);"></i>
                </div>
            </div>
        </header>
        
        <!-- Main Layout -->
        <div class="app-content">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-heading">Principal</div>
                    <div class="sidebar-nav">
                        <div class="sidebar-nav-item active" data-view="dashboard">
                            <i class="fas fa-home"></i>
                            <span class="sidebar-nav-text">Dashboard</span>
                        </div>
                        <div class="sidebar-nav-item" data-view="tareas">
                            <i class="fas fa-tasks"></i>
                            <span class="sidebar-nav-text">Tareas</span>
                        </div>
                        <div class="sidebar-nav-item" data-view="levantamientos">
                            <i class="fas fa-clipboard-list"></i>
                            <span class="sidebar-nav-text">Levantamientos</span>
                        </div>
                        <div class="sidebar-nav-item" data-view="reuniones">
                            <i class="fas fa-users"></i>
                            <span class="sidebar-nav-text">Reuniones</span>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-heading">Gesti√≥n</div>
                    <div class="sidebar-nav">
                        <div class="sidebar-nav-item" data-view="calendario">
                            <i class="fas fa-calendar-alt"></i>
                            <span class="sidebar-nav-text">Calendario</span>
                        </div>
                        <div class="sidebar-nav-item" data-view="informes">
                            <i class="fas fa-chart-bar"></i>
                            <span class="sidebar-nav-text">Informes</span>
                        </div>
                        <div id="btn-usuarios" class="sidebar-nav-item hidden" data-view="usuarios">
                            <i class="fas fa-user-cog"></i>
                            <span class="sidebar-nav-text">Personal</span>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-heading">Cuenta</div>
                    <div class="sidebar-nav">
                        <div class="sidebar-nav-item" id="btn-logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="sidebar-nav-text">Cerrar Sesi√≥n</span>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="main">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view active">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <div class="page-actions">
                            <button id="btn-new-task" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                <span>Nueva Tarea</span>
                            </button>
                            <button id="btn-new-meeting" class="btn btn-secondary">
                                <i class="fas fa-users"></i>
                                <span>Nueva Reuni√≥n</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="cards-grid">
                        <div class="card stat-card">
                            <div class="stat-card-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-title">Pendientes</div>
                                <div class="stat-card-value" id="kpi-p">0</div>
                                <div class="stat-card-badge badge-pending">
                                    <i class="fas fa-clock"></i>
                                    <span>Tareas por iniciar</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-card-icon">
                                <i class="fas fa-spinner"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-title">En Curso</div>
                                <div class="stat-card-value" id="kpi-e">0</div>
                                <div class="stat-card-badge badge-progress">
                                    <i class="fas fa-spinner"></i>
                                    <span>Tareas activas</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-card-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-title">Terminadas</div>
                                <div class="stat-card-value" id="kpi-t">0</div>
                                <div class="stat-card-badge badge-completed">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Tareas completadas</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-title">Atrasadas</div>
                                <div class="stat-card-value" id="kpi-o">0</div>
                                <div class="stat-card-badge badge-overdue">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Requieren atenci√≥n</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-card-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-title">Pr√≥ximas Reuniones</div>
                                <div class="stat-card-value" id="kpi-r">0</div>
                                <div class="stat-card-badge">
                                    <i class="fas fa-calendar-check"></i>
                                    <span>Agendadas</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Task & Meeting Cards -->
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">√öltimas Tareas</h2>
                                <div class="card-actions">
                                    <select id="flt-status" class="form-control">
                                        <option value="">Todas</option>
                                        <option value="pendiente">Pendiente</option>
                                        <option value="en_curso">En curso</option>
                                        <option value="terminada">Terminada</option>
                                    </select>
                                    <select id="flt-mias" class="form-control">
                                        <option value="todas">Visibles</option>
                                        <option value="mias">Asignadas a m√≠</option>
                                    </select>
                                </div>
                            </div>
                            <div class="task-list" id="list-dashboard">
                                <!-- Tasks will be loaded here -->
                                <div class="task-item task-item-status-pending">
                                    <div class="task-item-content">
                                        <div class="task-item-title">Cargando tareas...</div>
                                        <div class="task-item-meta">
                                            <span class="task-item-badge">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                <span>Espere por favor</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Pr√≥ximas Reuniones</h2>
                            </div>
                            <div class="meeting-list" id="list-next-meet">
                                <!-- Meetings will be loaded here -->
                                <div class="meeting-item">
                                    <div class="meeting-item-content">
                                        <div class="meeting-item-title">Cargando reuniones...</div>
                                        <div class="meeting-item-meta">
                                            <span class="meeting-item-badge">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                <span>Espere por favor</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tareas View -->
                <div id="view-tareas" class="view">
                    <div class="page-header">
                        <h1 class="page-title">Gesti√≥n de Tareas</h1>
                        <div class="page-actions">
                            <button id="btn-new-task-2" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                <span>Nueva Tarea</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Listado de Tareas</h2>
                            <div class="card-actions">
                                <select id="flt-tasks" class="form-control">
                                    <option value="">Todas</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="en_curso">En curso</option>
                                    <option value="terminada">Terminada</option>
                                </select>
                                <select id="flt-vis" class="form-control">
                                    <option value="todas">Equipo</option>
                                    <option value="mias">M√≠as</option>
                                </select>
                            </div>
                        </div>
                        <div class="task-list" id="list-tasks">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Levantamientos View -->
                <div id="view-levantamientos" class="view">
                    <div class="page-header">
                        <h1 class="page-title">Levantamientos</h1>
                        <div class="page-actions">
                            <button id="btn-new-lev" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                <span>Crear Levantamiento</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Listado de Levantamientos</h2>
                        </div>
                        <div class="task-list" id="lev-list">
                            <!-- Levantamientos will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title">Accesos R√°pidos</h2>
                        </div>
                        <div class="cards-grid" id="lev-links">
                            <!-- Quick access links will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Reuniones View -->
                <div id="view-reuniones" class="view">
                    <div class="page-header">
                        <h1 class="page-title">Reuniones</h1>
                        <div class="page-actions">
                            <button id="btn-new-meeting-2" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                <span>Nueva Reuni√≥n</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Pr√≥ximas Reuniones</h2>
                        </div>
                        <div class="meeting-list" id="list-meetings">
                            <!-- Meetings will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Calendario View -->
                <div id="view-calendario" class="view">
                    <div class="page-header">
                        <h1 class="page-title">Calendario</h1>
                        <div class="page-actions">
                            <select id="cal-scope" class="form-control">
                                <option value="mias">Mis Eventos</option>
                                <option value="equipo">Eventos del Equipo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div id="calendar"></div>
                    </div>
                </div>
                
                <!-- Informes View -->
                <div id="view-informes" class="view">
                    <div class="page-header">
                        <h1 class="page-title">Informes y Estad√≠sticas</h1>
                    </div>
                    
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Distribuci√≥n de Tareas</h2>
                            </div>
                            <canvas id="chart1" height="250"></canvas>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Evoluci√≥n Semanal</h2>
                            </div>
                            <canvas id="chart2" height="250"></canvas>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title">Rendimiento por Persona</h2>
                            <div class="card-actions">
                                <select id="perf-window" class="form-control">
                                    <option value="30">√öltimos 30 d√≠as</option>
                                    <option value="90">√öltimos 90 d√≠as</option>
                                    <option value="365">√öltimos 12 meses</option>
                                </select>
                            </div>
                        </div>
                        <div class="task-list" id="perf-table">
                            <!-- Performance data will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Usuarios View -->
                <div id="view-usuarios" class="view">
                    <div class="page-header">
                        <h1 class="page-title">Gesti√≥n de Personal</h1>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Alta de Personal</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-container">
                                <div class="col-4">
                                    <div class="form-group">
                                        <label class="form-label" for="u-name">Nombre</label>
                                        <input type="text" class="form-control" id="u-name" placeholder="Nombre completo">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label class="form-label" for="u-user">Usuario</label>
                                        <input type="text" class="form-control" id="u-user" placeholder="Nombre de usuario">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label class="form-label" for="u-pass">Contrase√±a</label>
                                        <input type="password" class="form-control" id="u-pass" placeholder="Contrase√±a">
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label class="form-label" for="u-role">Rol</label>
                                        <select class="form-control" id="u-role">
                                            <option value="inspector">Inspector</option>
                                            <option value="supervisor">Supervisor</option>
                                            <option value="jefe_terminal">Jefe Terminal</option>
                                            <option value="supervisor_admin">Supervisor Admin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button id="btn-add-user" class="btn btn-success">
                                        <i class="fas fa-user-plus"></i>
                                        <span>Crear Usuario</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title">Usuarios Registrados</h2>
                        </div>
                        <div class="task-list" id="list-users">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <div class="mobile-nav-content">
                <div class="mobile-nav-item active" data-view="dashboard">
                    <i class="fas fa-home"></i>
                    <span class="mobile-nav-text">Inicio</span>
                </div>
                <div class="mobile-nav-item" data-view="tareas">
                    <i class="fas fa-tasks"></i>
                    <span class="mobile-nav-text">Tareas</span>
                </div>
                <div class="mobile-nav-item" data-view="levantamientos">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="mobile-nav-text">Levant.</span>
                </div>
                <div class="mobile-nav-item" data-view="reuniones">
                    <i class="fas fa-users"></i>
                    <span class="mobile-nav-text">Reuniones</span>
                </div>
                <div class="mobile-nav-item" data-view="calendario">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="mobile-nav-text">Calendario</span>
                </div>
            </div>
        </nav>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toasts"></div>
    
    <!-- Modals -->
    <!-- New Task Modal -->
    <div class="modal-overlay" id="modal-new-task">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Nueva tarea/levantamiento</h3>
                <button class="modal-close" data-close="modal-new-task">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <div class="col-8">
                        <div class="form-group">
                            <label class="form-label" for="nt-title">T√≠tulo</label>
                            <input type="text" class="form-control" id="nt-title" placeholder="T√≠tulo de la tarea">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-type">Tipo</label>
                            <select class="form-control" id="nt-type">
                                <option value="tarea">Tarea</option>
                                <option value="levantamiento">Levantamiento</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label" for="nt-desc">Descripci√≥n</label>
                            <textarea class="form-control" id="nt-desc" rows="3" placeholder="Descripci√≥n detallada de la tarea"></textarea>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-vis">Visibilidad</label>
                            <select class="form-control" id="nt-vis">
                                <option value="todos">Todos</option>
                                <option value="seleccionados">Seleccionados</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-leader">L√≠der</label>
                            <select class="form-control" id="nt-leader"></select>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-link">Enlace externo</label>
                            <input type="text" class="form-control" id="nt-link" placeholder="https://...">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-date">Fecha</label>
                            <input type="date" class="form-control" id="nt-date">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-time">Hora (24h)</label>
                            <input type="time" class="form-control" id="nt-time" step="60">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nt-file">Adjuntar Excel</label>
                            <input type="file" class="form-control" id="nt-file" accept=".xlsx,.xls,.csv">
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label">Inspectores</label>
                            <div id="nt-inspectors" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="modal-new-task">Cancelar</button>
                <button class="btn btn-primary" id="btn-save-nt">
                    <i class="fas fa-save"></i>
                    <span>Guardar</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- New Meeting Modal -->
    <div class="modal-overlay" id="modal-new-meeting">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Nueva reuni√≥n</h3>
                <button class="modal-close" data-close="modal-new-meeting">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <div class="col-8">
                        <div class="form-group">
                            <label class="form-label" for="nm-title">T√≠tulo</label>
                            <input type="text" class="form-control" id="nm-title" placeholder="T√≠tulo de la reuni√≥n">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="nm-date">Fecha</label>
                            <input type="date" class="form-control" id="nm-date">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label class="form-label" for="nm-start">Inicio (24h)</label>
                            <input type="time" class="form-control" id="nm-start" step="60">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label class="form-label" for="nm-end">T√©rmino (24h)</label>
                            <input type="time" class="form-control" id="nm-end" step="60">
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label" for="nm-agenda">Agenda</label>
                            <textarea class="form-control" id="nm-agenda" rows="2" placeholder="Agenda de la reuni√≥n"></textarea>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label">Asistentes</label>
                            <div id="nm-attendees" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close="modal-new-meeting">Cancelar</button>
                <button class="btn btn-primary" id="btn-save-nm">
                    <i class="fas fa-save"></i>
                    <span>Guardar</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Meeting Modal -->
    <div class="modal-overlay" id="modal-edit-meeting">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Editar reuni√≥n</h3>
                <button class="modal-close" data-close="modal-edit-meeting">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <div class="col-8">
                        <div class="form-group">
                            <label class="form-label" for="em-title">T√≠tulo</label>
                            <input type="text" class="form-control" id="em-title" placeholder="T√≠tulo de la reuni√≥n">
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-group">
                            <label class="form-label" for="em-date">Fecha</label>
                            <input type="date" class="form-control" id="em-date">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label class="form-label" for="em-start">Inicio (24h)</label>
                            <input type="time" class="form-control" id="em-start" step="60">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label class="form-label" for="em-end">T√©rmino (24h)</label>
                            <input type="time" class="form-control" id="em-end" step="60">
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group">
                            <label class="form-label" for="em-agenda">Agenda</label>
                            <textarea class="form-control" id="em-agenda" rows="2" placeholder="Agenda de la reuni√≥n"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="btn-pospone-em">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Posponer +1 d√≠a</span>
                </button>
                <button class="btn btn-secondary" data-close="modal-edit-meeting">Cancelar</button>
                <button class="btn btn-primary" id="btn-save-em">
                    <i class="fas fa-save"></i>
                    <span>Guardar cambios</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Task Detail Modal -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="md-title">Detalle de tarea</h3>
                <button class="modal-close" id="md-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="task-list" id="md-info"></div>
                
                <div style="margin: 20px 0 16px">
                    <h4 style="font-size: var(--font-size-md); font-weight: 600; margin-bottom: 16px;">Actividad y comentarios</h4>
                    <div class="task-list" id="md-comments"></div>
                    
                    <div style="margin-top: 16px; position: relative;">
                        <div class="input-group">
                            <input type="text" class="form-control" id="c-text" placeholder="Escribe con @usuario para mencionar">
                            <input type="file" id="c-file" style="display: none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('c-file').click()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="btn btn-success" id="btn-send-comment">
                                <i class="fas fa-paper-plane"></i>
                                <span>Enviar</span>
                            </button>
                        </div>
                        <div id="mention-box" class="mention-popup"></div>
                        <div id="file-name" style="margin-top: 8px; font-size: var(--font-size-xs); color: var(--text-light);"></div>
                    </div>
                </div>
                
                <div id="md-actions" class="row" style="margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap;"></div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
        // Supabase Configuration
        const SUPABASE_URL = "https://sxkfuojqnkczuztdwbcc.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4a2Z1b2pxbmtjenV6dGR3YmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjUwNDAsImV4cCI6MjA3MDcwMTA0MH0.ihVGKrYnhJFoCBITz8D-wqisc_7VYz10heoQOT4hLOQ";
        const BUCKET = "evidencias";
        
        let supabase = null;
        const hasValid = (() => {
            try {
                const u = new URL(SUPABASE_URL);
                return /^https:\/\/[a-z0-9-]+\.supabase\.co$/.test(u.origin) && /^eyJ/.test(SUPABASE_ANON_KEY);
            } catch {
                return false;
            }
        })();
        
        if (!hasValid) throw new Error("Config Supabase inv√°lida");
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global Variables
        let me = null, 
            users = [], 
            supervisors = [], 
            inspectors = [], 
            charts = {}, 
            currentTask = null, 
            calendar = null, 
            renderNonce = {}, 
            audioCtx = null, 
            editMeetingId = null;
        
        // Utility Functions
        function qs(s) { return document.querySelector(s); }
        function qsa(s) { return Array.from(document.querySelectorAll(s)); }
        
        function initials(s) { 
            return (s || "U").split(" ").map(x => x[0] || "").join("").slice(0, 2).toUpperCase();
        }
        
        function nameOf(id) {
            const u = users.find(x => x.id === id);
            return u ? u.full_name : "Usuario";
        }
        
        function formatDate(dateString) {
            if (!dateString) return "‚Äî";
            const date = new Date(dateString);
            return date.toLocaleString("es-ES", {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
        
        function toast(msg, kind = "info", actorName = "") {
            const box = qs("#toasts");
            const el = document.createElement("div");
            
            let iconClass = "fas fa-info-circle";
            if (kind === "ok") iconClass = "fas fa-check-circle";
            if (kind === "warn") iconClass = "fas fa-exclamation-triangle";
            if (kind === "bad") iconClass = "fas fa-times-circle";
            
            let toastClass = "toast";
            if (kind === "ok") toastClass += " toast-success";
            if (kind === "warn") toastClass += " toast-warning";
            if (kind === "bad") toastClass += " toast-error";
            
            el.className = toastClass;
            el.innerHTML = `
                <div class="toast-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${msg}</div>
                    <div class="toast-message">${actorName ? actorName + " ¬∑ " : ""}${new Date().toLocaleTimeString("es-ES", {hour12: false})}</div>
                </div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            el.querySelector(".toast-close").onclick = () => {
                el.classList.add("closing");
                setTimeout(() => el.remove(), 300);
            };
            
            box.appendChild(el);
            
            setTimeout(() => {
                if (el.parentNode) {
                    el.classList.add("closing");
                    setTimeout(() => el.parentNode && el.remove(), 300);
                }
            }, 7000);
            
            // Play sound only if audio context exists (created after user interaction)
            if (audioCtx) sound();
        }
        
        function sound() {
            try {
                if (!audioCtx) audioCtx = new AudioContext();
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = "sine";
                o.frequency.value = 920;
                o.connect(g);
                g.connect(audioCtx.destination);
                g.gain.setValueAtTime(0, audioCtx.currentTime);
                g.gain.linearRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
                g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.65);
                o.start();
                o.stop(audioCtx.currentTime + 0.65);
            } catch (e) {
                console.error("Sound error:", e);
            }
        }
        
        function canManage() {
            return ["supervisor_admin", "jefe_terminal", "supervisor"].includes(me.role);
        }
        
        function canCreateUsers() {
            return me.role === "supervisor_admin";
        }
        
// JavaScript para la navegaci√≥n del sidebar

// Funci√≥n para cambiar entre vistas
function switchView(viewId) {
    // Actualizar vistas activas
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const currentView = document.querySelector(`#view-${viewId}`);
    if (currentView) currentView.classList.add('active');
    
    // Actualizar navegaci√≥n
    document.querySelectorAll('.sidebar-nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewId);
    });
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewId);
    });
    
    // Cerrar sidebar en m√≥vil despu√©s de la navegaci√≥n
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('expanded');
    }
    
    // Cargar datos espec√≠ficos de la vista
    if (viewId === "calendario" && typeof renderCalendar === 'function') renderCalendar();
    if (viewId === "informes" && typeof renderReports === 'function') renderReports();
    if (viewId === "levantamientos" && typeof renderLevantamientos === 'function') renderLevantamientos();
    
    // Guardar la vista actual en localStorage para recordarla
    localStorage.setItem('currentView', viewId);
}

// Funci√≥n para alternar el sidebar en m√≥vil
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('expanded');
}

// Inicializar eventos cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    // Configurar eventos de navegaci√≥n
    document.querySelectorAll('[data-view]').forEach(item => {
        item.addEventListener('click', () => {
            const viewId = item.dataset.view;
            
            // Verificar permisos si es necesario (por ejemplo para la vista usuarios)
            if (viewId === "usuarios" && !(window.me && window.me.role === "supervisor_admin")) {
                if (typeof toast === 'function') {
                    toast("No tiene permisos para acceder a esta secci√≥n", "warn");
                } else {
                    alert("No tiene permisos para acceder a esta secci√≥n");
                }
                return;
            }
            
            switchView(viewId);
        });
    });
    
    // Configurar toggle del sidebar
    const sidebarToggle = document.getElementById('sidebar-toggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }
    
    // Restaurar la √∫ltima vista activa
    const lastView = localStorage.getItem('currentView');
    if (lastView) {
        switchView(lastView);
    }
    
    // Cerrar sidebar al hacer clic fuera de √©l en m√≥vil
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        
        if (window.innerWidth <= 768 && 
            sidebar && 
            sidebar.classList.contains('expanded') && 
            !sidebar.contains(e.target) && 
            sidebarToggle !== e.target &&
            !sidebarToggle.contains(e.target)) {
            sidebar.classList.remove('expanded');
        }
    });
});

// Exportar funciones para uso global
window.switchView = switchView;
window.toggleSidebar = toggleSidebar;
        
        // Combine date and time into ISO format
        function combineISO(d, t) {
            if (!d || !t) return null;
            return new Date(`${d}T${t}:00`).toISOString();
        }
        
        // Authentication Functions
        async function login() {
            const u = qs("#lg-user").value.trim();
            const p = qs("#lg-pass").value.trim();
            
            if (!u || !p) {
                toast("Por favor ingrese usuario y contrase√±a", "warn");
                return;
            }
            
            try {
                const { data, error } = await supabase.from("app_users")
                    .select("id, full_name, username, role, is_active")
                    .eq("username", u)
                    .eq("password", p)
                    .eq("is_active", true)
                    .single();
                
                if (error || !data) {
                    toast("Usuario o contrase√±a inv√°lidos", "bad");
                    return;
                }
                
                me = data;
                localStorage.setItem("sessionUser", JSON.stringify(me));
                
                // Create audio context after user interaction
                audioCtx = new AudioContext();
                
                enterApp();
                
            } catch (err) {
                console.error("Login error:", err);
                toast("Error en el inicio de sesi√≥n", "bad");
            }
        }
        
        function enterApp() {
            document.body.classList.remove("auth-no");
            document.body.classList.add("auth-yes");
            
            // Update UI with user info
            qs("#ui-name").textContent = me.full_name;
            qs("#ui-role").textContent = me.role;
            qs("#ui-avatar").textContent = initials(me.full_name);
            
            // Show admin features if applicable
            if (canCreateUsers()) qs("#btn-usuarios").classList.remove("hidden");
            
            // Initialize app data and features
            initRealtime();
            loadUsers().then(() => {
                populateSelectors();
                refreshAll();
                overdueScan();
                
                // Welcome toast
                setTimeout(() => {
                    toast(`Bienvenido al sistema, ${me.full_name}`, "ok");
                }, 1000);
            });
        }
        
        function leave() {
            if (confirm("¬øEst√° seguro que desea cerrar sesi√≥n?")) {
                localStorage.removeItem("sessionUser");
                document.body.classList.remove("auth-yes");
                document.body.classList.add("auth-no");
                
                // Clear fields
                qs("#lg-user").value = "";
                qs("#lg-pass").value = "";
            }
        }
        
        // User Management Functions
async function loadUsers() {
    try {
        const { data } = await supabase.from("app_users")
            .select("id, full_name, role, is_active")
            .eq("is_active", true)
            .order("full_name");
        
        users = data || [];
        supervisors = users.filter(x => ["supervisor", "supervisor_admin", "jefe_terminal"].includes(x.role));
        inspectors = users.filter(x => x.role === "inspector");
        
        renderUsers();
        updateNotificationsBadge();
        
        return users;
    } catch (err) {
        console.error("Error loading users:", err);
        toast("Error al cargar usuarios", "bad");
        return [];
    }
}

function renderUsers() {
    const box = qs("#list-users");
    if (!box) return;
    
    box.innerHTML = "";
    
    if (users.length === 0) {
        box.innerHTML = `
            <div class="task-item">
                <div class="task-item-content">
                    <div class="task-item-title">No hay usuarios registrados</div>
                </div>
            </div>
        `;
        return;
    }
    
    users.forEach(u => {
        const roleLabels = {
            'inspector': 'Inspector',
            'supervisor': 'Supervisor',
            'jefe_terminal': 'Jefe de Terminal',
            'supervisor_admin': 'Administrador'
        };
        
        const el = document.createElement("div");
        el.className = "task-item";
        el.innerHTML = `
            <div class="task-item-content">
                <div class="task-item-title">${u.full_name}</div>
                <div class="task-item-meta">
                    <span class="task-item-badge">
                        <i class="fas fa-user-tag"></i>
                        <span>${roleLabels[u.role] || u.role}</span>
                    </span>
                    <span class="task-item-badge ${u.is_active ? 'badge-completed' : 'badge-overdue'}">
                        <i class="fas fa-${u.is_active ? 'check-circle' : 'times-circle'}"></i>
                        <span>${u.is_active ? 'Activo' : 'Inactivo'}</span>
                    </span>
                </div>
            </div>
            <div class="task-item-actions">
                <button class="btn btn-sm btn-secondary user-details" data-id="${u.id}">
                    <i class="fas fa-eye"></i>
                    <span>Detalles</span>
                </button>
            </div>
        `;
        box.appendChild(el);
    });
    
    // Add event listeners
    qsa('.user-details').forEach(btn => {
        btn.addEventListener('click', () => {
            // Could implement user details view in the future
            toast("Funci√≥n en desarrollo", "info");
        });
    });
}

function populateSelectors() {
    // Leader selector for tasks
    const leaderSelect = qs("#nt-leader");
    leaderSelect.innerHTML = `<option value="">Ninguno</option>` + 
        supervisors.map(u => `<option value="${u.id}">${u.full_name}</option>`).join("");
    
    // Inspectors checkboxes
    const inspectorsDiv = qs("#nt-inspectors");
    inspectorsDiv.innerHTML = inspectors.map(u => `
        <label class="task-item-badge" style="margin-right: 8px; margin-bottom: 8px; cursor: pointer;">
            <input type="checkbox" value="${u.id}" style="margin-right: 5px;">
            ${u.full_name}
        </label>
    `).join("");
    
    // Attendees checkboxes for meetings
    const attendeesDiv = qs("#nm-attendees");
    attendeesDiv.innerHTML = users.map(u => `
        <label class="task-item-badge" style="margin-right: 8px; margin-bottom: 8px; cursor: pointer;">
            <input type="checkbox" value="${u.id}" style="margin-right: 5px;">
            ${u.full_name}
        </label>
    `).join("");
}

async function addUser() {
    if (!canCreateUsers()) {
        toast("Sin permisos para crear usuarios", "bad");
        return;
    }
    
    const full_name = qs("#u-name").value.trim();
    const username = qs("#u-user").value.trim();
    const password = qs("#u-pass").value.trim();
    const role = qs("#u-role").value;
    
    if (!full_name || !username || !password) {
        toast("Todos los campos son obligatorios", "warn");
        return;
    }
    
    try {
        const { error } = await supabase.from("app_users").insert([{
            full_name,
            username,
            password,
            role,
            is_active: true
        }]);
        
        if (error) {
            console.error("Error creating user:", error);
            toast("Error al crear usuario: " + (error.message || "Error desconocido"), "bad");
            return;
        }
        
        // Clear form
        ["#u-name", "#u-user", "#u-pass"].forEach(s => qs(s).value = "");
        qs("#u-role").value = "inspector";
        
        toast("Usuario creado exitosamente", "ok", me.full_name);
        loadUsers();
        
    } catch (err) {
        console.error("Error in addUser:", err);
        toast("Error al crear usuario", "bad");
    }
}

// File Upload Functions
async function uploadFile(file, prefix) {
    if (!file) return null;
    
    try {
        const path = `${prefix}/${Date.now()}_${file.name}`;
        const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert: false });
        
        if (error) {
            console.error("Upload error:", error);
            toast("Error al subir archivo", "bad");
            return null;
        }
        
        const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
        return data.publicUrl;
        
    } catch (err) {
        console.error("Error in uploadFile:", err);
        toast("Error al subir archivo", "bad");
        return null;
    }
}

// Task Management Functions
async function createTask() {
    if (!canManage()) {
        toast("Sin permisos para crear tareas", "bad");
        return;
    }
    
    const title = qs("#nt-title").value.trim();
    const desc = qs("#nt-desc").value.trim();
    const type = qs("#nt-type").value;
    const vis = qs("#nt-vis").value;
    const leader = qs("#nt-leader").value || null;
    const link = qs("#nt-link").value.trim() || null;
    const due = combineISO(qs("#nt-date").value, qs("#nt-time").value);
    
    if (!title) {
        toast("El t√≠tulo es obligatorio", "warn");
        return;
    }
    
    if (type === "levantamiento" && !leader) {
        toast("El l√≠der es obligatorio para levantamientos", "warn");
        return;
    }
    
    try {
        // Get selected inspectors
        const assignees = Array.from(qs("#nt-inspectors").querySelectorAll("input:checked")).map(i => i.value);
        
        // Upload file if provided
        const file = qs("#nt-file").files[0];
        const fileUrl = await uploadFile(file, me.id);
        
        // Create the task
        const { data, error } = await supabase.from("tasks").insert([{
            title,
            description: desc,
            type,
            visibility: vis,
            leader_id: leader,
            created_by: me.id,
            due_date: due,
            attachment_url: fileUrl,
            link_url: link,
            status: "pendiente",
            approval_status: "ninguna"
        }]).select("id").single();
        
        if (error) {
            console.error("Error creating task:", error);
            toast("Error al crear tarea", "bad");
            return;
        }
        
        // Create assignees records if there are any
        if (assignees.length) {
            await supabase.from("task_assignees").insert(
                assignees.map(userId => ({
                    task_id: data.id,
                    user_id: userId
                }))
            );
        }
        
        closeModal("modal-new-task");
        clearNewTask();
        toast("Tarea creada exitosamente", "ok", me.full_name);
        sound();
        refreshAll();
        
    } catch (err) {
        console.error("Error in createTask:", err);
        toast("Error al crear tarea", "bad");
    }
}

function clearNewTask() {
    ["#nt-title", "#nt-desc", "#nt-link", "#nt-date", "#nt-time"].forEach(s => qs(s).value = "");
    qs("#nt-type").value = "tarea";
    qs("#nt-vis").value = "todos";
    qs("#nt-leader").value = "";
    qs("#nt-file").value = "";
    qs("#nt-inspectors").querySelectorAll("input").forEach(i => i.checked = false);
}

// Meeting Management Functions
async function createMeeting() {
    if (!canManage()) {
        toast("Sin permisos para crear reuniones", "bad");
        return;
    }
    
    const title = qs("#nm-title").value.trim();
    const date = qs("#nm-date").value;
    const start = qs("#nm-start").value;
    const end = qs("#nm-end").value;
    const agenda = qs("#nm-agenda").value.trim() || null;
    
    if (!title || !date || !start || !end) {
        toast("T√≠tulo, fecha y horas son obligatorios", "warn");
        return;
    }
    
    try {
        const startISO = combineISO(date, start);
        const endISO = combineISO(date, end);
        
        // Get selected attendees
        const attendees = Array.from(qs("#nm-attendees").querySelectorAll("input:checked")).map(i => i.value);
        
        // Create the meeting
        const { data, error } = await supabase.from("meetings").insert([{
            title,
            start_at: startISO,
            end_at: endISO,
            agenda,
            created_by: me.id
        }]).select("id").single();
        
        if (error) {
            console.error("Error creating meeting:", error);
            toast("Error al crear reuni√≥n", "bad");
            return;
        }
        
        // Create attendees records if there are any
        if (attendees.length) {
            await supabase.from("meeting_attendees").insert(
                attendees.map(userId => ({
                    meeting_id: data.id,
                    user_id: userId
                }))
            );
        }
        
        closeModal("modal-new-meeting");
        clearNewMeeting();
        toast("Reuni√≥n creada exitosamente", "ok", me.full_name);
        sound();
        renderMeetings();
        loadKPIs();
        renderCalendar();
        
    } catch (err) {
        console.error("Error in createMeeting:", err);
        toast("Error al crear reuni√≥n", "bad");
    }
}

function clearNewMeeting() {
    ["#nm-title", "#nm-date", "#nm-start", "#nm-end", "#nm-agenda"].forEach(s => qs(s).value = "");
    qs("#nm-attendees").querySelectorAll("input").forEach(i => i.checked = false);
}

// Task Data Functions
async function fetchTasks(filterStatus = "") {
    try {
        let query = supabase.from("tasks")
            .select("id, title, description, type, visibility, status, approval_status, leader_id, created_at, due_date, attachment_url, link_url, created_by")
            .order("created_at", { ascending: false });
        
        if (filterStatus) {
            query = query.eq("status", filterStatus);
        }
        
        const { data: tasks } = await query;
        
        // Get task assignees
        const { data: assignees } = await supabase.from("task_assignees").select("task_id, user_id");
        
        // Create a map of task_id -> [user_ids]
        const assigneesMap = {};
        if (assignees) {
            assignees.forEach(a => {
                if (!assigneesMap[a.task_id]) {
                    assigneesMap[a.task_id] = [];
                }
                assigneesMap[a.task_id].push(a.user_id);
            });
        }
        
        // Combine tasks with their assignees
        return (tasks || []).map(task => ({
            ...task,
            assignees: assigneesMap[task.id] || []
        }));
        
    } catch (err) {
        console.error("Error fetching tasks:", err);
        toast("Error al cargar tareas", "bad");
        return [];
    }
}

function visibleToMe(task) {
    // Public tasks are visible to everyone
    if (task.visibility === "todos") return true;
    
    // Tasks are visible to assignees, creator, leader, and managers
    return task.assignees.includes(me.id) || 
           task.created_by === me.id || 
           task.leader_id === me.id || 
           canManage();
}

// Task Rendering Functions
async function renderTaskList(containerId) {
    const nonce = (renderNonce[containerId] || 0) + 1;
    renderNonce[containerId] = nonce;
    
    const container = qs(containerId);
    const filterStatus = containerId === "#list-dashboard" ? qs("#flt-status").value : qs("#flt-tasks").value;
    const scope = containerId === "#list-tasks" ? qs("#flt-vis").value : "todas";
    
    // Show loading state
    container.innerHTML = `
        <div class="task-item">
            <div class="task-item-content">
                <div class="task-item-title">Cargando tareas...</div>
                <div class="task-item-meta">
                    <span class="task-item-badge">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Espere por favor</span>
                    </span>
                </div>
            </div>
        </div>
    `;
    
    try {
        const tasks = await fetchTasks(filterStatus);
        
        // Check if this render is still valid (no newer render was started)
        if (renderNonce[containerId] !== nonce) return;
        
        // Filter tasks
        const filteredTasks = tasks.filter(t => 
            visibleToMe(t) && 
            (scope === "mias" ? (t.assignees.includes(me.id) || t.leader_id === me.id || t.created_by === me.id) : true)
        );
        
        container.innerHTML = "";
        
        if (filteredTasks.length === 0) {
            container.innerHTML = `
                <div class="task-item">
                    <div class="task-item-content">
                        <div class="task-item-title">No hay tareas disponibles</div>
                        <div class="task-item-meta">
                            <span class="task-item-badge">
                                <i class="fas fa-info-circle"></i>
                                <span>Puede crear una nueva tarea con el bot√≥n "Nueva tarea"</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
            return;
        }
        
        filteredTasks.forEach(task => {
            const assignees = task.assignees.map(id => nameOf(id)).join(", ");
            const leader = task.leader_id ? nameOf(task.leader_id) : "‚Äî";
            const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== "terminada";
            
            let statusClass = "";
            if (task.status === "pendiente") statusClass = "task-item-status-pending";
            else if (task.status === "en_curso") statusClass = "task-item-status-progress";
            else if (task.status === "terminada") statusClass = "task-item-status-completed";
            
            if (isOverdue) statusClass = "task-item-status-overdue";
            
            const row = document.createElement("div");
            row.className = `task-item ${statusClass}`;
            row.innerHTML = `
                <div class="task-item-content">
                    <div class="task-item-title">${task.title}</div>
                    <div class="task-item-meta">
                        <span class="task-item-badge">
                            <i class="fas fa-${task.type === 'tarea' ? 'tasks' : 'clipboard-list'}"></i>
                            <span>${task.type}</span>
                        </span>
                        <span class="task-item-badge">
                            <i class="fas fa-user"></i>
                            <span>L√≠der: ${leader}</span>
                        </span>
                        ${assignees ? `
                            <span class="task-item-badge">
                                <i class="fas fa-users"></i>
                                <span>Asignados: ${assignees}</span>
                            </span>
                        ` : ''}
                        ${task.due_date ? `
                            <span class="task-item-badge ${isOverdue ? 'badge-overdue' : ''}">
                                <i class="fas fa-${isOverdue ? 'exclamation-triangle' : 'calendar-alt'}"></i>
                                <span>${formatDate(task.due_date)}</span>
                            </span>
                        ` : ''}
                        <span class="task-item-badge badge-${
                            task.status === 'pendiente' ? 'pending' : 
                            task.status === 'en_curso' ? 'progress' : 'completed'
                        }">
                            <i class="fas fa-${
                                task.status === 'pendiente' ? 'clock' : 
                                task.status === 'en_curso' ? 'spinner' : 'check-circle'
                            }"></i>
                            <span>${task.status.replace('_', ' ')}</span>
                        </span>
                    </div>
                </div>
                <div class="task-item-actions">
                    <button class="btn btn-sm btn-primary" onclick="openTask('${task.id}')">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Abrir</span>
                    </button>
                </div>
            `;
            
            container.appendChild(row);
        });
        
    } catch (err) {
        console.error("Error rendering task list:", err);
        container.innerHTML = `
            <div class="task-item task-item-status-overdue">
                <div class="task-item-content">
                    <div class="task-item-title">Error al cargar tareas</div>
                    <div class="task-item-meta">
                        <span class="task-item-badge badge-overdue">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Ocurri√≥ un error al cargar las tareas</span>
                        </span>
                    </div>
                </div>
            </div>
        `;
    }
}

async function renderLevantamientos() {
    try {
        const tasks = (await fetchTasks("")).filter(t => 
            t.type === "levantamiento" && visibleToMe(t)
        );
        
        // Render levantamiento list
        const listContainer = qs("#lev-list");
        listContainer.innerHTML = "";
        
        if (tasks.length === 0) {
            listContainer.innerHTML = `
                <div class="task-item">
                    <div class="task-item-content">
                        <div class="task-item-title">No hay levantamientos disponibles</div>
                        <div class="task-item-meta">
                            <span class="task-item-badge">
                                <i class="fas fa-info-circle"></i>
                                <span>Puede crear un nuevo levantamiento con el bot√≥n "Crear Levantamiento"</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            tasks.forEach(task => {
                const el = document.createElement("div");
                el.className = "task-item";
                
                let statusClass = "";
                if (task.status === "pendiente") statusClass = "badge-pending";
                else if (task.status === "en_curso") statusClass = "badge-progress";
                else if (task.status === "terminada") statusClass = "badge-completed";
                
                el.innerHTML = `
                    <div class="task-item-content">
                        <div class="task-item-title">${task.title}</div>
                        <div class="task-item-meta">
                            <span class="task-item-badge">
                                <i class="fas fa-user"></i>
                                <span>L√≠der: ${task.leader_id ? nameOf(task.leader_id) : "‚Äî"}</span>
                            </span>
                            <span class="task-item-badge ${statusClass}">
                                <i class="fas fa-${
                                    task.status === 'pendiente' ? 'clock' : 
                                    task.status === 'en_curso' ? 'spinner' : 'check-circle'
                                }"></i>
                                <span>${task.status.replace('_', ' ')}</span>
                            </span>
                            ${task.description ? `
                                <span class="task-item-badge">
                                    <i class="fas fa-align-left"></i>
                                    <span>${task.description.substring(0, 30)}${task.description.length > 30 ? '...' : ''}</span>
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="task-item-actions">
                        ${task.link_url ? `
                            <a href="${task.link_url}" target="_blank" class="btn btn-sm btn-secondary">
                                <i class="fas fa-external-link-alt"></i>
                                <span>Enlace</span>
                            </a>
                        ` : ''}
                        <button class="btn btn-sm btn-primary" onclick="openTask('${task.id}')">
                            <i class="fas fa-folder-open"></i>
                            <span>Abrir</span>
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(el);
            });
        }
        
        // Render quick access links
        const linksContainer = qs("#lev-links");
        linksContainer.innerHTML = "";
        
        const taskWithLinks = tasks.filter(t => t.link_url).slice(0, 6);
        
        if (taskWithLinks.length === 0) {
            linksContainer.innerHTML = `
                <div class="card">
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; color: var(--text-light);"></i>
                        <p>No hay enlaces de acceso r√°pido disponibles</p>
                    </div>
                </div>
            `;
        } else {
            taskWithLinks.forEach(task => {
                const c = document.createElement("div");
                c.className = "card";
                c.style.display = "flex";
                c.style.flexDirection = "column";
                c.style.justifyContent = "space-between";
                c.style.height = "180px";
                
                let statusClass = "";
                if (task.status === "pendiente") statusClass = "badge-pending";
                else if (task.status === "en_curso") statusClass = "badge-progress";
                else if (task.status === "terminada") statusClass = "badge-completed";
                
                c.innerHTML = `
                    <div>
                        <div style="font-weight: 600; font-size: var(--font-size-md); margin-bottom: 12px;">${task.title}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                            <span class="task-item-badge ${statusClass}">
                                <i class="fas fa-${
                                    task.status === 'pendiente' ? 'clock' : 
                                    task.status === 'en_curso' ? 'spinner' : 'check-circle'
                                }"></i>
                                <span>${task.status.replace('_', ' ')}</span>
                            </span>
                            <span class="task-item-badge">
                                <i class="fas fa-user"></i>
                                <span>L√≠der: ${task.leader_id ? nameOf(task.leader_id).split(' ')[0] : "‚Äî"}</span>
                            </span>
                        </div>
                        ${task.description ? `
                            <p style="font-size: var(--font-size-sm); color: var(--text-light); margin-bottom: 12px;">
                                ${task.description.substring(0, 60)}${task.description.length > 60 ? '...' : ''}
                            </p>
                        ` : ''}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <a href="${task.link_url}" target="_blank" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-external-link-alt"></i>
                            <span>Ir al levantamiento</span>
                        </a>
                        <button class="btn btn-secondary" onclick="openTask('${task.id}')">
                            <i class="fas fa-folder-open"></i>
                        </button>
                    </div>
                `;
                
                linksContainer.appendChild(c);
            });
        }
        
    } catch (err) {
        console.error("Error rendering levantamientos:", err);
        toast("Error al cargar levantamientos", "bad");
    }
}

// Task Detail Functions
async function openTask(id) {
    currentTask = id;
    
    try {
        const { data: task } = await supabase.from("tasks")
            .select("*")
            .eq("id", id)
            .single();
        
        if (!task) {
            toast("Tarea no encontrada", "bad");
            return;
        }
        
        // Set task title
        qs("#md-title").textContent = task.title;
        
        // Render task info
        const infoContainer = qs("#md-info");
        infoContainer.innerHTML = "";
        
        const statusColors = {
            'pendiente': 'badge-pending',
            'en_curso': 'badge-progress',
            'terminada': 'badge-completed'
        };
        
        const approvalColors = {
            'ninguna': '',
            'aprobada': 'badge-completed',
            'posponer': 'badge-pending',
            'extender': 'badge-progress'
        };
        
        const fields = [
            ["Descripci√≥n", task.description || "‚Äî"],
            ["Tipo", `<span class="task-item-badge">${task.type}</span>`],
            ["Estado", `<span class="task-item-badge ${statusColors[task.status] || ''}">${task.status.replace('_', ' ')}</span>`],
            ["Aprobaci√≥n", `<span class="task-item-badge ${approvalColors[task.approval_status] || ''}">${task.approval_status}</span>`],
            ["L√≠der", task.leader_id ? nameOf(task.leader_id) : "‚Äî"],
            ["Fecha l√≠mite", task.due_date ? formatDate(task.due_date) : "‚Äî"],
            ["Creado", formatDate(task.created_at)],
            ["Creado por", nameOf(task.created_by)]
        ];
        
        if (task.attachment_url) {
            fields.push(["Adjunto", `<a href="${task.attachment_url}" target="_blank" class="task-item-badge"><i class="fas fa-file-download"></i> Ver adjunto</a>`]);
        }
        
        if (task.link_url) {
            fields.push(["Enlace", `<a href="${task.link_url}" target="_blank" class="task-item-badge"><i class="fas fa-external-link-alt"></i> ${task.link_url}</a>`]);
        }
        
        // Get assignees
        const { data: assignees } = await supabase.from("task_assignees")
            .select("user_id")
            .eq("task_id", id);
        
        if (assignees && assignees.length > 0) {
            const assigneeNames = assignees.map(a => nameOf(a.user_id)).join(", ");
            fields.push(["Asignados", assigneeNames]);
        }
        
        fields.forEach(([key, value]) => {
            const el = document.createElement("div");
            el.className = "task-item";
            el.innerHTML = `
                <div style="font-weight: 500; color: var(--text-light);">${key}</div>
                <div>${value}</div>
            `;
            infoContainer.appendChild(el);
        });
        
        // Set up action buttons
        const actionsContainer = qs("#md-actions");
        actionsContainer.innerHTML = "";
        
        // Only show status change buttons if user has permission
        const canChangeStatus = task.assignees?.includes(me.id) || 
                               task.created_by === me.id || 
                               task.leader_id === me.id || 
                               canManage();
        
        if (canChangeStatus) {
            const statusButtons = [
                { status: "pendiente", label: "Pendiente", icon: "clock", class: "secondary" },
                { status: "en_curso", label: "En Curso", icon: "spinner", class: "primary" },
                { status: "terminada", label: "Terminada", icon: "check", class: "success" }
            ];
            
            statusButtons.forEach(btn => {
                if (task.status !== btn.status) {
                    const button = document.createElement("button");
                    button.className = `btn btn-${btn.class}`;
                    button.innerHTML = `<i class="fas fa-${btn.icon}"></i> <span>${btn.label}</span>`;
                    button.onclick = () => updateStatus(id, btn.status);
                    actionsContainer.appendChild(button);
                }
            });
        }
        
        // Approval buttons for managers
        if (canManage()) {
            const hr = document.createElement("div");
            hr.style.width = "100%";
            hr.style.height = "1px";
            hr.style.backgroundColor = "var(--border)";
            hr.style.margin = "10px 0";
            actionsContainer.appendChild(hr);
            
            const approvalButtons = [
                { status: "ninguna", label: "Sin Aprobaci√≥n", icon: "ban", class: "secondary" },
                { status: "aprobada", label: "Aprobar", icon: "check-circle", class: "success" },
                { status: "posponer", label: "Posponer", icon: "clock", class: "warning" },
                { status: "extender", label: "Extender", icon: "expand", class: "primary" }
            ];
            
            approvalButtons.forEach(btn => {
                if (task.approval_status !== btn.status) {
                    const button = document.createElement("button");
                    button.className = `btn btn-${btn.class}`;
                    button.innerHTML = `<i class="fas fa-${btn.icon}"></i> <span>${btn.label}</span>`;
                    button.onclick = () => updateApproval(id, btn.status);
                    actionsContainer.appendChild(button);
                }
            });
        }
        
        // Render comments
        await renderComments(id);
        
        // Show the modal
        openModal("task-modal");
        
    } catch (err) {
        console.error("Error opening task:", err);
        toast("Error al abrir tarea", "bad");
    }
}

async function renderComments(taskId) {
    try {
        const { data: comments } = await supabase.from("task_comments")
            .select("id, user_id, content, file_url, created_at")
            .eq("task_id", taskId)
            .order("created_at");
        
        const commentsContainer = qs("#md-comments");
        commentsContainer.innerHTML = "";
        
        if (!comments || comments.length === 0) {
            commentsContainer.innerHTML = `
                <div class="task-item" style="text-align: center; color: var(--text-light);">
                    <i class="fas fa-comments" style="font-size: 20px; margin-bottom: 10px;"></i>
                    <p>No hay comentarios a√∫n. S√© el primero en comentar.</p>
                </div>
            `;
            return;
        }
        
        comments.forEach(comment => {
            let content = comment.content || "";
            let isSystem = false;
            let systemLabel = "";
            let systemIcon = "";
            
            if (content.startsWith("::status::")) {
                isSystem = true;
                const status = content.replace("::status::", "");
                systemLabel = `cambi√≥ estado a ${status}`;
                
                if (status === "pendiente") systemIcon = "clock";
                else if (status === "en_curso") systemIcon = "spinner";
                else if (status === "terminada") systemIcon = "check-circle";
            }
            
            if (content.startsWith("::approval::")) {
                isSystem = true;
                const approval = content.replace("::approval::", "");
                systemLabel = `actualiz√≥ aprobaci√≥n a ${approval}`;
                
                if (approval === "ninguna") systemIcon = "ban";
                else if (approval === "aprobada") systemIcon = "check-circle";
                else if (approval === "posponer") systemIcon = "clock";
                else if (approval === "extender") systemIcon = "expand";
            }
            
            const who = nameOf(comment.user_id);
            
            const el = document.createElement("div");
            el.className = "task-item";
            
            if (isSystem) {
                el.style.background = "var(--panel-bg-alt)";
                el.style.borderStyle = "dashed";
                
                el.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="user-avatar" style="width: 28px; height: 28px; font-size: var(--font-size-xs);">
                            ${initials(who)}
                        </div>
                        <div>
                            <strong>${who}</strong> ${systemLabel}
                            <div style="color: var(--text-light); font-size: var(--font-size-xs);">
                                <i class="fas fa-${systemIcon}"></i> ${formatDate(comment.created_at)}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const formattedContent = highlightMentions(content);
                
                el.innerHTML = `
                    <div style="display: flex; gap: 10px;">
                        <div class="user-avatar" style="width: 28px; height: 28px; font-size: var(--font-size-xs);">
                            ${initials(who)}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${who}</strong>
                                <span style="color: var(--text-light); font-size: var(--font-size-xs);">
                                    ${formatDate(comment.created_at)}
                                </span>
                            </div>
                            <div style="margin-top: 4px; font-size: var(--font-size);">
                                ${formattedContent || ""}
                                ${comment.file_url ? `
                                    <div style="margin-top: 8px;">
                                        <a href="${comment.file_url}" target="_blank" class="task-item-badge">
                                            <i class="fas fa-paperclip"></i> Ver archivo adjunto
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            commentsContainer.appendChild(el);
        });
        
        // Scroll to bottom of comments
        commentsContainer.scrollTop = commentsContainer.scrollHeight;
        
    } catch (err) {
        console.error("Error rendering comments:", err);
        toast("Error al cargar comentarios", "bad");
    }
}

function highlightMentions(text) {
    if (!text) return "";
    return text.replace(/@([^\s@,.;:]+)/g, (match, username) => {
        const mentioned = users.find(u => 
            u.full_name.toLowerCase().includes(username.toLowerCase())
        );
        
        if (mentioned) {
            return `<span class="task-item-badge badge-progress"><i class="fas fa-at"></i> ${mentioned.full_name}</span>`;
        }
        
        return match;
    });
}

async function sendComment() {
    if (!currentTask) return;
    
    const text = qs("#c-text").value.trim();
    const file = qs("#c-file").files[0];
    
    if (!text && !file) {
        toast("Ingrese un comentario o adjunte un archivo", "warn");
        return;
    }
    
    try {
        // Upload file if provided
        const fileUrl = await uploadFile(file, me.id);
        
        // Create comment
        await supabase.from("task_comments").insert([{
            task_id: currentTask,
            user_id: me.id,
            content: text || null,
            file_url: fileUrl || null
        }]);
        
        // Clear inputs
        qs("#c-text").value = "";
        qs("#c-file").value = "";
        qs("#file-name").textContent = "";
        
        // Refresh comments
        renderComments(currentTask);
        
        toast("Comentario enviado", "ok", me.full_name);
        
    } catch (err) {
        console.error("Error sending comment:", err);
        toast("Error al enviar comentario", "bad");
    }
}

// Task Status Update Functions
async function updateStatus(id, status) {
    try {
        // Update task status
        await supabase.from("tasks").update({
            status: status,
            updated_at: new Date().toISOString()
        }).eq("id", id);
        
        // Add system comment
        await supabase.from("task_comments").insert([{
            task_id: id,
            user_id: me.id,
            content: "::status::" + status
        }]);
        
        toast(`Estado actualizado a ${status}`, "ok", me.full_name);
        sound();
        
        // Refresh UI
        refreshAllIfOpen();
        renderComments(id);
        
    } catch (err) {
        console.error("Error updating status:", err);
        toast("Error al actualizar estado", "bad");
    }
}

async function updateApproval(id, approval) {
    if (!canManage()) {
        toast("Sin permisos para cambiar aprobaci√≥n", "bad");
        return;
    }
    
    try {
        // Update task approval status
        await supabase.from("tasks").update({
            approval_status: approval,
            updated_at: new Date().toISOString()
        }).eq("id", id);
        
        // Add system comment
        await supabase.from("task_comments").insert([{
            task_id: id,
            user_id: me.id,
            content: "::approval::" + approval
        }]);
        
        toast(`Aprobaci√≥n: ${approval}`, "ok", me.full_name);
        sound();
        
        // Refresh UI
        refreshAllIfOpen();
        renderComments(id);
        
    } catch (err) {
        console.error("Error updating approval:", err);
        toast("Error al actualizar aprobaci√≥n", "bad");
    }
}

// Meeting Functions
async function renderMeetings() {
    try {
        const now = new Date().toISOString();
        
        const { data: meetings } = await supabase.from("meetings")
            .select("id, title, start_at, end_at, agenda, created_by")
            .gte("end_at", now)
            .order("start_at");
        
        const meetingsContainer = qs("#list-meetings");
        const dashboardMeetingsContainer = qs("#list-next-meet");
        
        meetingsContainer.innerHTML = "";
        dashboardMeetingsContainer.innerHTML = "";
        
        if (!meetings || meetings.length === 0) {
            const emptyMessage = `
                <div class="task-item">
                    <div class="task-item-content">
                        <div class="task-item-title">No hay reuniones programadas</div>
                        <div class="task-item-meta">
                            <span class="task-item-badge">
                                <i class="fas fa-info-circle"></i>
                                <span>Puede crear una nueva reuni√≥n con el bot√≥n "Nueva Reuni√≥n"</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            meetingsContainer.innerHTML = emptyMessage;
            dashboardMeetingsContainer.innerHTML = emptyMessage;
            return;
        }
        
        meetings.forEach(meeting => {
            const startDate = new Date(meeting.start_at);
            const endDate = new Date(meeting.end_at);
            
            // Format dates
            const formattedDate = startDate.toLocaleDateString("es-ES");
            const formattedStartTime = startDate.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: false
            });
            const formattedEndTime = endDate.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: false
            });
            
            // Create meeting item for meetings view
            const meetingItem = document.createElement("div");
            meetingItem.className = "meeting-item";
            meetingItem.innerHTML = `
                <div class="meeting-item-content">
                    <div class="meeting-item-title">${meeting.title}</div>
                    <div class="meeting-item-meta">
                        <span class="meeting-item-badge">
                            <i class="fas fa-calendar-alt"></i>
                            <span>${formattedDate}</span>
                        </span>
                        <span class="meeting-item-badge">
                            <i class="fas fa-clock"></i>
                            <span>${formattedStartTime} - ${formattedEndTime}</span>
                        </span>
                        <span class="meeting-item-badge">
                            <i class="fas fa-user"></i>
                            <span>Creador: ${nameOf(meeting.created_by)}</span>
                        </span>
                    </div>
                    ${meeting.agenda ? `
                        <div style="margin-top: 8px; font-size: var(--font-size-sm); color: var(--text-light);">
                            <i class="fas fa-clipboard-list"></i> ${meeting.agenda}
                        </div>
                    ` : ''}
                </div>
                <div class="meeting-item-actions">
                    <button class="btn btn-sm btn-primary" onclick="openEditMeeting('${meeting.id}')">
                        <i class="fas fa-edit"></i>
                        <span>Editar</span>
                    </button>
                </div>
            `;
            
            // Create simplified version for dashboard
            const dashboardItem = document.createElement("div");
            dashboardItem.className = "meeting-item";
            dashboardItem.innerHTML = `
                <div class="meeting-item-content">
                    <div class="meeting-item-title">${meeting.title}</div>
                    <div class="meeting-item-meta">
                        <span class="meeting-item-badge">
                            <i class="fas fa-calendar-alt"></i>
                            <span>${formattedDate}</span>
                        </span>
                        <span class="meeting-item-badge">
                            <i class="fas fa-clock"></i>
                            <span>${formattedStartTime}</span>
                        </span>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="openEditMeeting('${meeting.id}')">
                    <i class="fas fa-edit"></i>
                    <span>Editar</span>
                </button>
            `;
            
            meetingsContainer.appendChild(meetingItem);
            dashboardMeetingsContainer.appendChild(dashboardItem);
        });
        
    } catch (err) {
        console.error("Error rendering meetings:", err);
        toast("Error al cargar reuniones", "bad");
    }
}

async function openEditMeeting(id) {
    editMeetingId = id;
    
    try {
        const { data: meeting } = await supabase.from("meetings")
            .select("*")
            .eq("id", id)
            .single();
        
        if (!meeting) {
            toast("Reuni√≥n no encontrada", "bad");
            return;
        }
        
        // Set form values
        qs("#em-title").value = meeting.title;
        
        const startDate = new Date(meeting.start_at);
        qs("#em-date").value = startDate.toISOString().slice(0, 10);
        qs("#em-start").value = startDate.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false
        });
        
        const endDate = new Date(meeting.end_at);
        qs("#em-end").value = endDate.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false
        });
        
        qs("#em-agenda").value = meeting.agenda || "";
        
        // Show modal
        openModal("modal-edit-meeting");
        
    } catch (err) {
        console.error("Error opening edit meeting:", err);
        toast("Error al abrir reuni√≥n", "bad");
    }
}

async function saveEditMeeting() {
    if (!editMeetingId) return;
    
    const title = qs("#em-title").value.trim();
    const date = qs("#em-date").value;
    const start = qs("#em-start").value;
    const end = qs("#em-end").value;
    const agenda = qs("#em-agenda").value.trim() || null;
    
    if (!title || !date || !start || !end) {
        toast("T√≠tulo, fecha y horas son obligatorios", "warn");
        return;
    }
    
    try {
        const startISO = combineISO(date, start);
        const endISO = combineISO(date, end);
        
        // Update meeting
        await supabase.from("meetings").update({
            title,
            start_at: startISO,
            end_at: endISO,
            agenda
        }).eq("id", editMeetingId);
        
        closeModal("modal-edit-meeting");
        toast("Reuni√≥n actualizada", "ok", me.full_name);
        sound();
        renderMeetings();
        renderCalendar();
        
    } catch (err) {
        console.error("Error saving meeting:", err);
        toast("Error al guardar reuni√≥n", "bad");
    }
}

async function posponeEditMeeting() {
    if (!editMeetingId) return;
    
    try {
        // Get current meeting data
        const { data: meeting } = await supabase.from("meetings")
            .select("*")
            .eq("id", editMeetingId)
            .single();
        
        if (!meeting) {
            toast("Reuni√≥n no encontrada", "bad");
            return;
        }
        
        // Add 1 day to dates
        const startDate = new Date(meeting.start_at);
        startDate.setDate(startDate.getDate() + 1);
        
        const endDate = new Date(meeting.end_at);
        endDate.setDate(endDate.getDate() + 1);
        
        // Update meeting
        await supabase.from("meetings").update({
            start_at: startDate.toISOString(),
            end_at: endDate.toISOString()
        }).eq("id", editMeetingId);
        
        closeModal("modal-edit-meeting");
        toast("Reuni√≥n pospuesta +1 d√≠a", "warn", me.full_name);
        renderMeetings();
        renderCalendar();
        
    } catch (err) {
        console.error("Error postponing meeting:", err);
        toast("Error al posponer reuni√≥n", "bad");
    }
}

// KPI Functions
async function loadKPIs() {
    try {
        // Get pending tasks
        const { data: pendingTasks } = await supabase.from("tasks")
            .select("status, due_date")
            .eq("status", "pendiente");
        
        // Get in-progress tasks
        const { data: inProgressTasks } = await supabase.from("tasks")
            .select("status")
            .eq("status", "en_curso");
        
        // Get completed tasks
        const { data: completedTasks } = await supabase.from("tasks")
            .select("status")
            .eq("status", "terminada");
        
        // Count overdue tasks
        const overdueTasks = (pendingTasks || [])
            .filter(t => t.due_date && new Date(t.due_date) < new Date())
            .length;
        
        // Get upcoming meetings
        const now = new Date().toISOString();
        const { data: meetings } = await supabase.from("meetings")
            .select("id")
            .gte("end_at", now);
        
        // Update KPI values with animation
        animateCounter("kpi-p", (pendingTasks || []).length);
        animateCounter("kpi-e", (inProgressTasks || []).length);
        animateCounter("kpi-t", (completedTasks || []).length);
        animateCounter("kpi-o", overdueTasks);
        animateCounter("kpi-r", (meetings || []).length);
        
        // Update notifications badge
        updateNotificationsBadge(overdueTasks);
        
    } catch (err) {
        console.error("Error loading KPIs:", err);
    }
}

function animateCounter(elementId, targetValue) {
    const element = qs(`#${elementId}`);
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const duration = 1000;
    const startTime = performance.now();
    
    function updateCounter(currentTime) {
        const elapsedTime = currentTime - startTime;
        
        if (elapsedTime < duration) {
            const progress = elapsedTime / duration;
            const easedProgress = 1 - Math.pow(1 - progress, 3); // Cubic ease-out
            const currentValue = Math.floor(startValue + (targetValue - startValue) * easedProgress);
            
            element.textContent = currentValue;
            requestAnimationFrame(updateCounter);
        } else {
            element.textContent = targetValue;
        }
    }
    
    requestAnimationFrame(updateCounter);
}

function updateNotificationsBadge(overdueCount = null) {
    // If overdueCount is not provided, calculate it
    if (overdueCount === null) {
        fetchTasks().then(tasks => {
            const overdueTasks = tasks.filter(t => 
                t.due_date && 
                new Date(t.due_date) < new Date() && 
                t.status !== "terminada" &&
                (t.assignees.includes(me.id) || t.leader_id === me.id || t.created_by === me.id)
            );
            
            updateBadge(overdueTasks.length);
        });
    } else {
        updateBadge(overdueCount);
    }
    
    function updateBadge(count) {
        const badge = qs("#notifications-count");
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? "flex" : "none";
        }
    }
}

// Chart Functions
async function renderReports() {
    try {
        const { data: tasks } = await supabase.from("tasks")
            .select("id, status, created_at, due_date")
            .order("created_at");
        
        // Count tasks by status
        const statusCounts = {
            pendiente: 0,
            en_curso: 0,
            terminada: 0
        };
        
        (tasks || []).forEach(t => statusCounts[t.status]++);
        
        // Create chart 1 - Distribution donut chart
        const ctx1 = qs("#chart1");
        if (charts.c1) charts.c1.destroy();
        
        // Define colors based on theme
        const isDarkMode = document.body.classList.contains('dark-mode');
        const chartColors = {
            pending: isDarkMode ? ['rgba(245, 158, 11, 0.7)', 'rgba(245, 158, 11, 1)'] : ['rgba(230, 147, 15, 0.7)', 'rgba(230, 147, 15, 1)'],
            progress: isDarkMode ? ['rgba(59, 130, 246, 0.7)', 'rgba(59, 130, 246, 1)'] : ['rgba(0, 86, 164, 0.7)', 'rgba(0, 86, 164, 1)'],
            completed: isDarkMode ? ['rgba(16, 185, 129, 0.7)', 'rgba(16, 185, 129, 1)'] : ['rgba(12, 158, 112, 0.7)', 'rgba(12, 158, 112, 1)']
        };
        
        charts.c1 = new Chart(ctx1, {
            type: "doughnut",
            data: {
                labels: ["Pendiente", "En curso", "Terminada"],
                datasets: [{
                    data: [statusCounts.pendiente, statusCounts.en_curso, statusCounts.terminada],
                    backgroundColor: [
                        chartColors.pending[0],
                        chartColors.progress[0],
                        chartColors.completed[0]
                    ],
                    borderColor: [
                        chartColors.pending[1],
                        chartColors.progress[1],
                        chartColors.completed[1]
                    ],
                    borderWidth: 1,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 16,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text')
                        }
                    },
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(21, 27, 45, 0.9)' : 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        bodyFont: {
                            size: 14
                        },
                        borderColor: isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1
                    }
                }
            }
        });
        
        // Group tasks by week
        const tasksByWeek = {};
        
        (tasks || []).forEach(t => {
            const date = new Date(t.created_at);
            const year = date.getFullYear();
            const weekNumber = getWeekNumber(date);
            const key = `${year}-W${String(weekNumber).padStart(2, "0")}`;
            
            tasksByWeek[key] = (tasksByWeek[key] || 0) + 1;
        });
        
        // Sort weeks chronologically
        const sortedWeeks = Object.keys(tasksByWeek).sort();
        const weeklyValues = sortedWeeks.map(week => tasksByWeek[week]);
        
        // Create chart 2 - Weekly evolution line chart
        const ctx2 = qs("#chart2");
        if (charts.c2) charts.c2.destroy();
        
        const primaryColor = isDarkMode ? 'rgba(59, 130, 246, 1)' : 'rgba(0, 86, 164, 1)';
        const primaryColorLight = isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(0, 86, 164, 0.1)';
        
        charts.c2 = new Chart(ctx2, {
            type: "line",
            data: {
                labels: sortedWeeks,
                datasets: [{
                    label: "Tareas creadas",
                    data: weeklyValues,
                    borderColor: primaryColor,
                    backgroundColor: primaryColorLight,
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2,
                    pointBackgroundColor: primaryColor,
                    pointBorderColor: isDarkMode ? '#1b2238' : '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border')
                        },
                        ticks: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-light')
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border')
                        },
                        ticks: {
                            precision: 0,
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-light')
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(21, 27, 45, 0.9)' : 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        bodyFont: {
                            size: 14
                        },
                        borderColor: isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1
                    }
                }
            }
        });
        
        // Render performance table
        await renderPerformance();
        
    } catch (err) {
        console.error("Error rendering reports:", err);
        toast("Error al generar informes", "bad");
    }
}

function getWeekNumber(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
    const week1 = new Date(d.getFullYear(), 0, 4);
    return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
}

async function renderPerformance() {
    try {
        const days = parseInt(qs("#perf-window").value, 10);
        const from = new Date();
        from.setDate(from.getDate() - days);
        
        // Get all tasks
        const { data: tasks } = await supabase.from("tasks")
            .select("id, status, due_date, created_at, leader_id, created_by");
        
        // Get task assignees
        const { data: assignees } = await supabase.from("task_assignees")
            .select("task_id, user_id");
        
        // Create map of user_id -> task_ids
        const userTasksMap = {};
        if (assignees) {
            assignees.forEach(a => {
                if (!userTasksMap[a.user_id]) {
                    userTasksMap[a.user_id] = [];
                }
                userTasksMap[a.user_id].push(a.task_id);
            });
        }
        
        // Calculate metrics for each user
        const metrics = users.map(user => {
            // Get tasks assigned to this user (as assignee, leader, or creator)
            const userTasks = (tasks || []).filter(t => {
                const isAssignee = userTasksMap[user.id]?.includes(t.id);
                const isLeader = t.leader_id === user.id;
                const isCreator = t.created_by === user.id;
                const isInTimeframe = new Date(t.created_at) >= from;
                
                return (isAssignee || isLeader || isCreator) && isInTimeframe;
            });
            
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === "terminada").length;
            const overdue = userTasks.filter(t => 
                t.due_date && 
                new Date(t.due_date) < new Date() && 
                t.status !== "terminada"
            ).length;
            
            const completionRate = total ? Math.round((completed / total) * 100) : 0;
            
            return {
                user,
                total,
                completed,
                overdue,
                completionRate
            };
        });
        
        // Sort metrics by completion rate (highest first)
        metrics.sort((a, b) => b.completionRate - a.completionRate);
        
        // Render performance table
        const tableContainer = qs("#perf-table");
        tableContainer.innerHTML = "";
        
        if (metrics.length === 0) {
            tableContainer.innerHTML = `
                <div class="task-item">
                    <div class="task-item-content">
                        <div class="task-item-title">No hay datos de rendimiento disponibles</div>
                    </div>
                </div>
            `;
            return;
        }
        
        metrics.forEach(m => {
            let rateClass = "";
            if (m.completionRate >= 80) rateClass = "badge-completed";
            else if (m.completionRate >= 50) rateClass = "badge-progress";
            else if (m.completionRate > 0) rateClass = "badge-pending";
            
            const el = document.createElement("div");
            el.className = "task-item";
            el.innerHTML = `
                <div class="task-item-content">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="user-avatar" style="width: 36px; height: 36px;">
                            ${initials(m.user.full_name)}
                        </div>
                        <div>
                            <div class="task-item-title">${m.user.full_name}</div>
                            <div class="task-item-meta">
                                <span class="task-item-badge">
                                    <i class="fas fa-tasks"></i>
                                    <span>Total: ${m.total}</span>
                                </span>
                                <span class="task-item-badge badge-completed">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Completadas: ${m.completed}</span>
                                </span>
                                <span class="task-item-badge ${m.overdue > 0 ? 'badge-overdue' : ''}">
                                    <i class="fas fa-${m.overdue > 0 ? 'exclamation-triangle' : 'clock'}"></i>
                                    <span>Atrasadas: ${m.overdue}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 50px; height: 50px; position: relative;">
                        <svg width="50" height="50" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="var(--border)" stroke-width="10" />
                            <circle cx="60" cy="60" r="54" fill="none" 
                                stroke="${m.completionRate >= 80 ? 'var(--success)' : m.completionRate >= 50 ? 'var(--primary)' : m.completionRate > 0 ? 'var(--warning)' : 'var(--text-light)'}" 
                                stroke-width="10" 
                                stroke-dasharray="${Math.min(m.completionRate, 100) * 3.39292} 339.292" 
                                transform="rotate(-90 60 60)" />
                            <text x="60" y="65" font-size="22" text-anchor="middle" fill="var(--text)">${m.completionRate}%</text>
                        </svg>
                    </div>
                    <span class="task-item-badge ${rateClass}">
                        <i class="fas fa-chart-line"></i>
                        <span>Efectividad: ${m.completionRate}%</span>
                    </span>
                </div>
            `;
            
            tableContainer.appendChild(el);
        });
        
    } catch (err) {
        console.error("Error rendering performance:", err);
        toast("Error al generar m√©tricas de rendimiento", "bad");
    }
}

// Calendar Functions
async function renderCalendar() {
    try {
        const scope = qs("#cal-scope").value;
        
        // Get tasks
        const tasks = await fetchTasks("");
        
        // Filter tasks by scope
        const filteredTasks = tasks.filter(t => 
            scope === "mias" ? 
                t.assignees.includes(me.id) || t.leader_id === me.id || t.created_by === me.id 
                : visibleToMe(t)
        );
        
        // Get meetings
        const { data: meetings } = await supabase.from("meetings")
            .select("id, title, start_at, end_at")
            .gte("end_at", "1970-01-01T00:00:00Z");
        
        // Prepare events array
        const events = [];
        
        // Add task events
        filteredTasks.forEach(task => {
            const eventDate = task.due_date ? task.due_date : task.created_at;
            const isOverdue = task.due_date && new Date(task.due_date) < new Date() && task.status !== "terminada";
            
            let statusColor = '#0056a4'; // Default primary color for in-progress
            
            if (task.status === 'terminada') {
                statusColor = '#0c9e70'; // Success color for completed
            } else if (isOverdue) {
                statusColor = '#dc3545'; // Danger color for overdue
            } else if (task.status === 'pendiente') {
                statusColor = '#e6930f'; // Warning color for pending
            }
            
            // Use different colors in dark mode
            if (document.body.classList.contains('dark-mode')) {
                if (task.status === 'terminada') {
                    statusColor = '#10b981'; // Brighter green for dark mode
                } else if (isOverdue) {
                    statusColor = '#ef4444'; // Brighter red for dark mode
                } else if (task.status === 'pendiente') {
                    statusColor = '#f59e0b'; // Brighter orange for dark mode
                } else {
                    statusColor = '#3b82f6'; // Brighter blue for dark mode
                }
            }
            
            events.push({
                id: task.id,
                title: (task.type === "levantamiento" ? "Lev: " : "T: ") + task.title,
                start: eventDate,
                allDay: false,
                color: statusColor,
                borderColor: statusColor,
                textColor: '#ffffff',
                extendedProps: {
                    isTask: true,
                    type: task.type,
                    status: task.status,
                    isOverdue: isOverdue
                }
            });
        });
        
        // Add meeting events
        (meetings || []).forEach(meeting => {
            // Use different color in dark mode
            const meetingColor = document.body.classList.contains('dark-mode') ? 
                                  'rgba(59, 130, 246, 0.7)' : // Brighter blue with transparency for dark mode
                                  '#151b2d'; // Dark blue/slate for light mode
            
            events.push({
                id: meeting.id,
                title: "Reuni√≥n: " + meeting.title,
                start: meeting.start_at,
                end: meeting.end_at,
                color: meetingColor,
                borderColor: meetingColor,
                textColor: '#ffffff',
                extendedProps: {
                    isMeeting: true
                }
            });
        });
        
        // Initialize or update calendar
        const calendarEl = qs("#calendar");
        
        if (calendar) {
            // Update existing calendar
            calendar.removeAllEvents();
            calendar.addEventSource(events);
            calendar.refetchEvents();
            return;
        }
        
        // Create new calendar
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "dayGridMonth,timeGridWeek,listWeek"
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                list: 'Lista'
            },
            height: 'auto',
            locale: "es",
            timeZone: "local",
            events: events,
            timeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            eventClick: info => {
                if (info.event.extendedProps.isTask) {
                    openTask(info.event.id);
                } else if (info.event.extendedProps.isMeeting) {
                    openEditMeeting(info.event.id);
                }
            },
            eventDidMount: function(info) {
                // Add tooltip
                let tooltipContent = '';
                
                if (info.event.extendedProps.isTask) {
                    const statusText = info.event.extendedProps.status.replace('_', ' ');
                    tooltipContent = `
                        <div style="font-weight: bold;">${info.event.title}</div>
                        <div>${info.event.extendedProps.type}</div>
                        <div>Estado: ${statusText}</div>
                        <div>${formatDate(info.event.start)}</div>
                    `;
                } else {
                    tooltipContent = `
                        <div style="font-weight: bold;">${info.event.title}</div>
                        <div>Inicio: ${formatDate(info.event.start)}</div>
                        <div>Fin: ${formatDate(info.event.end)}</div>
                    `;
                }
                
                // Set title attribute for simple tooltip
                info.el.title = info.event.title;
                
                // Add hover effect
                info.el.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = 'var(--shadow-md)';
                });
                
                info.el.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                    this.style.boxShadow = '';
                });
            }
        });
        
        calendar.render();
        
    } catch (err) {
        console.error("Error rendering calendar:", err);
        toast("Error al cargar calendario", "bad");
    }
}

// Mention System
function mentionSuggest(e) {
    const inputField = qs("#c-text");
    const mentionBox = qs("#mention-box");
    const text = inputField.value;
    const cursorPos = inputField.selectionStart;
    
    // Find the last @ symbol before cursor
    const textBeforeCursor = text.substring(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf("@");
    
    if (lastAtIndex === -1) {
        mentionBox.classList.remove("active");
        return;
    }
    
    // Get the partial name after @
    const partialName = textBeforeCursor.substring(lastAtIndex + 1).toLowerCase();
    
    // Filter users that match the partial name
    const matches = users.filter(u => 
        u.full_name.toLowerCase().includes(partialName)
    ).slice(0, 5);
    
    if (matches.length === 0) {
        mentionBox.classList.remove("active");
        return;
    }
    
    // Position the mention box
    const inputRect = inputField.getBoundingClientRect();
    mentionBox.style.top = (inputRect.bottom + 8) + "px";
    mentionBox.style.left = inputRect.left + "px";
    mentionBox.style.width = inputRect.width + "px";
    
    // Populate mention box
    mentionBox.innerHTML = "";
    matches.forEach(user => {
        const item = document.createElement("div");
        item.className = "mention-item";
        item.dataset.username = user.full_name;
        item.dataset.atIndex = lastAtIndex;
        
        item.innerHTML = `
            <div class="mention-avatar">${initials(user.full_name)}</div>
            <div class="mention-name">${user.full_name}</div>
        `;
        
        item.addEventListener("click", handleMentionClick);
        mentionBox.appendChild(item);
    });
    
    mentionBox.classList.add("active");
}

function handleMentionClick(e) {
    const item = e.currentTarget;
    const username = item.dataset.username;
    const atIndex = parseInt(item.dataset.atIndex);
    
    const inputField = qs("#c-text");
    const text = inputField.value;
    
    // Replace the @partial_name with the full @username
    const newText = text.substring(0, atIndex) + "@" + username + " " + text.substring(inputField.selectionStart);
    inputField.value = newText;
    
    // Set cursor position after the inserted mention
    const newCursorPos = atIndex + username.length + 2; // +2 for @ and space
    inputField.focus();
    inputField.setSelectionRange(newCursorPos, newCursorPos);
    
    // Hide mention box
    qs("#mention-box").classList.remove("active");
}

// Overdue scan function
function overdueScan() {
    fetchTasks().then(tasks => {
        const overdueTasks = tasks.filter(t => 
            t.due_date && 
            new Date(t.due_date) < new Date() && 
            t.status !== "terminada" &&
            (t.assignees.includes(me.id) || t.leader_id === me.id || t.created_by === me.id)
        );
        
        if (overdueTasks.length > 0) {
            setTimeout(() => {
                toast(`Tiene ${overdueTasks.length} tarea${overdueTasks.length > 1 ? 's' : ''} atrasada${overdueTasks.length > 1 ? 's' : ''}`, "warn", me.full_name);
                
                // Show up to 3 overdue tasks
                overdueTasks.slice(0, 3).forEach((t, i) => {
                    setTimeout(() => {
                        toast(`Tarea atrasada: ${t.title}`, "warn", nameOf(t.leader_id || t.created_by));
                    }, 1000 * (i + 1));
                });
            }, 2000);
        }
    });
}

// Realtime functionality
function initRealtime() {
    supabase.channel("rt")
        .on("postgres_changes", {event: "INSERT", schema: "public", table: "tasks"}, payload => {
            toast("Nueva tarea: " + payload.new.title, "ok", nameOf(payload.new.created_by));
            sound();
            refreshAll();
        })
        .on("postgres_changes", {event: "UPDATE", schema: "public", table: "tasks"}, payload => {
            toast("Tarea actualizada: " + payload.new.title, "warn");
            refreshAll();
        })
        .on("postgres_changes", {event: "INSERT", schema: "public", table: "task_comments"}, payload => {
            const commentUser = nameOf(payload.new.user_id);
            
            // Handle system comments
            if (payload.new.content?.startsWith("::status::")) {
                const status = payload.new.content.replace("::status::", "");
                toast(`${commentUser} avanz√≥ la tarea a ${status}`, "ok", commentUser);
                sound();
                return;
            }
            
            if (payload.new.content?.startsWith("::approval::")) {
                const approval = payload.new.content.replace("::approval::", "");
                toast(`${commentUser} cambi√≥ aprobaci√≥n a ${approval}`, "ok", commentUser);
                sound();
                return;
            }
            
            // Handle mentions
            if ((payload.new.content || "").includes("@" + me.full_name.split(" ")[0])) {
                toast(`${commentUser} te mencion√≥ en un comentario`, "ok", commentUser);
                sound();
            }
            
            // Refresh comments if the task is currently open
            if (currentTask === payload.new.task_id) {
                renderComments(currentTask);
            }
        })
        .on("postgres_changes", {event: "INSERT", schema: "public", table: "meetings"}, payload => {
            toast("Nueva reuni√≥n: " + payload.new.title, "ok", nameOf(payload.new.created_by));
            sound();
            renderMeetings();
            loadKPIs();
            renderCalendar();
        })
        .subscribe();
}

// Modal functions
function openModal(modalId) {
    const modal = qs(`#${modalId}`);
    modal.classList.add("active");
    
    // Add animation to modal container
    const container = modal.querySelector(".modal-container");
    if (container) {
        container.style.animation = "modalSlideIn 0.3s ease-out";
    }
}

function closeModal(modalId) {
    const modal = qs(`#${modalId}`);
    
    // Add closing animation
    const container = modal.querySelector(".modal-container");
    if (container) {
        container.style.animation = "modalSlideIn 0.2s ease-in reverse";
        
        // Remove active class after animation completes
        setTimeout(() => {
            modal.classList.remove("active");
        }, 200);
    } else {
        modal.classList.remove("active");
    }
}

// Helper function to refresh all UI elements
function refreshAll() {
    renderTaskList("#list-dashboard");
    renderTaskList("#list-tasks");
    renderLevantamientos();
    renderMeetings();
    loadKPIs();
    renderCalendar();
    renderReports();
}

function refreshAllIfOpen() {
    renderTaskList("#list-dashboard");
    renderTaskList("#list-tasks");
    renderLevantamientos();
    loadKPIs();
    renderCalendar();
}

// Dark mode toggle
function toggleDarkMode() {
    const isDarkMode = document.body.classList.toggle("dark-mode");
    
    // Update theme toggle icon
    const themeToggle = qs("#theme-toggle i");
    if (themeToggle) {
        themeToggle.className = isDarkMode ? "fas fa-sun" : "fas fa-moon";
    }
    
    // Store preference
    localStorage.setItem("darkMode", isDarkMode ? "true" : "false");
    
    // Update charts if they exist
    if (charts.c1 || charts.c2) {
        renderReports();
    }
    
    // Reload calendar with updated colors
    if (calendar) {
        renderCalendar();
    }
}

// Event listeners
document.addEventListener("DOMContentLoaded", () => {
    // Login form submission
    qs("#login-form").addEventListener("submit", e => {
        e.preventDefault();
        
        const loginButton = qs("#btn-login");
        loginButton.disabled = true;
        loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Procesando...</span>';
        
        login().finally(() => {
            loginButton.disabled = false;
            loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> <span>Ingresar al Sistema</span>';
        });
    });
    
    // View switching
    qsa('[data-view]').forEach(item => {
        item.addEventListener('click', () => {
            const viewId = item.dataset.view;
            if (viewId === "usuarios" && !(me && me.role === "supervisor_admin")) {
                toast("No tiene permisos para acceder a esta secci√≥n", "warn");
                return;
            }
            switchView(viewId);
        });
    });
    
    // Sidebar toggle
    qs('#sidebar-toggle').addEventListener('click', () => {
        qs('#sidebar').classList.toggle('expanded');
    });
    
    // Theme toggle
    qs('#theme-toggle').addEventListener('click', toggleDarkMode);
    
    // New task buttons
    qs('#btn-new-task').addEventListener('click', () => openModal('modal-new-task'));
    qs('#btn-new-task-2').addEventListener('click', () => openModal('modal-new-task'));
    
    // New meeting buttons
    qs('#btn-new-meeting').addEventListener('click', () => openModal('modal-new-meeting'));
    qs('#btn-new-meeting-2').addEventListener('click', () => openModal('modal-new-meeting'));
    
    // New levantamiento button
    qs('#btn-new-lev').addEventListener('click', () => {
        qs('#nt-type').value = 'levantamiento';
        openModal('modal-new-task');
    });
    
    // Save task button
    qs('#btn-save-nt').addEventListener('click', createTask);
    
    // Save meeting button
    qs('#btn-save-nm').addEventListener('click', createMeeting);
    
    // Edit meeting buttons
    qs('#btn-save-em').addEventListener('click', saveEditMeeting);
    qs('#btn-pospone-em').addEventListener('click', posponeEditMeeting);
    
    // Add user button
    qs('#btn-add-user').addEventListener('click', addUser);
    
    // Comment input for mentions
    qs('#c-text').addEventListener('input', mentionSuggest);
    qs('#c-text').addEventListener('keydown', e => {
        // Submit on Enter (unless Shift is pressed)
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendComment();
        }
    });
    
    // Send comment button
    qs('#btn-send-comment').addEventListener('click', sendComment);
    
    // File input change event
    qs('#c-file').addEventListener('change', e => {
        const fileName = e.target.files[0]?.name;
        qs('#file-name').textContent = fileName ? `Archivo seleccionado: ${fileName}` : '';
    });
    
    // Modal close buttons
    qsa('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => {
            closeModal(btn.getAttribute('data-close'));
        });
    });
    
    qs('#md-close').addEventListener('click', () => closeModal('task-modal'));
    
    // Outside modal click to close
    qsa('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });
    
    // Escape key to close modals
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            qsa('.modal-overlay.active').forEach(modal => {
                closeModal(modal.id);
            });
        }
    });
    
    // Logout button
    qs('#btn-logout').addEventListener('click', leave);
    
    // Dropdown hide/show mentions
    document.addEventListener('click', e => {
        if (!e.target.closest('#mention-box') && !e.target.closest('#c-text')) {
            qs('#mention-box').classList.remove('active');
        }
    });
    
    // Filter change events
    qs('#flt-status').addEventListener('change', () => renderTaskList('#list-dashboard'));
    qs('#flt-mias').addEventListener('change', () => renderTaskList('#list-dashboard'));
    qs('#flt-tasks').addEventListener('change', () => renderTaskList('#list-tasks'));
    qs('#flt-vis').addEventListener('change', () => renderTaskList('#list-tasks'));
    qs('#cal-scope').addEventListener('change', renderCalendar);
    qs('#perf-window').addEventListener('change', renderPerformance);
    
    // User dropdown toggle
    qs('#user-dropdown-toggle').addEventListener('click', () => {
        toast('Funci√≥n de perfil en desarrollo', 'info');
    });
    
    // Notifications button
    qs('#btn-notifications').addEventListener('click', () => {
        fetchTasks().then(tasks => {
            const overdueTasks = tasks.filter(t => 
                t.due_date && 
                new Date(t.due_date) < new Date() && 
                t.status !== "terminada" &&
                (t.assignees.includes(me.id) || t.leader_id === me.id || t.created_by === me.id)
            );
            
            if (overdueTasks.length === 0) {
                toast('No tiene notificaciones pendientes', 'info');
            } else {
                toast(`Tiene ${overdueTasks.length} tarea${overdueTasks.length > 1 ? 's' : ''} atrasada${overdueTasks.length > 1 ? 's' : ''}`, 'warn');
                
                // Show first overdue task
                if (overdueTasks.length > 0) {
                    setTimeout(() => {
                        toast(`Tarea atrasada: ${overdueTasks[0].title}`, 'warn', nameOf(overdueTasks[0].leader_id || overdueTasks[0].created_by));
                    }, 1000);
                }
            }
        });
    });
    
    // Check saved dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        qs('#theme-toggle i').className = 'fas fa-sun';
    }
    
    // Try to load saved session
    const savedSession = localStorage.getItem("sessionUser");
    if (savedSession) {
        try {
            me = JSON.parse(savedSession);
            enterApp();
        } catch (err) {
            console.error("Error loading saved session:", err);
            localStorage.removeItem("sessionUser");
        }
    }
});

// Export functions for external access
window.openTask = openTask;
window.openEditMeeting = openEditMeeting;

</script>

</body>
</html>
